<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified PD - Field Training</title>
    <!-- Favicon updated to LSPD.png -->
    <link rel="icon" href='LSPD.png' type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* bg-gray-900 */
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a202c;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #718096;
            }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 9999px;
            background-color: #2d3748;
            color: white;
            border: 1px solid #4a5568;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

            .toast.show {
                opacity: 1;
            }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121827; /* A darker shade of the body background */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 50;
        }

        .login-prompt {
            text-align: center;
            padding: 2rem;
            background-color: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .record-card {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

            .record-card:hover {
                transform: translateY(-2px);
            }
    </style>
</head>
<body class="text-gray-300">

    <!-- Login Overlay -->
    <div id="login-overlay" class="hidden login-overlay">
        <div class="login-prompt">
            <h1 class="text-3xl font-bold text-white mb-2">Access Denied</h1>
            <p class="text-gray-400 mb-6">You must be logged in to access this page.</p>
            <button id="login-btn" class="px-6 py-3 text-lg font-semibold rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200">Proceed to Login</button>
        </div>
    </div>

    <!-- Header -->
    <header id="main-header" class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40 px-4 py-2 hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <img src="LSPD.png" alt="LSPD Logo" class="w-10 h-10">
                <span class="text-xl font-bold text-white hidden sm:block">Unified PD Training</span>
            </div>
            <div class="flex-1 px-4 lg:px-16 flex justify-end">
                <div id="user-info" class="text-sm text-gray-400">Loading user info...</div>
            </div>
            <div id="auth-buttons" class="hidden space-x-2">
                <button id="addAnnouncementBtn" class="hidden px-4 py-2 text-sm font-semibold rounded-full border border-green-500 text-green-500 hover:bg-green-500 hover:text-white transition-colors duration-200">Create Announcement</button>
                <button id="addRecordBtn" class="px-4 py-2 text-sm font-semibold rounded-full border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors duration-200">Add New Record</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto mt-4 px-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Training Records Column -->
            <div id="records-container" class="lg:col-span-2 space-y-4">
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 text-center">
                    <p id="loading-message" class="text-gray-400 text-lg">Loading training records...</p>
                    <p id="no-access-message" class="text-red-400 text-lg hidden">You do not have the required access level to view this page. Please contact a Website Account Manager.</p>
                </div>
            </div>

            <!-- Sidebar Column -->
            <aside class="lg:col-span-1 space-y-4">
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <h3 class="font-bold text-lg text-white mb-3">Training Status</h3>
                    <div id="training-status" class="space-y-2">
                        <p class="text-sm text-gray-400">Select a record to see its details.</p>
                    </div>
                </div>

                <!-- New Announcements Section -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-white">Announcements</h3>
                        <button id="toggleArchiveBtn" class="hidden px-2 py-1 text-xs font-semibold rounded-full border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors duration-200">View Archived</button>
                    </div>
                    <div id="announcements-container" class="space-y-4">
                        <p class="text-sm text-gray-400">No announcements yet.</p>
                    </div>
                    <div id="archived-container" class="hidden mt-4 space-y-4 border-t border-gray-700 pt-4">
                        <h4 class="font-bold text-md text-white">Archived Announcements</h4>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Modal for adding/editing records -->
    <div id="recordModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 id="recordModalTitle" class="text-lg font-bold text-white">Add New Training Record</h3>
                <button id="closeRecordModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>

            <form id="trainingForm" class="space-y-4">
                <input type="hidden" id="recordIdInput">
                <div>
                    <label for="traineeInput" class="block text-sm font-medium text-gray-300 mb-1">Officer being trained</label>
                    <input type="text" id="traineeInput" required placeholder="Name" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="trainerInput" class="block text-sm font-medium text-gray-300 mb-1">Trainer(s) (comma-separated)</label>
                    <input type="text" id="trainerInput" required placeholder="Name, Name 2" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-300 mb-2">5-Day Training Checklist</h4>
                    <div id="checklist-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 bg-gray-900/50 p-3 rounded-md max-h-60 overflow-y-auto">
                        <!-- Checklist items will be generated here -->
                    </div>
                </div>
                <div>
                    <label for="notesInput" class="block text-sm font-medium text-gray-300 mb-1">Officer Notes</label>
                    <textarea id="notesInput" rows="4" placeholder="Add custom notes on performance, incidents, etc." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <label for="recommendationInput" class="block text-sm font-medium text-gray-300 mb-1">Final Recommendation</label>
                    <select id="recommendationInput" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="None">Select...</option>
                        <option value="Continuation">Continuation</option>
                        <option value="Retraining">Retraining</option>
                        <option value="Promotion">Promotion</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelRecordBtn" class="px-4 py-2 text-sm font-semibold rounded-full border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors duration-200">Cancel</button>
                    <button type="submit" id="saveRecordBtn" class="px-4 py-2 text-sm font-semibold rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200">Save Record</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for adding announcements -->
    <div id="announcementModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 id="announcementModalTitle" class="text-lg font-bold text-white">Create New Announcement</h3>
                <button id="closeAnnouncementModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>

            <form id="announcementForm" class="space-y-4">
                <input type="hidden" id="announcementIdInput">
                <div>
                    <label for="announcementTitleInput" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                    <input type="text" id="announcementTitleInput" required placeholder="Announcement Title" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label for="announcementContentInput" class="block text-sm font-medium text-gray-300 mb-1">Content (Supports Markdown)</label>
                    <textarea id="announcementContentInput" required rows="6" placeholder="Write your announcement here..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <label for="announcementMediaInput" class="block text-sm font-medium text-gray-300 mb-1">Image or Video URL</label>
                    <input type="url" id="announcementMediaInput" placeholder="https://example.com/media.jpg or https://youtube.com/watch?v=..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelAnnouncementBtn" class="px-4 py-2 text-sm font-semibold rounded-full border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors duration-200">Cancel</button>
                    <button type="submit" id="saveAnnouncementBtn" class="px-4 py-2 text-sm font-semibold rounded-full bg-green-500 text-white hover:bg-green-600 transition-colors duration-200">Post Announcement</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration & Initialization ---
        // Provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyDU7DRAxCzqu81DTa7k0DXaBRcMpk0sElc",
            authDomain: "upd-system.firebaseapp.com",
            projectId: "upd-system",
            storageBucket: "upd-system.firebasestorage.app",
            messagingSenderId: "28223003678",
            appId: "1:28223003678:web:a19a9a8eb33fe74202220f",
            measurementId: "G-83NX0KXZ1Y"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // These variables are provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const mainHeader = document.getElementById('main-header');
        const mainContent = document.getElementById('main-content');
        const addRecordBtn = document.getElementById('addRecordBtn');
        const addAnnouncementBtn = document.getElementById('addAnnouncementBtn');
        const recordsContainer = document.getElementById('records-container');
        const recordModal = document.getElementById('recordModal');
        const closeRecordModalBtn = document.getElementById('closeRecordModalBtn');
        const cancelRecordBtn = document.getElementById('cancelRecordBtn');
        const trainingForm = document.getElementById('trainingForm');
        const recordIdInput = document.getElementById('recordIdInput');
        const recordModalTitle = document.getElementById('recordModalTitle');
        const traineeInput = document.getElementById('traineeInput');
        const trainerInput = document.getElementById('trainerInput');
        const checklistContainer = document.getElementById('checklist-container');
        const notesInput = document.getElementById('notesInput');
        const recommendationInput = document.getElementById('recommendationInput');
        const loadingMessage = document.getElementById('loading-message');
        const noAccessMessage = document.getElementById('no-access-message');
        const userInfoElement = document.getElementById('user-info');
        const authButtons = document.getElementById('auth-buttons');
        const announcementModal = document.getElementById('announcementModal');
        const announcementModalTitle = document.getElementById('announcementModalTitle');
        const closeAnnouncementModalBtn = document.getElementById('closeAnnouncementModalBtn');
        const cancelAnnouncementBtn = document.getElementById('cancelAnnouncementBtn');
        const announcementForm = document.getElementById('announcementForm');
        const announcementIdInput = document.getElementById('announcementIdInput');
        const announcementTitleInput = document.getElementById('announcementTitleInput');
        const announcementContentInput = document.getElementById('announcementContentInput');
        const announcementMediaInput = document.getElementById('announcementMediaInput');
        const announcementsContainer = document.getElementById('announcements-container');
        const archivedContainer = document.getElementById('archived-container');
        const toggleArchiveBtn = document.getElementById('toggleArchiveBtn');

        // --- State and Constants ---
        const allowedAccessLevels = ["Field Training Officer", "Command", "High Command", "Commisioner", "Website Account Manager"];
        let userProfile = null;
        let userId = null;
        let showArchived = false;

        // A mock checklist for a FiveM cadet's first 5 days of training
        const trainingChecklist = [
            "Basic Radio Procedure & Ten-Codes",
            "Proper Traffic Stop Procedure (pulling over, approaching, and conclusion)",
            "Vehicle Pursuit and Termination Procedures",
            "Basic Report Writing and Documentation",
            "Foot Pursuit & Suspect Apprehension",
            "Use of Force Policy Review",
            "Primary and Secondary Unit Roles",
            "Responding to Priority Calls (10-80s, 10-66s)",
            "Patrol Vehicle Familiarization & Care",
            "Weapon and Equipment Safety Check"
        ];

        // Allowed access levels for announcements management
        const announcementManagementRoles = ["High Command", "Website Account Manager"];

        // --- Toast Notification ---
        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast';
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        // --- UI Functions ---
        const openRecordModal = async (recordData = null) => {
            // Reset form for a new record
            trainingForm.reset();
            recordIdInput.value = '';
            recordModalTitle.textContent = 'Add New Training Record';

            // If data is provided, it's an edit action
            if (recordData) {
                recordIdInput.value = recordData.id;
                recordModalTitle.textContent = 'Edit Training Record';
                traineeInput.value = recordData.traineeName;
                trainerInput.value = recordData.trainerNames.join(', ');
                notesInput.value = recordData.notes || '';
                recommendationInput.value = recordData.recommendation || 'None';
            }

            renderChecklistForForm(recordData);
            recordModal.classList.remove('hidden');
        };

        const closeRecordModal = () => {
            trainingForm.reset();
            recordModal.classList.add('hidden');
        };

        const openAnnouncementModal = (announcementData = null) => {
            announcementForm.reset();
            announcementIdInput.value = '';
            announcementModalTitle.textContent = 'Create New Announcement';

            if (announcementData) {
                announcementIdInput.value = announcementData.id;
                announcementModalTitle.textContent = 'Edit Announcement';
                announcementTitleInput.value = announcementData.title;
                announcementContentInput.value = announcementData.content;
                announcementMediaInput.value = announcementData.mediaUrl || '';
            }

            announcementModal.classList.remove('hidden');
        };

        const closeAnnouncementModal = () => {
            announcementForm.reset();
            announcementModal.classList.add('hidden');
        };

        const renderChecklistForForm = (recordData = null) => {
            checklistContainer.innerHTML = '';
            trainingChecklist.forEach((item, index) => {
                const isCompleted = recordData?.checklist.find(c => c.item === item)?.completed || false;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center space-x-2';
                itemDiv.innerHTML = `
                        <input type="checkbox" id="checklist-${index}" name="checklist-item" value="${item}" ${isCompleted ? 'checked' : ''} class="rounded text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <label for="checklist-${index}" class="text-sm text-gray-300 cursor-pointer">${item}</label>
                    `;
                checklistContainer.appendChild(itemDiv);
            });
        };

        const applyMarkdown = (text) => {
            // Replaces newlines with <br> for simple line breaks
            let html = text.replace(/\n/g, '<br/>');
            // Bold (**text**)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italic (*text*)
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Underline (_text_)
            html = html.replace(/_(.*?)_/g, '<u>$1</u>');
            // Strikethrough (~~text~~)
            html = html.replace(/~~(.*?)~~/g, '<del>$1</del>');
            return html;
        };

        const renderTrainingRecords = (records) => {
            recordsContainer.innerHTML = '';
            if (records.length === 0) {
                recordsContainer.innerHTML = `<div class="bg-gray-800 rounded-lg border border-gray-700 p-4 text-center"><p class="text-gray-400">No training records found.</p></div>`;
                return;
            }

            records.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'bg-gray-800 rounded-lg border border-gray-700 overflow-hidden record-card';
                recordElement.dataset.recordId = record.id;
                recordElement.innerHTML = `
                        <div class="p-4">
                            <div class="text-xs text-gray-400 mb-2">
                                <span class="font-bold text-white">${record.traineeName}</span> •
                                <span>Trainer(s): ${record.trainerNames.join(', ')}</span> •
                                <span>Created: ${record.timestamp?.toDate()?.toLocaleString() || 'N/A'}</span>
                            </div>
                            <h2 class="text-xl font-bold text-white mb-2">Training Record</h2>
                            <ul id="checklist-${record.id}" class="space-y-1 mt-4">
                                ${record.checklist.map(item => `
                                    <li class="flex items-center space-x-2">
                                        <input type="checkbox" data-record-id="${record.id}" data-item-name="${item.item}" ${item.completed ? 'checked' : ''} class="rounded text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500 cursor-pointer">
                                        <label class="text-sm text-gray-300 ${item.completed ? 'line-through text-gray-500' : ''}">${item.item}</label>
                                    </li>
                                `).join('')}
                            </ul>
                            ${record.notes ? `<div class="mt-4"><p class="font-semibold text-white">Notes:</p><p class="text-sm text-gray-400 whitespace-pre-wrap">${applyMarkdown(record.notes)}</p></div>` : ''}
                            ${record.recommendation && record.recommendation !== 'None' ? `<div class="mt-2"><p class="font-semibold text-white">Recommendation:</p><p class="text-sm text-blue-400">${record.recommendation}</p></div>` : ''}
                        </div>
                    `;
                recordsContainer.appendChild(recordElement);
            });
        };

        const renderAnnouncements = (allAnnouncements) => {
            announcementsContainer.innerHTML = '';
            archivedContainer.innerHTML = `<h4 class="font-bold text-md text-white">Archived Announcements</h4>`;

            const activeAnnouncements = allAnnouncements.filter(a => !a.isArchived);
            const archivedAnnouncements = allAnnouncements.filter(a => a.isArchived);

            if (activeAnnouncements.length === 0) {
                announcementsContainer.innerHTML = `<p class="text-sm text-gray-400">No announcements yet.</p>`;
            } else {
                activeAnnouncements.forEach(announcement => {
                    announcementsContainer.appendChild(createAnnouncementCard(announcement));
                });
            }

            if (archivedAnnouncements.length > 0) {
                toggleArchiveBtn.classList.remove('hidden');
                archivedAnnouncements.forEach(announcement => {
                    archivedContainer.appendChild(createAnnouncementCard(announcement));
                });
            } else {
                archivedContainer.innerHTML += `<p class="text-sm text-gray-400 mt-2">No archived announcements.</p>`;
                toggleArchiveBtn.classList.add('hidden');
            }
        };

        const createAnnouncementCard = (announcement) => {
            const isVideo = announcement.mediaUrl && (announcement.mediaUrl.includes('youtube.com') || announcement.mediaUrl.includes('youtu.be'));
            const isImage = announcement.mediaUrl && /\.(jpeg|jpg|gif|png)$/.test(announcement.mediaUrl);
            let mediaHtml = '';

            if (isVideo) {
                const videoId = announcement.mediaUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/))([\w-]+)/)?.[1];
                if (videoId) {
                    mediaHtml = `<iframe class="w-full h-auto aspect-video rounded-md mt-2" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
            } else if (isImage) {
                mediaHtml = `<img src="${announcement.mediaUrl}" class="w-full h-auto rounded-md mt-2" alt="Announcement image">`;
            }

            const contentHtml = applyMarkdown(announcement.content);

            const announcementElement = document.createElement('div');
            announcementElement.className = 'bg-gray-700/50 rounded-lg p-3 border border-gray-600';
            announcementElement.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-md font-semibold text-white">${announcement.title}</h4>
                        <span class="text-xs text-gray-400">${announcement.timestamp?.toDate()?.toLocaleDateString() || 'N/A'}</span>
                    </div>
                    <div class="text-sm text-gray-300">${contentHtml}</div>
                    ${mediaHtml}
                    <div class="mt-2 text-xs text-gray-500">Posted by: ${announcement.createdByUsername || 'Unknown'}</div>
                    <div class="mt-4 flex space-x-2 justify-end">
                        <button class="edit-announcement-btn text-sm text-blue-400 hover:text-blue-200" data-announcement-id="${announcement.id}">Edit</button>
                        <button class="archive-announcement-btn text-sm text-yellow-400 hover:text-yellow-200" data-announcement-id="${announcement.id}">${announcement.isArchived ? 'Unarchive' : 'Archive'}</button>
                        <button class="delete-announcement-btn text-sm text-red-400 hover:text-red-200" data-announcement-id="${announcement.id}">Delete</button>
                    </div>
                `;
            return announcementElement;
        };

        const addMarkdown = (element, start, end) => {
            const startPos = element.selectionStart;
            const endPos = element.selectionEnd;
            const text = element.value;
            const selectedText = text.substring(startPos, endPos);
            const newText = text.substring(0, startPos) + start + selectedText + end + text.substring(endPos);
            element.value = newText;
            element.focus();
            element.selectionStart = startPos + start.length;
            element.selectionEnd = endPos + start.length;
        };

        // --- Firestore Functions ---
        const getChecklistStatus = () => {
            const checklistItems = trainingForm.querySelectorAll('input[type="checkbox"]');
            const checklistStatus = [];
            checklistItems.forEach(item => {
                checklistStatus.push({
                    item: item.value,
                    completed: item.checked
                });
            });
            return checklistStatus;
        };

        const addTrainingRecord = async (traineeName, trainerNames, notes, recommendation) => {
            const checklist = getChecklistStatus();
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/trainingRecords`), {
                    traineeName: traineeName,
                    trainerNames: trainerNames,
                    checklist: checklist,
                    notes: notes,
                    recommendation: recommendation,
                    createdBy: userId,
                    timestamp: serverTimestamp()
                });
                showToast(`Training record for ${traineeName} added!`);
                console.log("Document written with ID: ", docRef.id);
                closeRecordModal();
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast('Failed to add record.', true);
            }
        };

        const updateTrainingRecord = async (recordId, traineeName, trainerNames, notes, recommendation) => {
            const recordRef = doc(db, `artifacts/${appId}/public/data/trainingRecords`, recordId);
            const checklist = getChecklistStatus();
            try {
                await updateDoc(recordRef, {
                    traineeName: traineeName,
                    trainerNames: trainerNames,
                    checklist: checklist,
                    notes: notes,
                    recommendation: recommendation
                });
                showToast(`Training record for ${traineeName} updated!`);
                console.log("Document updated with ID: ", recordId);
                closeRecordModal();
            } catch (e) {
                console.error("Error updating document: ", e);
                showToast('Failed to update record.', true);
            }
        };

        const addAnnouncement = async (title, content, mediaUrl) => {
            try {
                if (!userProfile || !announcementManagementRoles.includes(userProfile['access level'])) {
                    throw new Error('User does not have permission to post announcements.');
                }
                const newDocRef = await addDoc(collection(db, `artifacts/${appId}/public/data/announcements`), {
                    title: title,
                    content: content,
                    mediaUrl: mediaUrl,
                    createdBy: userId,
                    createdByUsername: userProfile.name,
                    isArchived: false,
                    timestamp: serverTimestamp()
                });
                showToast('Announcement posted successfully!');
                closeAnnouncementModal();
            } catch (e) {
                console.error("Error adding announcement: ", e);
                showToast('Failed to post announcement.', true);
            }
        };

        const updateAnnouncement = async (announcementId, title, content, mediaUrl) => {
            try {
                if (!userProfile || !announcementManagementRoles.includes(userProfile['access level'])) {
                    throw new Error('User does not have permission to edit announcements.');
                }
                const announcementRef = doc(db, `artifacts/${appId}/public/data/announcements`, announcementId);
                await updateDoc(announcementRef, {
                    title: title,
                    content: content,
                    mediaUrl: mediaUrl,
                });
                showToast('Announcement updated successfully!');
                closeAnnouncementModal();
            } catch (e) {
                console.error("Error updating announcement: ", e);
                showToast('Failed to update announcement.', true);
            }
        };

        const deleteAnnouncement = async (announcementId) => {
            if (!confirm('Are you sure you want to delete this announcement?')) return;
            try {
                if (!userProfile || !announcementManagementRoles.includes(userProfile['access level'])) {
                    throw new Error('User does not have permission to delete announcements.');
                }
                const announcementRef = doc(db, `artifacts/${appId}/public/data/announcements`, announcementId);
                await deleteDoc(announcementRef);
                showToast('Announcement deleted!');
            } catch (e) {
                console.error("Error deleting announcement: ", e);
                showToast('Failed to delete announcement.', true);
            }
        };

        const toggleArchiveStatus = async (announcementId, currentStatus) => {
            try {
                if (!userProfile || !announcementManagementRoles.includes(userProfile['access level'])) {
                    throw new Error('User does not have permission to archive announcements.');
                }
                const announcementRef = doc(db, `artifacts/${appId}/public/data/announcements`, announcementId);
                await updateDoc(announcementRef, {
                    isArchived: !currentStatus
                });
                showToast(`Announcement ${currentStatus ? 'unarchived' : 'archived'} successfully!`);
            } catch (e) {
                console.error("Error archiving announcement: ", e);
                showToast('Failed to change archive status.', true);
            }
        };

        const updateChecklistItem = async (recordId, itemName, isCompleted) => {
            const recordRef = doc(db, `artifacts/${appId}/public/data/trainingRecords`, recordId);
            try {
                // Fetch the current checklist
                const docSnap = await getDoc(recordRef);
                if (docSnap.exists()) {
                    const recordData = docSnap.data();
                    const updatedChecklist = recordData.checklist.map(item => {
                        if (item.item === itemName) {
                            return { ...item, completed: isCompleted };
                        }
                        return item;
                    });

                    // Update the document with the new checklist
                    await updateDoc(recordRef, {
                        checklist: updatedChecklist
                    });
                } else {
                    console.error("No such document!");
                }
            } catch (e) {
                console.error("Error updating document: ", e);
                showToast('Failed to update checklist item.', true);
            }
        };

        // --- Main Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Hide login overlay and show main content
                loginOverlay.classList.add('hidden');
                mainHeader.classList.remove('hidden');
                mainContent.classList.remove('hidden');

                userId = user.uid;

                // Fetch user profile from the provided path
                const userDocRef = doc(db, 'users', userId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    userProfile = userDocSnap.data();
                    userInfoElement.textContent = `${userProfile.name} | Role: ${userProfile.role} | Access: ${userProfile['access level']}`;
                } else {
                    userInfoElement.textContent = `User ID: ${userId} (Profile not found)`;
                    userProfile = { name: 'Unknown User', role: 'None', 'access level': 'None' }; // Set a default profile
                }

                // Check access level and configure the UI
                if (allowedAccessLevels.includes(userProfile['access level'])) {
                    authButtons.classList.remove('hidden');
                    if (announcementManagementRoles.includes(userProfile['access level'])) {
                        addAnnouncementBtn.classList.remove('hidden');
                        toggleArchiveBtn.classList.remove('hidden');
                    }

                    // Start listening to Firestore for real-time updates for training records
                    const qRecords = collection(db, `artifacts/${appId}/public/data/trainingRecords`);
                    onSnapshot(qRecords, (querySnapshot) => {
                        const records = [];
                        querySnapshot.forEach((doc) => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        renderTrainingRecords(records);
                    }, (error) => {
                        console.error("Error getting records:", error);
                        // Hide loading message and show error for UI clarity
                        loadingMessage.classList.add('hidden');
                        noAccessMessage.textContent = 'Failed to load records due to a permission error.';
                        noAccessMessage.classList.remove('hidden');
                    });
                } else {
                    loadingMessage.classList.add('hidden');
                    noAccessMessage.classList.remove('hidden');
                    authButtons.classList.add('hidden');
                }

                // Always listen for announcements, as they are public for all authenticated users
                const qAnnouncements = collection(db, `artifacts/${appId}/public/data/announcements`);
                onSnapshot(qAnnouncements, (querySnapshot) => {
                    const announcements = [];
                    querySnapshot.forEach((doc) => {
                        announcements.push({ id: doc.id, ...doc.data() });
                    });
                    announcements.sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);
                    renderAnnouncements(announcements);
                    // Hide/Show announcement management buttons based on current user role
                    const isHighCommand = announcementManagementRoles.includes(userProfile?.['access level']);
                    document.querySelectorAll('.edit-announcement-btn, .archive-announcement-btn, .delete-announcement-btn').forEach(btn => {
                        btn.style.display = isHighCommand ? 'inline-block' : 'none';
                    });
                }, (error) => {
                    console.error("Error getting announcements:", error);
                });

            } else {
                // If no user is signed in, display the login overlay
                loginOverlay.classList.remove('hidden');
                mainHeader.classList.add('hidden');
                mainContent.classList.add('hidden');
            }
        });

        // --- Event Listeners ---
        loginBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        addRecordBtn.addEventListener('click', () => openRecordModal());
        closeRecordModalBtn.addEventListener('click', closeRecordModal);
        cancelRecordBtn.addEventListener('click', closeRecordModal);
        recordModal.addEventListener('click', (e) => { if (e.target === recordModal) closeRecordModal(); });

        addAnnouncementBtn.addEventListener('click', () => openAnnouncementModal());
        closeAnnouncementModalBtn.addEventListener('click', closeAnnouncementModal);
        cancelAnnouncementBtn.addEventListener('click', closeAnnouncementModal);
        announcementModal.addEventListener('click', (e) => { if (e.target === announcementModal) closeAnnouncementModal(); });

        toggleArchiveBtn.addEventListener('click', () => {
            showArchived = !showArchived;
            archivedContainer.classList.toggle('hidden', !showArchived);
            toggleArchiveBtn.textContent = showArchived ? 'Hide Archived' : 'View Archived';
        });

        trainingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const traineeName = traineeInput.value.trim();
            const trainerNames = trainerInput.value.split(',').map(name => name.trim()).filter(Boolean);
            const notes = notesInput.value.trim();
            const recommendation = recommendationInput.value;
            const recordId = recordIdInput.value;

            if (traineeName && trainerNames.length > 0) {
                if (recordId) {
                    updateTrainingRecord(recordId, traineeName, trainerNames, notes, recommendation);
                } else {
                    addTrainingRecord(traineeName, trainerNames, notes, recommendation);
                }
            } else {
                showToast('Please fill out all required fields.', true);
            }
        });

        announcementForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = announcementTitleInput.value.trim();
            const content = announcementContentInput.value.trim();
            const mediaUrl = announcementMediaInput.value.trim();
            const announcementId = announcementIdInput.value;

            if (title && content) {
                if (announcementId) {
                    updateAnnouncement(announcementId, title, content, mediaUrl);
                } else {
                    addAnnouncement(title, content, mediaUrl);
                }
            } else {
                showToast('Title and content are required.', true);
            }
        });

        recordsContainer.addEventListener('click', async (e) => {
            const recordCard = e.target.closest('.record-card');
            if (recordCard && allowedAccessLevels.includes(userProfile['access level'])) {
                const recordId = recordCard.dataset.recordId;
                const recordRef = doc(db, `artifacts/${appId}/public/data/trainingRecords`, recordId);
                const docSnap = await getDoc(recordRef);
                if (docSnap.exists()) {
                    openRecordModal({ id: docSnap.id, ...docSnap.data() });
                }
            }
        });

        recordsContainer.addEventListener('change', (e) => {
            const checkbox = e.target;
            if (checkbox.type === 'checkbox') {
                const recordId = checkbox.dataset.recordId;
                const itemName = checkbox.dataset.itemName;
                const isCompleted = checkbox.checked;
                updateChecklistItem(recordId, itemName, isCompleted);
            }
        });

        // New event listeners for announcement management buttons
        document.addEventListener('click', async (e) => {
            if (!announcementManagementRoles.includes(userProfile?.['access level'])) return;

            const editBtn = e.target.closest('.edit-announcement-btn');
            if (editBtn) {
                const announcementId = editBtn.dataset.announcementId;
                const announcementRef = doc(db, `artifacts/${appId}/public/data/announcements`, announcementId);
                const docSnap = await getDoc(announcementRef);
                if (docSnap.exists()) {
                    openAnnouncementModal({ id: docSnap.id, ...docSnap.data() });
                }
                return;
            }

            const archiveBtn = e.target.closest('.archive-announcement-btn');
            if (archiveBtn) {
                const announcementId = archiveBtn.dataset.announcementId;
                const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/announcements`, announcementId));
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().isArchived;
                    toggleArchiveStatus(announcementId, currentStatus);
                }
                return;
            }

            const deleteBtn = e.target.closest('.delete-announcement-btn');
            if (deleteBtn) {
                const announcementId = deleteBtn.dataset.announcementId;
                deleteAnnouncement(announcementId);
                return;
            }
        });

        // Keybinds for Markdown in notes and announcements
        const handleMarkdownKeybinds = (event) => {
            if (event.ctrlKey || event.metaKey) {
                const textarea = event.target;
                let start, end, newText, selectedText;

                switch (event.key) {
                    case 'b': // Bold
                        event.preventDefault();
                        addMarkdown(textarea, '**', '**');
                        break;
                    case 'i': // Italic
                        event.preventDefault();
                        addMarkdown(textarea, '*', '*');
                        break;
                    case 'u': // Underline
                        event.preventDefault();
                        addMarkdown(textarea, '_', '_');
                        break;
                    case 's': // Strikethrough
                        event.preventDefault();
                        addMarkdown(textarea, '~~', '~~');
                        break;
                }
            }
        };

        notesInput.addEventListener('keydown', handleMarkdownKeybinds);
        announcementContentInput.addEventListener('keydown', handleMarkdownKeybinds);
    </script>
</body>
</html>
