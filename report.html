<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Los Santos Police Department</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the hamburger menu */
        .nav-links {
            display: none;
            flex-direction: column;
            width: 100%;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #1e3a8a; /* bg-blue-900 */
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

            .nav-links.active {
                display: flex;
            }

        @media (min-width: 768px) {
            .nav-links {
                display: flex;
                flex-direction: row;
                position: static;
                background-color: transparent;
                box-shadow: none;
                width: auto;
                padding: 0;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }

        .report-header-btn {
            background-color: #374151; /* Dark gray background */
            color: #d1d5db; /* Light gray text */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

            .report-header-btn:hover {
                background-color: #4b5563; /* Lighter gray on hover */
            }

        .report-grid-item {
            background-color: #1f2937;
            border-bottom: 1px solid #374151;
            padding: 1rem;
        }

        .text-input, .report-select, .tag-select {
            width: 100%;
            background-color: #1f2937;
            color: #d1d5db;
            border: 1px solid white; /* Added white border */
            outline: none;
            resize: none;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }

        .report-select {
            width: auto;
        }
        /* Style for the officer narrative box, to remove the border */
        #officerNarrative {
            border: none;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }

        .weapon-entry-display, .evidence-entry-display {
            background-color: #374151;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

            .weapon-entry-display:hover, .evidence-entry-display:hover {
                background-color: #4b5563;
            }

        .delete-btn {
            color: #fca5a5;
            transition: color 0.2s ease-in-out;
        }

            .delete-btn:hover {
                color: #f87171;
            }
        /* Spinner animation for loading */
        .spinner {
            border-top-color: #3b82f6;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

    <!-- Header Section -->
    <header class="bg-blue-900 text-white shadow-lg py-4 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50 rounded-b-lg relative">
        <div class="flex items-center">
            <!-- LSPD Logo with fallback -->
            <img src="LSPD.png" alt="LSPD Logo" class="mr-4 w-16 h-16 object-contain" onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
            <h1 class="text-2xl md:text-3xl font-bold">Los Santos Police Department</h1>
        </div>

        <!-- Hamburger Menu Button for Mobile -->
        <button id="hamburgerBtn" class="hamburger-menu text-white focus:outline-none md:hidden">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h4"></path>
            </svg>
        </button>

        <!-- Navigation Menu -->
        <nav id="navLinks" class="nav-links">
            <ul class="flex flex-col md:flex-row md:flex-wrap md:justify-end space-y-2 md:space-y-0 md:space-x-4 text-sm font-medium">
                <li><a href="index.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700 current-page">Dashboard</a></li>
                <li><a href="SOP.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">SOPs</a></li>
                <li><a href="training.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Training</a></li>
                <li><a href="forms.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Forms</a></li>
                <li><a href="roster.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Roster</a></li>
                <li><a href="hr.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">HR Info</a></li>
                <li><a href="report.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Report Generator</a></li>
                <li><a href="charges.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Charge Calculator</a></li>
                <li><a href="info.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Common Information</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content Area - Report Generator -->
    <main class="flex-grow container mx-auto p-6 md:p-12">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 md:p-8">
            <!-- Report Section Header with Buttons and Dropdown -->
            <div class="flex justify-between items-center mb-6 text-gray-300">
                <div class="flex items-center space-x-2">
                    <button class="report-header-btn flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        <span>Back</span>
                    </button>
                    <!-- Report Type Dropdown Menu -->
                    <select id="reportTypeSelect" class="bg-gray-700 text-white rounded-md px-3 py-1 text-lg font-semibold border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Report Type</option>
                        <option value="Arrest">Arrest</option>
                        <option value="Arrest Warrant">Arrest Warrant</option>
                        <option value="Search Warrant">Search Warrant</option>
                        <option value="Witness Statement">Witness Statement</option>
                        <option value="Officer Observation">Officer Observation</option>
                        <option value="Trespassing Report">Trespassing Report</option>
                        <option value="Citation Report">Citation Report</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="deleteReportBtn" class="report-header-btn bg-red-600 hover:bg-red-700 text-white font-bold">
                        Delete Report
                    </button>
                    <button id="generateBtn" class="report-header-btn bg-blue-600 hover:bg-blue-700 text-white font-bold">
                        Generate Report
                    </button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="mt-4 text-center text-blue-400 flex flex-col items-center justify-center hidden">
                <div class="w-12 h-12 border-4 border-gray-300 rounded-full spinner mb-2"></div>
                <p>Generating report... Please wait.</p>
            </div>

            <!-- Report Grid Layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Left Column -->
                <div id="leftColumn" class="grid grid-cols-1 gap-4">
                    <!-- Dynamic fields will be inserted here -->
                </div>

                <!-- Right Column -->
                <div id="rightColumn" class="grid grid-cols-1 gap-4">
                    <!-- Dynamic fields will be inserted here -->
                </div>
            </div>

            <!-- Dynamic Criminals Section -->
            <div id="criminalsSection" class="mt-4 hidden">
                <div class="flex items-center justify-between">
                    <h3 class="block text-blue-300 font-semibold mb-1 text-lg">Criminals Involved</h3>
                    <button id="addCriminalBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg shadow transition duration-300">
                        Add Criminal
                    </button>
                </div>
                <div id="criminalsContainer" class="mt-2 space-y-4">
                    <!-- Criminal entries will be dynamically added here by JS -->
                </div>
            </div>

        </div>
    </main>

    <!-- Weapons Involved Modal -->
    <div id="weaponModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-blue-300" id="modalTitle">Add Weapon Details</h3>
            <div class="space-y-4">
                <div>
                    <label for="modalWeaponType" class="block text-sm font-medium text-gray-300 mb-1">Weapon Type</label>
                    <input type="text" id="modalWeaponType" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="e.g., Pistol, Rifle, Knife">
                </div>
                <div>
                    <label for="modalWeaponModel" class="block text-sm font-medium text-gray-300 mb-1">Weapon Model</label>
                    <input type="text" id="modalWeaponModel" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="e.g., Glock 19, AK-47, Machete">
                </div>
                <div>
                    <label for="modalWeaponSerial" class="block text-sm font-medium text-gray-300 mb-1">Weapon Serial Number</label>
                    <input type="text" id="modalWeaponSerial" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Enter serial number">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Cancel
                </button>
                <button id="confirmModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Additional Evidence Modal -->
    <div id="evidenceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-blue-300">Add Additional Evidence</h3>
            <div class="space-y-4">
                <div>
                    <label for="modalBodyCam" class="block text-sm font-medium text-gray-300 mb-1">Body Cam Link(s)</label>
                    <textarea id="modalBodyCam" rows="3" class="text-input" placeholder="Paste body cam video links here..."></textarea>
                </div>
                <div>
                    <label for="modalShellCasings" class="block text-sm font-medium text-gray-300 mb-1">Shell Casing Amount</label>
                    <input type="number" id="modalShellCasings" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="e.g., 5">
                </div>
                <div>
                    <label for="modalBloodSamples" class="block text-sm font-medium text-gray-300 mb-1">Blood Sample Information</label>
                    <textarea id="modalBloodSamples" rows="3" class="text-input" placeholder="e.g., Blood samples were taken from the north side of the vehicle..."></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelEvidenceModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Cancel
                </button>
                <button id="confirmEvidenceModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white py-10 px-6 md:px-12 rounded-t-lg">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Internal Contact Info -->
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">Internal Contacts</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://discord.gg/7FwxdpfDTM" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Discord</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1383775099777318972" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Chat</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1383782578976456735" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Cadet Support</a></li>
                </ul>
            </div>
            <!-- Internal Quick Links -->
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">Quick Access</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://docs.google.com/document/d/1etjilZ1dAHGviw33MV5Zs-b5dXqcSHyoYIHvHiRIyy4/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">LSPD SOP</a></li>
                    <li><a href="https://docs.google.com/document/d/1hKQ4fw9b1_yQELhPi1p1b4M6uiSaYb7bBp-9C6GVTdY/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">LSPD Interview Procedure & Questions</a></li>
                    <li><a href="https://docs.google.com/document/d/1d004FfAhZBgESn88Mx21N3CGqXlcoNeP9_sadn_ePak/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Promotional Pathway & Subdivision Assignment Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/14QIEsYMWpTssti1xGbGWiMxQ2b0jbiYxuMmvV8XWUUo/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">HEAT Activation Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/1Ggf7SS5voiIjr3iSLB3VtAc47JN3aDjm2J_gYnpoZ6s/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Disciplinary Guidelines</a></li>
                    <li><a href="https://nlspd.net/" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">LSPD Website</a></li>
                </ul>
            </div>
            <!-- Copyright & System Info -->
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">System Information</h4>
                <p class="text-gray-500 text-sm mb-2">Unauthorized Access Strictly Prohibited</p>
                <p class="text-gray-500 text-sm mb-2">For LSPD Personnel Use Only</p>
                <p class="text-gray-500 text-sm mb-2">Created and Maintained by FiveM "NightLife RP"</p>
                <p class="text-gray-500 text-sm">&copy; 2025 Los Santos Police Department Internal Systems.</p>
            </div>
        </div>
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    </footer>

    <script>
        // Hamburger menu functionality for mobile
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const navLinks = document.getElementById('navLinks');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loading');
        const reportTypeSelect = document.getElementById('reportTypeSelect');
        const leftColumn = document.getElementById('leftColumn');
        const rightColumn = document.getElementById('rightColumn');
        const criminalsSection = document.getElementById('criminalsSection');

        // New button for local storage - only one now
        const deleteReportBtn = document.getElementById('deleteReportBtn');

        // The key used to store the report in local storage
        const localStorageKey = 'lspdReportDraft';

        // Counters for unique IDs for new entries
        let criminalCount = 0;
        let officerCount = 0;
        let civilianCount = 0;
        let tagCount = 0;
        let evidenceCount = 0; // New counter for evidence entries

        // Modal elements
        const weaponModal = document.getElementById('weaponModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalWeaponType = document.getElementById('modalWeaponType');
        const modalWeaponModel = document.getElementById('modalWeaponModel');
        const modalWeaponSerial = document.getElementById('modalWeaponSerial');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const confirmModalBtn = document.getElementById('confirmModalBtn');
        let editingWeaponId = null; // To keep track of which weapon entry is being edited
        let weaponInvolvedCount = 0; // Counter for new entries
        let weaponSeizedCount = 0;
        let currentModalTargetContainer = null; // To know which container to save to

        // New evidence modal elements
        const evidenceModal = document.getElementById('evidenceModal');
        const modalBodyCam = document.getElementById('modalBodyCam');
        const modalShellCasings = document.getElementById('modalShellCasings');
        const modalBloodSamples = document.getElementById('modalBloodSamples');
        const cancelEvidenceModalBtn = document.getElementById('cancelEvidenceModalBtn');
        const confirmEvidenceModalBtn = document.getElementById('confirmEvidenceModalBtn');

        // Function to create a new criminal entry box
        function createCriminalEntry(showMirandizedAndPlea = false, data = {}) {
            const criminalsContainer = document.getElementById('criminalsContainer');
            if (!criminalsContainer) return; // Exit if the container does not exist
            const entryId = criminalCount++;
            const criminalEntryHtml = `
                    <div id="criminal-${entryId}" class="report-grid-item border-none">
                        <div class="flex justify-between items-center mb-2">
                            <label for="criminalName-${entryId}" class="block text-blue-300 font-semibold">Criminal/Suspect Name</label>
                            <button onclick="removeEntry('criminal-${entryId}')" class="text-red-400 hover:text-red-600 text-sm font-bold transition duration-300">
                                Remove
                            </button>
                        </div>
                        <textarea id="criminalName-${entryId}" rows="1" class="text-input" placeholder="Enter name...">${data.name || ''}</textarea>
                        <label for="criminalCharges-${entryId}" class="block text-blue-300 font-semibold mt-4 mb-2">Charges</label>
                        <textarea id="criminalCharges-${entryId}" rows="3" class="text-input" placeholder="List charges (e.g., Grand Theft Auto, Assault)...">${data.charges || ''}</textarea>
                        <label for="criminalFingerprintId-${entryId}" class="block text-blue-300 font-semibold mt-4 mb-2">Fingerprint ID</label>
                        <textarea id="criminalFingerprintId-${entryId}" rows="1" class="text-input" placeholder="Enter fingerprint ID...">${data.fingerprintId || ''}</textarea>
                        ${showMirandizedAndPlea ? `
                        <label for="criminalMirandaized-${entryId}" class="block text-blue-300 font-semibold mt-4 mb-2">Mirandaized?</label>
                        <select id="criminalMirandaized-${entryId}" class="tag-select">
                            <option value="Not Specified" ${data.mirandized === 'Not Specified' ? 'selected' : ''}>Not Specified</option>
                            <option value="Yes" ${data.mirandized === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${data.mirandized === 'No' ? 'selected' : ''}>No</option>
                        </select>
                        ` : ''}
                        ${showMirandizedAndPlea ? `
                        <label for="criminalPlea-${entryId}" class="block text-blue-300 font-semibold mt-4 mb-2">Plea</label>
                        <select id="criminalPlea-${entryId}" class="tag-select">
                            <option value="Not Specified" ${data.plea === 'Not Specified' ? 'selected' : ''}>Not Specified</option>
                            <option value="Guilty" ${data.plea === 'Guilty' ? 'selected' : ''}>Guilty</option>
                            <option value="Not Guilty" ${data.plea === 'Not Guilty' ? 'selected' : ''}>Not Guilty</option>
                            <option value="No Contest" ${data.plea === 'No Contest' ? 'selected' : ''}>No Contest</option>
                        </select>
                        ` : ''}
                    </div>
                `;
            criminalsContainer.insertAdjacentHTML('beforeend', criminalEntryHtml);
        }

        // Function to create a new officer entry box
        function createOfficerEntry(data = {}) {
            const officersContainer = document.getElementById('officersContainer');
            if (!officersContainer) return; // Exit if the container does not exist
            const entryId = officerCount++;
            const officerEntryHtml = `
                    <div id="officer-${entryId}" class="report-grid-item border-none">
                        <div class="flex justify-between items-center mb-2">
                            <label for="officerName-${entryId}" class="block text-blue-300 font-semibold">Officer Name & Badge</label>
                            <button onclick="removeEntry('officer-${entryId}')" class="text-red-400 hover:text-red-600 text-sm font-bold transition duration-300">
                                Remove
                            </button>
                        </div>
                        <textarea id="officerName-${entryId}" rows="1" class="text-input" placeholder="Enter name and badge number...">${data.name || ''}</textarea>
                    </div>
                `;
            officersContainer.insertAdjacentHTML('beforeend', officerEntryHtml);
        }

        // Function to create a new civilian entry box with separate fields for name and role
        function createCivilianEntry(data = {}) {
            const civiliansContainer = document.getElementById('civiliansContainer');
            if (!civiliansContainer) return; // Exit if the container does not exist
            const entryId = civilianCount++;
            const civilianEntryHtml = `
                    <div id="civilian-${entryId}" class="report-grid-item border-none">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-blue-300 font-semibold">Civilian</label>
                            <button onclick="removeEntry('civilian-${entryId}')" class="text-red-400 hover:text-red-600 text-sm font-bold transition duration-300">
                                Remove
                            </button>
                        </div>
                        <label for="civilianName-${entryId}" class="block text-gray-400 font-normal mb-1 text-sm">Name</label>
                        <textarea id="civilianName-${entryId}" rows="1" class="text-input" placeholder="Enter name...">${data.name || ''}</textarea>
                        <label for="civilianRole-${entryId}" class="block text-gray-400 font-normal mt-4 mb-1 text-sm">Role</label>
                        <select id="civilianRole-${entryId}" class="tag-select mt-1">
                            <option value="" ${data.role === '' ? 'selected' : ''}>Select Role</option>
                            <option value="Victim" ${data.role === 'Victim' ? 'selected' : ''}>Victim</option>
                            <option value="Witness" ${data.role === 'Witness' ? 'selected' : ''}>Witness</option>
                            <option value="Caller" ${data.role === 'Caller' ? 'selected' : ''}>Caller</option>
                        </select>
                    </div>
                `;
            civiliansContainer.insertAdjacentHTML('beforeend', civilianEntryHtml);
        }

        // Function to create a new tag entry box with a dropdown
        function createTagEntry(data = {}) {
            const tagsContainer = document.getElementById('tagsContainer');
            if (!tagsContainer) return; // Exit if the container does not exist
            const entryId = tagCount++;
            const tagEntryHtml = `
                    <div id="tag-${entryId}" class="report-grid-item border-none">
                        <div class="flex justify-between items-center mb-2">
                            <label for="tagName-${entryId}" class="block text-blue-300 font-semibold">Tag</label>
                            <button onclick="removeEntry('tag-${entryId}')" class="text-red-400 hover:text-red-600 text-sm font-bold transition duration-300">
                                Remove
                            </button>
                        </div>
                        <select id="tagName-${entryId}" class="tag-select mt-1">
                            <option value="" ${data.name === '' ? 'selected' : ''}>Select a Tag</option>
                            <option value="Vehicle Pursuit" ${data.name === 'Vehicle Pursuit' ? 'selected' : ''}>Vehicle Pursuit</option>
                            <option value="Arrest" ${data.name === 'Arrest' ? 'selected' : ''}>Arrest</option>
                            <option value="Arrest Warrant" ${data.name === 'Arrest Warrant' ? 'selected' : ''}>Arrest Warrant</option>
                            <option value="Search Warrant" ${data.name === 'Search Warrant' ? 'selected' : ''}>Search Warrant</option>
                            <option value="Gang Member" ${data.name === 'Gang Member' ? 'selected' : ''}>Gang Member</option>
                            <option value="Witness Statement" ${data.name === 'Witness Statement' ? 'selected' : ''}>Witness Statement</option>
                            <option value="Officer Observation" ${data.name === 'Officer Observation' ? 'selected' : ''}>Officer Observation</option>
                            <option value="Department of Justice" ${data.name === 'Department of Justice' ? 'selected' : ''}>Department of Justice</option>
                            <option value="FBI" ${data.name === 'FBI' ? 'selected' : ''}>FBI</option>
                            <option value="State Police" ${data.name === 'State Police' ? 'selected' : ''}>State Police</option>
                            <option value="Los Santos Police Department" ${data.name === 'Los Santos Police Department' ? 'selected' : ''}>Los Santos Police Department</option>
                            <option value="Los Santos County Sheriffs Department" ${data.name === 'Los Santos County Sheriffs Department' ? 'selected' : ''}>Los Santos County Sheriffs Department</option>
                        </select>
                    </div>
                `;
            tagsContainer.insertAdjacentHTML('beforeend', tagEntryHtml);
        }

        // Function to create a weapon entry display
        function createWeaponEntryHtml(id, type, model, serial, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const newId = (containerId === 'weaponsInvolvedContainer' ? weaponInvolvedCount++ : weaponSeizedCount++);
            const newEntryHtml = `
                    <div id="${container.id}-${newId}" class="weapon-entry-display flex justify-between items-center"
                         data-id="${newId}"
                         data-type="${type}"
                         data-model="${model}"
                         data-serial="${serial}">
                        <span class="weapon-data">${type} ${model} (SN: ${serial})</span>
                        <button class="delete-btn">
                            &times;
                        </button>
                    </div>
                `;
            container.insertAdjacentHTML('beforeend', newEntryHtml);
        }

        // Function to create an evidence entry display
        function createEvidenceEntryHtml(id, bodyCam, shellCasings, bloodSamples, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const newId = evidenceCount++;
            const newEntryHtml = `
                    <div id="evidence-${newId}" class="evidence-entry-display"
                         data-id="${newId}"
                         data-bodycam="${bodyCam}"
                         data-casings="${shellCasings}"
                         data-blood="${bloodSamples}">
                        <p class="font-bold text-blue-200">Evidence Entry ${newId + 1}</p>
                        <p><strong>Body Cam:</strong> ${bodyCam || 'N/A'}</p>
                        <p><strong>Shell Casings:</strong> ${shellCasings || 'N/A'}</p>
                        <p><strong>Blood Samples:</strong> ${bloodSamples || 'N/A'}</p>
                        <div class="flex justify-end mt-2">
                            <button onclick="removeEntry('evidence-${newId}')" class="delete-btn">
                                &times; Remove
                            </button>
                        </div>
                    </div>
                `;
            container.insertAdjacentHTML('beforeend', newEntryHtml);
        }

        function updateReportFields(reportType, savedData = {}) {
            // Clear previous fields
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';

            // Re-initialize counters to prevent duplicate IDs
            criminalCount = 0;
            officerCount = 0;
            civilianCount = 0;
            tagCount = 0;
            weaponInvolvedCount = 0;
            weaponSeizedCount = 0;
            evidenceCount = 0; // Reset new evidence counter

            let leftColumnHtml = '';
            let rightColumnHtml = '';
            let showCriminals = false;
            let showMirandizedAndPlea = false;

            // Function to generate the new weapon section HTML
            const createWeaponSectionHtml = (containerId, buttonId, title) => `
                    <div class="report-grid-item border-none pb-0">
                        <div class="flex items-center justify-between">
                            <label class="block text-blue-300 font-semibold mb-1 text-lg">${title}</label>
                            <button id="${buttonId}" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg shadow transition duration-300">
                                Add Item
                            </button>
                        </div>
                        <div id="${containerId}" class="mt-2 space-y-4">
                            <!-- Dynamic items will be added here -->
                        </div>
                    </div>
                `;

            const createEvidenceSectionHtml = (containerId, buttonId, title) => `
                    <div class="report-grid-item border-none pb-0">
                        <div class="flex items-center justify-between">
                            <label class="block text-blue-300 font-semibold mb-1 text-lg">${title}</label>
                            <button id="${buttonId}" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg shadow transition duration-300">
                                Add Evidence
                            </button>
                        </div>
                        <div id="${containerId}" class="mt-2 space-y-4">
                            <!-- Dynamic evidence will be added here -->
                        </div>
                    </div>
                `;


            const baseFieldsLeft = `
                    ${createEvidenceSectionHtml('evidenceContainer', 'addEvidenceBtn', 'Additional Evidence')}
                    <div class="report-grid-item">
                        <label for="linkedReports" class="block text-blue-300 font-semibold mb-1">Linked Reports</label>
                        <textarea id="linkedReports" rows="1" class="text-input" placeholder="List linked report IDs or case numbers...">${savedData.linkedReports || ''}</textarea>
                    </div>
                    <div class="report-grid-item bg-gray-900 rounded-lg p-4 h-full">
                        <h3 class="text-xl font-bold mb-2">Officer Narrative/Debrief</h3>
                        <div class="text-sm text-gray-300 mb-4">
                            <textarea id="officerNarrative" rows="15" class="text-input bg-gray-900" placeholder="Officer's narrative and incident details...">${savedData.officerNarrative || ''}</textarea>
                        </div>
                    </div>
                `;

            const baseFieldsRight = `
                    <div class="report-grid-item border-none pb-0">
                        <div class="flex items-center justify-between">
                            <label class="block text-blue-300 font-semibold mb-1 text-lg">Tags</label>
                            <button id="addTagBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg shadow transition duration-300">
                                Add Tag
                            </button>
                        </div>
                        <div id="tagsContainer" class="mt-2 space-y-4">
                            <!-- Tags will be dynamically added here -->
                        </div>
                    </div>
                    ${createWeaponSectionHtml('weaponsInvolvedContainer', 'addWeaponInvolvedBtn', 'Weapons Involved')}
                    ${createWeaponSectionHtml('weaponsSeizedContainer', 'addWeaponSeizedBtn', 'Evidence/Items Seized')}
                    <div class="report-grid-item">
                        <label for="vehicles" class="block text-blue-300 font-semibold mb-1">Vehicles Involved</label>
                        <textarea id="vehicles" rows="1" class="text-input" placeholder="List vehicles involved (make, model, license plate)...">${savedData.vehicles || ''}</textarea>
                    </div>
                    <div class="report-grid-item border-none pb-0">
                        <div class="flex items-center justify-between">
                            <label class="block text-blue-300 font-semibold mb-1 text-lg">Civilians Involved</label>
                            <button id="addCivilianBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg shadow transition duration-300">
                                Add Civilian
                            </button>
                        </div>
                        <div id="civiliansContainer" class="mt-2 space-y-4">
                            <!-- Civilians will be dynamically added here -->
                        </div>
                    </div>
                    <div class="report-grid-item border-none pb-0">
                        <div class="flex items-center justify-between">
                            <label class="block text-blue-300 font-semibold mb-1 text-lg">Officers Involved</label>
                            <button id="addOfficerBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-lg shadow transition duration-300">
                                Add Officer
                            </button>
                        </div>
                        <div id="officersContainer" class="mt-2 space-y-4">
                            <!-- Officers will be dynamically added here -->
                        </div>
                    </div>
                `;

            // Logic to determine which fields to show based on report type
            if (reportType === "Arrest" || reportType === "Citation Report") {
                leftColumnHtml = baseFieldsLeft;
                rightColumnHtml = baseFieldsRight;
                showCriminals = true;
                showMirandizedAndPlea = true;
            } else if (reportType === "Arrest Warrant" || reportType === "Search Warrant") {
                leftColumnHtml = baseFieldsLeft;
                rightColumnHtml = baseFieldsRight;
                showCriminals = true;
                showMirandizedAndPlea = false;
            } else if (reportType === "Witness Statement" || reportType === "Officer Observation") {
                leftColumnHtml = baseFieldsLeft;
                rightColumnHtml = baseFieldsRight;
                showCriminals = false;
                showMirandizedAndPlea = false;
            } else if (reportType === "Trespassing Report") {
                leftColumnHtml = baseFieldsLeft;
                rightColumnHtml = baseFieldsRight;
                showCriminals = true;
                showMirandizedAndPlea = false;
            } else {
                // Default view when nothing is selected
                leftColumnHtml = baseFieldsLeft;
                rightColumnHtml = baseFieldsRight;
                showCriminals = true;
                showMirandizedAndPlea = false;
            }

            // Insert the generated HTML
            leftColumn.innerHTML = leftColumnHtml;
            rightColumn.innerHTML = rightColumnHtml;
            criminalsSection.classList.toggle('hidden', !showCriminals);

            // Populate fields from saved data
            if (savedData.criminals && savedData.criminals.length > 0) {
                savedData.criminals.forEach(criminal => createCriminalEntry(showMirandizedAndPlea, criminal));
            }
            if (savedData.officers && savedData.officers.length > 0) {
                savedData.officers.forEach(officer => createOfficerEntry(officer));
            }
            if (savedData.civilians && savedData.civilians.length > 0) {
                savedData.civilians.forEach(civilian => createCivilianEntry(civilian));
            }
            if (savedData.tags && savedData.tags.length > 0) {
                savedData.tags.forEach(tag => createTagEntry(tag));
            }
            if (savedData.weaponsInvolved && savedData.weaponsInvolved.length > 0) {
                savedData.weaponsInvolved.forEach(weapon => createWeaponEntryHtml(weapon.id, weapon.type, weapon.model, weapon.serial, 'weaponsInvolvedContainer'));
            }
            if (savedData.weaponsSeized && savedData.weaponsSeized.length > 0) {
                savedData.weaponsSeized.forEach(weapon => createWeaponEntryHtml(weapon.id, weapon.type, weapon.model, weapon.serial, 'weaponsSeizedContainer'));
            }
            if (savedData.additionalEvidence && savedData.additionalEvidence.length > 0) {
                savedData.additionalEvidence.forEach(evidence => createEvidenceEntryHtml(evidence.id, evidence.bodycam, evidence.casings, evidence.blood, 'evidenceContainer'));
            }

            // Populate initial dynamic criminal entry if needed and no data was loaded
            if (showCriminals && (!savedData.criminals || savedData.criminals.length === 0)) {
                createCriminalEntry(showMirandizedAndPlea);
            }
            if (showCriminals && (!savedData.officers || savedData.officers.length === 0)) {
                createOfficerEntry();
            }
            if (showCriminals && (!savedData.civilians || savedData.civilians.length === 0)) {
                createCivilianEntry();
            }
            if (showCriminals && (!savedData.tags || savedData.tags.length === 0)) {
                createTagEntry();
            }

            // Re-bind event listeners for new buttons
            const addCriminalBtn = document.getElementById('addCriminalBtn');
            const addOfficerBtn = document.getElementById('addOfficerBtn');
            const addCivilianBtn = document.getElementById('addCivilianBtn');
            const addTagBtn = document.getElementById('addTagBtn');

            if (addCriminalBtn) addCriminalBtn.addEventListener('click', () => createCriminalEntry(showMirandizedAndPlea));
            if (addOfficerBtn) addOfficerBtn.addEventListener('click', createOfficerEntry);
            if (addCivilianBtn) addCivilianBtn.addEventListener('click', createCivilianEntry);
            if (addTagBtn) addTagBtn.addEventListener('click', createTagEntry);

            // Re-bind event listeners for the new weapon and evidence buttons
            const addWeaponInvolvedBtn = document.getElementById('addWeaponInvolvedBtn');
            const addWeaponSeizedBtn = document.getElementById('addWeaponSeizedBtn');
            const addEvidenceBtn = document.getElementById('addEvidenceBtn');

            if (addWeaponInvolvedBtn) addWeaponInvolvedBtn.addEventListener('click', () => openWeaponModal(null, 'weaponsInvolvedContainer'));
            if (addWeaponSeizedBtn) addWeaponSeizedBtn.addEventListener('click', () => openWeaponModal(null, 'weaponsSeizedContainer'));
            if (addEvidenceBtn) addEvidenceBtn.addEventListener('click', openEvidenceModal);

            // Re-bind event delegation for weapon containers
            setupWeaponContainerListeners('weaponsInvolvedContainer');
            setupWeaponContainerListeners('weaponsSeizedContainer');

            // Setup listener for the new evidence container
            setupEvidenceContainerListener('evidenceContainer');

            // Add event listeners to save the draft whenever a field is changed
            document.querySelectorAll('textarea, input, select').forEach(element => {
                element.addEventListener('input', saveReportDraft);
                element.addEventListener('change', saveReportDraft);
            });
        }

        /**
         * Saves the entire form's data to local storage.
         */
        function saveReportDraft() {
            // Collect all data from the form
            const formData = {
                reportType: reportTypeSelect.value,
                linkedReports: document.getElementById('linkedReports')?.value || '',
                officerNarrative: document.getElementById('officerNarrative')?.value || '',
                vehicles: document.getElementById('vehicles')?.value || '',

                // Dynamic sections
                criminals: Array.from(document.querySelectorAll('[id^="criminal-"]')).map(criminalDiv => {
                    const id = criminalDiv.id.split('-')[1];
                    return {
                        name: document.getElementById(`criminalName-${id}`)?.value || '',
                        charges: document.getElementById(`criminalCharges-${id}`)?.value || '',
                        fingerprintId: document.getElementById(`criminalFingerprintId-${id}`)?.value || '',
                        mirandized: document.getElementById(`criminalMirandaized-${id}`)?.value || '',
                        plea: document.getElementById(`criminalPlea-${id}`)?.value || ''
                    };
                }),
                officers: Array.from(document.querySelectorAll('[id^="officer-"]')).map(officerDiv => {
                    const id = officerDiv.id.split('-')[1];
                    return {
                        name: document.getElementById(`officerName-${id}`)?.value || ''
                    };
                }),
                civilians: Array.from(document.querySelectorAll('[id^="civilian-"]')).map(civilianDiv => {
                    const id = civilianDiv.id.split('-')[1];
                    return {
                        name: document.getElementById(`civilianName-${id}`)?.value || '',
                        role: document.getElementById(`civilianRole-${id}`)?.value || ''
                    };
                }),
                tags: Array.from(document.querySelectorAll('[id^="tag-"]')).map(tagDiv => {
                    const id = tagDiv.id.split('-')[1];
                    return {
                        name: document.getElementById(`tagName-${id}`)?.value || ''
                    };
                }),
                weaponsInvolved: Array.from(document.querySelectorAll('#weaponsInvolvedContainer .weapon-entry-display')).map(weaponDiv => {
                    return {
                        id: weaponDiv.dataset.id,
                        type: weaponDiv.dataset.type,
                        model: weaponDiv.dataset.model,
                        serial: weaponDiv.dataset.serial
                    };
                }),
                weaponsSeized: Array.from(document.querySelectorAll('#weaponsSeizedContainer .weapon-entry-display')).map(weaponDiv => {
                    return {
                        id: weaponDiv.dataset.id,
                        type: weaponDiv.dataset.type,
                        model: weaponDiv.dataset.model,
                        serial: weaponDiv.dataset.serial
                    };
                }),
                additionalEvidence: Array.from(document.querySelectorAll('#evidenceContainer .evidence-entry-display')).map(evidenceDiv => {
                    return {
                        id: evidenceDiv.dataset.id,
                        bodycam: evidenceDiv.dataset.bodycam,
                        casings: evidenceDiv.dataset.casings,
                        blood: evidenceDiv.dataset.blood
                    };
                }),
            };

            localStorage.setItem(localStorageKey, JSON.stringify(formData));
            console.log('Draft saved automatically.');
        }

        /**
         * Loads the saved draft from local storage and populates the form.
         */
        function loadReportDraft() {
            const savedDraft = localStorage.getItem(localStorageKey);
            if (savedDraft) {
                const data = JSON.parse(savedDraft);
                // Clear the current form and load the saved data
                reportTypeSelect.value = data.reportType || '';
                updateReportFields(data.reportType || '', data);
            } else {
                // If no draft is found, initialize a blank form
                updateReportFields('');
            }
        }

        /**
         * Clears the form and the saved draft from local storage.
         */
        function clearReportDraft() {
            if (confirm("Are you sure you want to clear the entire report and delete the saved draft? This action cannot be undone.")) {
                localStorage.removeItem(localStorageKey);
                location.reload(); // Reloads the page to clear all fields and state
            }
        }

        /**
         * Sets up the event listeners for editing and deleting on a specific weapon container.
         * @param {string} containerId - The ID of the container to attach listeners to.
         */
        function setupWeaponContainerListeners(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.addEventListener('click', (e) => {
                const clickedElement = e.target;
                const entry = clickedElement.closest('.weapon-entry-display');

                if (!entry) return;

                // Check if the delete button was clicked
                if (clickedElement.closest('.delete-btn')) {
                    entry.remove();
                    saveReportDraft(); // Save after deletion
                    return;
                }

                // If the container itself was clicked, open the modal for editing
                const weapon = {
                    id: entry.dataset.id,
                    type: entry.dataset.type,
                    model: entry.dataset.model,
                    serial: entry.dataset.serial,
                    containerId: containerId, // Store the container ID for saving
                };
                openWeaponModal(weapon, containerId);
            });
        }

        /**
         * Sets up the event listeners for editing and deleting on the evidence container.
         * @param {string} containerId - The ID of the container to attach listeners to.
         */
        function setupEvidenceContainerListener(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.addEventListener('click', (e) => {
                const clickedElement = e.target;
                const entry = clickedElement.closest('.evidence-entry-display');

                if (!entry) return;

                // Check if the delete button was clicked
                if (clickedElement.closest('.delete-btn')) {
                    entry.remove();
                    saveReportDraft(); // Save after deletion
                    return;
                }
            });
        }


        // General function to remove a dynamic entry box
        window.removeEntry = function (id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
                saveReportDraft(); // Save after removing an element
            }
        };

        /**
         * Opens the weapon modal, either for adding a new weapon or editing an existing one.
         * @param {object|null} weapon - The weapon object to edit, or null for a new entry.
         * @param {string} containerId - The ID of the container to add/edit the weapon in.
         */
        function openWeaponModal(weapon = null, containerId) {
            weaponModal.classList.remove('hidden');
            currentModalTargetContainer = containerId;
            if (weapon) {
                // Edit existing weapon: populate the fields with existing data
                modalTitle.textContent = "Edit Item Details";
                modalWeaponType.value = weapon.type || '';
                modalWeaponModel.value = weapon.model || '';
                modalWeaponSerial.value = weapon.serial || '';
                editingWeaponId = weapon.id;
            } else {
                // Add new weapon: clear the fields
                modalTitle.textContent = "Add Item Details";
                modalWeaponType.value = '';
                modalWeaponModel.value = '';
                modalWeaponSerial.value = '';
                editingWeaponId = null;
            }
        }

        /**
         * Closes the weapon modal.
         */
        function closeWeaponModal() {
            weaponModal.classList.add('hidden');
            editingWeaponId = null;
            currentModalTargetContainer = null;
        }

        /**
         * Saves or updates the weapon details from the modal.
         */
        function saveWeaponDetails() {
            const type = modalWeaponType.value.trim();
            const model = modalWeaponModel.value.trim();
            const serial = modalWeaponSerial.value.trim();

            const weaponsContainer = document.getElementById(currentModalTargetContainer);
            if (!weaponsContainer) {
                console.error("Target container not found:", currentModalTargetContainer);
                closeWeaponModal();
                return;
            }

            // If all fields are empty, just close the modal
            if (!type && !model && !serial) {
                closeWeaponModal();
                return;
            }

            if (editingWeaponId !== null) {
                // Edit existing weapon
                const existingEntry = document.getElementById(`${weaponsContainer.id}-${editingWeaponId}`);
                if (existingEntry) {
                    const dataSpan = existingEntry.querySelector('.weapon-data');
                    // Update the display text and the data attributes
                    dataSpan.textContent = `${type} ${model} (SN: ${serial})`;
                    existingEntry.dataset.type = type;
                    existingEntry.dataset.model = model;
                    existingEntry.dataset.serial = serial;
                }
            } else {
                // Add a new weapon
                const newId = (currentModalTargetContainer === 'weaponsInvolvedContainer' ? weaponInvolvedCount++ : weaponSeizedCount++);
                const newEntryHtml = `
                        <div id="${weaponsContainer.id}-${newId}" class="weapon-entry-display flex justify-between items-center"
                             data-id="${newId}"
                             data-type="${type}"
                             data-model="${model}"
                             data-serial="${serial}">
                            <span class="weapon-data">${type} ${model} (SN: ${serial})</span>
                            <button class="delete-btn">
                                &times;
                            </button>
                        </div>
                    `;
                weaponsContainer.insertAdjacentHTML('beforeend', newEntryHtml);
            }
            closeWeaponModal();
            saveReportDraft(); // Save after adding/editing a weapon
        }

        /**
         * Opens the evidence modal.
         */
        function openEvidenceModal() {
            evidenceModal.classList.remove('hidden');
            modalBodyCam.value = '';
            modalShellCasings.value = '';
            modalBloodSamples.value = '';
        }

        /**
         * Closes the evidence modal.
         */
        function closeEvidenceModal() {
            evidenceModal.classList.add('hidden');
        }

        /**
         * Saves or updates the evidence details from the modal.
         */
        function saveEvidenceDetails() {
            const bodyCamLinks = modalBodyCam.value.trim();
            const shellCasings = modalShellCasings.value.trim();
            const bloodSamples = modalBloodSamples.value.trim();

            if (!bodyCamLinks && !shellCasings && !bloodSamples) {
                closeEvidenceModal();
                return;
            }

            const evidenceContainer = document.getElementById('evidenceContainer');
            const newId = evidenceCount++;

            const newEntryHtml = `
                    <div id="evidence-${newId}" class="evidence-entry-display"
                         data-id="${newId}"
                         data-bodycam="${bodyCamLinks}"
                         data-casings="${shellCasings}"
                         data-blood="${bloodSamples}">
                        <p class="font-bold text-blue-200">Evidence Entry ${newId + 1}</p>
                        <p><strong>Body Cam:</strong> ${bodyCamLinks || 'N/A'}</p>
                        <p><strong>Shell Casings:</strong> ${shellCasings || 'N/A'}</p>
                        <p><strong>Blood Samples:</strong> ${bloodSamples || 'N/A'}</p>
                        <div class="flex justify-end mt-2">
                            <button onclick="removeEntry('evidence-${newId}')" class="delete-btn">
                                &times; Remove
                            </button>
                        </div>
                    </div>
                `;
            evidenceContainer.insertAdjacentHTML('beforeend', newEntryHtml);
            closeEvidenceModal();
            saveReportDraft(); // Save after adding evidence
        }

        hamburgerBtn.addEventListener('click', () => {
            navLinks.classList.toggle('active');
        });

        // Add event listeners for the modal buttons here
        cancelModalBtn.addEventListener('click', closeWeaponModal);
        confirmModalBtn.addEventListener('click', saveWeaponDetails);
        cancelEvidenceModalBtn.addEventListener('click', closeEvidenceModal);
        confirmEvidenceModalBtn.addEventListener('click', saveEvidenceDetails);

        reportTypeSelect.addEventListener('change', (e) => {
            const savedData = JSON.parse(localStorage.getItem(localStorageKey)) || {};
            savedData.reportType = e.target.value;
            updateReportFields(e.target.value, savedData);
            saveReportDraft();
        });

        deleteReportBtn.addEventListener('click', clearReportDraft);

        document.addEventListener('DOMContentLoaded', () => {
            loadReportDraft(); // Load the saved draft when the page loads
        });

        generateBtn.addEventListener('click', async () => {
            const reportType = reportTypeSelect.value || "General Police Report";
            const linkedReports = document.getElementById('linkedReports')?.value || 'None provided';
            const vehicles = document.getElementById('vehicles')?.value || 'None provided';
            const officerNarrativeTextArea = document.getElementById('officerNarrative');
            const originalNarrative = officerNarrativeTextArea.value.trim() || 'No narrative provided.';

            // Get the first officer's name and badge number for the persona
            const firstOfficerInput = document.querySelector('[id^="officerName-"]');
            const firstOfficerName = firstOfficerInput ? firstOfficerInput.value.trim() : 'Reporting Officer';

            // Helper function to collect data from dynamic fields
            const getDynamicInputValues = (containerId, namePrefix, additionalPrefixes = []) => {
                const container = document.getElementById(containerId);
                if (!container) return 'None provided';
                const entries = container.querySelectorAll(`[id^="${namePrefix}-"]`);
                const values = [];
                entries.forEach((inputElement) => {
                    const entryId = inputElement.id.split('-')[1];
                    let mainValue = inputElement.value.trim();
                    let entryString = '';
                    if (mainValue !== '' && mainValue !== "Select a Tag" && mainValue !== "Select Role") {
                        entryString += mainValue;
                    }

                    // Collect additional fields
                    additionalPrefixes.forEach(prefix => {
                        const additionalInput = document.getElementById(`${prefix}-${entryId}`);
                        if (additionalInput) {
                            let additionalValue = additionalInput.tagName === 'SELECT' ? additionalInput.value : additionalInput.value.trim();
                            if (additionalValue && additionalValue !== 'Not Specified' && additionalValue !== '') {
                                const cleanPrefix = prefix.replace('criminal', '').replace('Name', ' ').replace('civilian', ' ').replace('weapon', ' ').trim();
                                if (prefix === 'criminalFingerprintId') {
                                    entryString += ` (Fingerprint ID: ${additionalValue})`;
                                } else if (prefix === 'criminalMirandaized') {
                                    entryString += ` (Mirandaized): ${additionalValue}`;
                                } else if (prefix === 'criminalPlea') {
                                    entryString += ` (Plea): ${additionalValue}`;
                                } else {
                                    entryString += ` (${cleanPrefix}): ${additionalValue}`;
                                }
                            }
                        }
                    });

                    if (entryString.trim() !== '') {
                        values.push(entryString);
                    }
                });
                return values.length > 0 ? values.join('; ') : 'None provided';
            };

            // Custom function to get data from the new modal-driven weapons section
            const getWeaponEntryValues = (containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return 'None provided';
                const weaponEntries = container.querySelectorAll('.weapon-entry-display');
                const values = [];
                weaponEntries.forEach(entry => {
                    const type = entry.dataset.type;
                    const model = entry.dataset.model;
                    const serial = entry.dataset.serial;
                    values.push(`${type} ${model} (SN: ${serial})`);
                });
                return values.length > 0 ? values.join('; ') : 'None provided';
            };

            // Custom function to get data from the new modal-driven evidence section
            const getEvidenceEntryValues = (containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return 'None provided';
                const evidenceEntries = container.querySelectorAll('.evidence-entry-display');
                const values = [];
                evidenceEntries.forEach(entry => {
                    const bodyCam = entry.dataset.bodycam;
                    const casings = entry.dataset.casings;
                    const blood = entry.dataset.blood;
                    let entryString = [];
                    if (bodyCam) entryString.push(`Body Cam: ${bodyCam}`);
                    if (casings) entryString.push(`Shell Casings: ${casings}`);
                    if (blood) entryString.push(`Blood Samples: ${blood}`);
                    values.push(entryString.join(', '));
                });
                return values.length > 0 ? values.join('; ') : 'None provided';
            };


            // Collect data based on the current visible fields
            const criminalsInvolved = getDynamicInputValues('criminalsContainer', 'criminalName', ['criminalCharges', 'criminalFingerprintId', 'criminalMirandaized', 'criminalPlea']);
            const officersInvolved = getDynamicInputValues('officersContainer', 'officerName');
            const civiliansInvolved = getDynamicInputValues('civiliansContainer', 'civilianName', ['civilianRole']);
            const weaponsInvolved = getWeaponEntryValues('weaponsInvolvedContainer');
            const evidence = getWeaponEntryValues('weaponsSeizedContainer'); // Renamed from weaponsSeized
            const additionalEvidence = getEvidenceEntryValues('evidenceContainer');
            const tagsInvolved = getDynamicInputValues('tagsContainer', 'tagName');

            // Construct the updated prompt for the Gemini AI with the new persona and plain text instructions
            const prompt = `
                You are an LSPD Officer. Your name and badge number are ${firstOfficerName}. Write a detailed, professional, and well-written police report from your first-person perspective. The report must use proper grammar, be detailed, and avoid jargon. The final output must be a single block of plain text, with no markdown, and only include information provided.

                First, write the narrative based on the details below. Then, provide a structured debrief section.

                Here are the report details:
                - Report Type: ${reportType}
                - Linked Reports: ${linkedReports}
                - Criminals Involved: ${criminalsInvolved}
                - Officers Involved: ${officersInvolved}
                - Civilians Involved: ${civiliansInvolved}
                - Weapons Involved: ${weaponsInvolved}
                - Evidence: ${evidence}
                - Additional Evidence: ${additionalEvidence}
                - Vehicles Involved: ${vehicles}
                - Tags: ${tagsInvolved}

                Your final output must follow this exact structure. First, provide the professional narrative based on the details above. Then, add the structured debrief.

                [Professionally rewritten narrative]

                Debrief
                Justification of Charges: [Generate justification from charges and narrative details]
                Postal/Location: [Parse from narrative or state N/A]
                Evidence/Items Seized: [List all evidence and items from the provided details]
                Level of Force: [Parse from narrative or state N/A]
                Medical Treatment (Y | N): [Parse from narrative or state N/A]
                GSR Test (positive | negative): [Parse from narrative or state N/A]
                Legal Representation: [Parse from narrative or state N/A]
                Mirandized (Y | N): [State Y or N based on provided criminal details]
                Can return weapons (Y | N): [State Y or N based on charges and weapons, or N/A]
                Plea (guilty | not guilty | no contest): [State the plea based on provided criminal details]
                `;

            if (officerNarrativeTextArea) {
                officerNarrativeTextArea.value = ''; // Clear previous content
            }
            loadingIndicator.classList.remove('hidden'); // Show loading indicator

            try {
                // Fetch call to the Gemini API
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAbU7k_19bBgnGpFtX742tYGwLySd_U3fI" // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    if (officerNarrativeTextArea) {
                        officerNarrativeTextArea.value = generatedText; // Populate the textarea with the AI-generated text
                        saveReportDraft(); // Save the final generated report
                    }
                } else {
                    if (officerNarrativeTextArea) {
                        officerNarrativeTextArea.value = 'Failed to generate report. Please check the inputs and try again.';
                    }
                }

            } catch (error) {
                console.error('Error generating report:', error);
                if (officerNarrativeTextArea) {
                    officerNarrativeTextArea.value = 'An error occurred while generating the report. Please try again later.';
                }
            } finally {
                loadingIndicator.classList.add('hidden'); // Hide loading indicator
            }
        });
    </script>
</body>
</html>
