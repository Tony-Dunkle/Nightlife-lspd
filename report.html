<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPD MDT - Report Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for the video background and mobile menu */
        .background-video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

            .background-video-container video {
                width: 100%;
                height: 100%;
                object-fit: cover;
                filter: brightness(0.5); /* Darkens the video for better text readability */
            }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }

        /* The mobile menu is hidden by default and shown with JavaScript */
        .nav-links {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: rgba(17, 24, 39, 0.9); /* Dark blue with transparency */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
        }

            /* Show menu on mobile */
            .nav-links.show-menu {
                display: block;
            }

        /* Force nav to be flex for desktop */
        @media (min-width: 768px) {
            .nav-links {
                display: flex;
                position: static;
                width: auto;
                background-color: transparent;
                padding: 0;
            }
        }
        /* Custom styles for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

            .modal-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

        .modal-content {
            background-color: #1f2937;
            border-radius: 12px;
            padding: 24px;
            max-width: 90%;
            width: 450px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.hidden .modal-content {
            transform: translateY(-50px);
            opacity: 0;
        }
        /* Style for selected officers and charges */
        .officer-item.selected, .charge-item.selected {
            background-color: #374151; /* A solid gray to indicate selection */
            color: #ffffff;
            border: 2px solid #4b5563;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 font-sans leading-normal tracking-normal">

    <!-- Header Section -->
    <header class="bg-blue-900 text-white shadow-lg py-4 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50 rounded-b-lg relative">
        <div class="flex items-center">
            <!-- UPD Logo -->
            <img src="LSPD.png" alt="UPD Logo" class="mr-4 w-16 h-16 object-contain" onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
            <!-- Responsive font size: text-2xl for small screens, text-3xl for medium screens and up -->
            <h1 class="text-2xl md:text-3xl font-bold">Unified Police Department</h1>
        </div>

        <!-- Hamburger Menu Button for Mobile -->
        <button id="hamburgerBtn" class="hamburger-menu text-white focus:outline-none md:hidden">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h4"></path>
            </svg>
        </button>

        <!-- Navigation Menu -->
        <!-- Added md:flex-grow to nav to allow it to take available space -->
        <nav class="nav-links md:flex md:flex-grow md:justify-end">
            <!-- Changed md:space-x-8 to md:space-x-4 and added md:flex-wrap for stacking -->
            <ul class="flex flex-col md:flex-row md:flex-wrap md:justify-end space-y-2 md:space-y-0 md:space-x-4 text-sm font-medium">
                <li><a href="index.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Dashboard</a></li>
                <li><a href="SOP.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">SOPs</a></li>
                <li><a href="training.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Training</a></li>
                <li><a href="forms.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Forms</a></li>
                <li><a href="roster.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700 current-page">Roster</a></li>
                <li><a href="hr.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">HR Info</a></li>
                <li><a href="report.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Report Generator</a></li>
                <li><a href="charges.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Charge Calculator</a></li>
                <li><a href="info.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Common Information</a></li>
            </ul>
        </nav>
        <!-- Settings Icon -->
        <img src="settings.png" alt="Settings" id="settingsIcon" class="ml-4 cursor-pointer">
    </header>

    <!-- Main Content Section: MDT Report Interface -->
    <main class="bg-gray-900 text-white min-h-screen">
        <!-- MDT-style Header for the report page -->
        <div class="flex items-center justify-between p-4 bg-gray-800 text-white rounded-b-lg shadow-md">
            <!--
                Changes made here to move the title to the center and remove the save button.
                The 'New Case' title is now in a flex-grow div with text-center to push it to the middle.
                The save button has been removed, and the cancel button remains on the right.
            -->
            <div class="flex-grow text-center">
                <h1 id="caseTitle" class="text-lg md:text-2xl font-bold">New Case</h1>
            </div>
            <div>
                <!-- UPDATED: Replaced Cancel button with Delete button and added a confirmation modal -->
                <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Delete</button>
            </div>
        </div>

        <!-- Main Report Body Container -->
        <div class="p-4 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Left Column -->
            <div class="col-span-1 flex flex-col space-y-4">
                <!-- Evidence Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Evidence</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="evidence-list">+ Add</button>
                    </div>
                    <ul id="evidence-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO ATTACHED EVIDENCE</li>
                    </ul>
                </div>
                <!-- Linked Reports Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Linked Reports</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="linked-reports-list">+ Add</button>
                    </div>
                    <ul id="linked-reports-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO LINKED REPORTS</li>
                    </ul>
                </div>
                <!-- Evidence Locker Number Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Evidence Locker Number</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="evidence-locker-list">+ Add</button>
                    </div>
                    <ul id="evidence-locker-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO EVIDENCE LOCKER NUMBERS</li>
                    </ul>
                </div>
                <!-- Description Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Description</h3>
                        <button id="generate-report-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">
                            Generate with AI
                        </button>
                    </div>
                    <!-- Text editor toolbar (mocked with icons) -->
                    <div class="flex space-x-2 mb-2 p-2 rounded-t-lg bg-gray-700">
                        <button class="text-white hover:text-gray-300"><b>B</b></button>
                        <button class="text-white hover:text-gray-300"><i>I</i></button>
                        <button class="text-white hover:text-gray-300"><u>H</u></button>
                        <button class="text-white hover:text-gray-300">...</button>
                        <button class="text-white hover:text-gray-300">‚ñ§</button>
                        <button class="text-white hover:text-gray-300">üñºÔ∏è</button>
                        <button class="text-white hover:text-gray-300">üîó</button>
                        <button class="text-white hover:text-gray-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        </button>
                    </div>
                    <!-- Loading state container for the description -->
                    <div id="description-loading-container" class="hidden flex justify-center items-center flex-grow bg-gray-700 rounded-b-lg">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                    </div>
                    <textarea id="report-description" placeholder="Enter a description..." class="w-full flex-grow p-2 bg-gray-700 text-white rounded-b-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-600"></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-span-1 flex flex-col space-y-4">
                <!-- Tags Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Tags</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="tags-list">+ Add</button>
                    </div>
                    <ul id="tags-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO TAGS</li>
                    </ul>
                </div>
                <!-- Weapons Involved Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Weapons Involved</h3>
                        <!-- NEW: Specific button for the new weapon modal -->
                        <button id="add-weapon-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <ul id="weapons-list" class="space-y-2 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO WEAPONS INVOLVED</li>
                    </ul>
                </div>
                <!-- Vehicles Involved Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Vehicles Involved</h3>
                        <button id="add-vehicle-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <ul id="vehicles-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO VEHICLES INVOLVED</li>
                    </ul>
                </div>
                <!-- Civilians Involved Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Civilians Involved</h3>
                        <button id="add-civilian-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <ul id="civilians-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO CIVILIANS INVOLVED</li>
                    </ul>
                </div>
                <!-- Officers Involved Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Officers Involved</h3>
                        <button id="add-officer-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <ul id="officers-list" class="space-y-1 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO OFFICERS INVOLVED</li>
                    </ul>
                </div>
                <!-- Criminals Involved Section (Updated structure) -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Criminals Involved</h3>
                        <!-- Changed to a specific button ID for this section -->
                        <button id="add-criminal-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <!-- The list will now hold complex items with nested charges -->
                    <ul id="criminals-list" class="space-y-4 text-sm text-gray-400">
                        <li class="p-2 border border-gray-700 rounded-md">NO CRIMINALS INVOLVED</li>
                    </ul>
                </div>

                <!-- Report Details Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4">Report Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="postal-location" class="block text-sm font-medium text-gray-400">Postal/Location</label>
                            <input type="text" id="postal-location" placeholder="Enter postal code or address" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div>
                            <label for="level-of-force" class="block text-sm font-medium text-gray-400">Level of Force</label>
                            <select id="level-of-force" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="None">None</option>
                                <option value="Verbal Commands">Verbal Commands</option>
                                <option value="Physical Restraint">Physical Restraint</option>
                                <option value="Taser Deployment">Taser Deployment</option>
                                <option value="Lethal Force">Lethal Force</option>
                            </select>
                        </div>
                        <div>
                            <label for="medical-treatment" class="block text-sm font-medium text-gray-400">Medical Treatment</label>
                            <select id="medical-treatment" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label for="gsr-test" class="block text-sm font-medium text-gray-400">GSR Test</label>
                            <select id="gsr-test" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="Not Applicable">Not Applicable</option>
                                <option value="Positive">Positive</option>
                                <option value="Negative">Negative</option>
                            </select>
                        </div>
                        <div>
                            <label for="legal-representation" class="block text-sm font-medium text-gray-400">Legal Representation</label>
                            <select id="legal-representation" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label for="mirandized" class="block text-sm font-medium text-gray-400">Mirandized</label>
                            <select id="mirandized" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label for="return-weapons" class="block text-sm font-medium text-gray-400">Can return weapons</label>
                            <select id="return-weapons" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label for="plea" class="block text-sm font-medium text-gray-400">Plea</label>
                            <select id="plea" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="Not Applicable">Not Applicable</option>
                                <option value="Guilty">Guilty</option>
                                <option value="Not Guilty">Not Guilty</option>
                                <option value="No Contest">No Contest</option>
                            </select>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Footer Section - Internal Contacts -->
    <footer class="bg-gray-800 text-white py-10 px-6 md:px-12 rounded-t-lg mt-8">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h4 class="text-xl font-semibold mb-4 text-gray-300">Internal Contacts</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://discord.gg/7FwxdpfDTM" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Discord</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398235660058685" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Support</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398240840290374" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Chat</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398235660058685" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Internal Affairs</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398239678333030" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Announcements</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-xl font-semibold mb-4 text-gray-300">Quick Access</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://docs.google.com/document/d/1etjilZ1dAHGviw33MV5Zs-b5dXqcSHyoYIHvHiRIyy4/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD SOP</a></li>
                    <li><a href="https://docs.google.com/document/d/1hKQ4fw9b1_yQELhPi1p1b4M6uiSaYb7bBp-9C6GVTdY/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Unified Police Department Interview Procedure & Questions</a></li>
                    <li><a href="https://docs.google.com/document/d/1d004FfAhZBgESn88Mx21N3CGqXlcoNeP9_sadn_ePak/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Promotional Pathway & Subdivision Assignment Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/14QIEsYMWpTssti1xGbGWiMxQ2b0jbiYxuMmvV8XWUUo/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Highway Enforcement and Apprehension Team (HEAT) Activation Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/1Ggf7SS5voiIjr3iSLB3VtAc47JN3aDjm2J_gYnpoZ6s/edit?blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Disciplinary Guidelines</a></li>
                    <li><a href="privacypolicy.html" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Privacy Policy</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-xl font-semibold mb-4 text-gray-300">System Information</h4>
                <p class="text-gray-500 text-sm mb-2">Unauthorized Access Strictly Prohibited</p>
                <p class="text-gray-500 text-sm mb-2">For UPD Personnel Use Only</p>
                <p class="text-500 text-sm mb-2">Created and Maintained by FiveM "NightLife RP"</p>
                <p class="text-gray-500 text-sm">&copy; 2025 Unified Police Department Internal Systems.</p>
            </div>
        </div>
        <!-- Font Awesome for any potential internal icons (though less needed here) -->
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    </footer>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Settings</h3>
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-300 mb-2">Data Management</h4>
                <button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md w-full">
                    Clear All Local Data
                </button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="closeSettingsModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Close</button>
            </div>
        </div>
    </div>

    <!-- Modals for adding items (reused components) -->
    <!-- Modal for adding Evidence, Linked Reports, Tags -->
    <div id="addItemModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Item</h3>
            <input type="text" id="addItemInput" placeholder="Enter item name..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <div class="flex justify-end space-x-2">
                <button id="closeAddItemModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddItemBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Add</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for adding a Civilian -->
    <div id="addCivilianModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Civilian</h3>
            <input type="text" id="civilianNameInput" placeholder="Enter civilian's name..." class="w-full p-3 mb-2 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <select id="civilianRoleSelect" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="Victim">Victim</option>
                <option value="Witness">Witness</option>
                <option value="Caller">Caller</option>
                <option value="Informant">Informant</option>
            </select>
            <div class="flex justify-end space-x-2">
                <button id="closeAddCivilianModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddCivilianBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Add</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for adding a Vehicle -->
    <div id="addVehicleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Vehicle</h3>
            <input type="text" id="vehicleOwnerInput" placeholder="Enter owner's name..." class="w-full p-3 mb-2 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <input type="text" id="vehiclePlateInput" placeholder="Enter license plate..." class="w-full p-3 mb-2 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <input type="text" id="vehicleModelInput" placeholder="Enter make and model..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <label class="flex items-center space-x-2 text-gray-300 cursor-pointer mb-4">
                <input type="checkbox" id="vehicleImpoundedCheckbox" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-800 border-gray-600 rounded focus:ring-blue-500">
                <span>Was the vehicle impounded?</span>
            </label>
            <div class="flex justify-end space-x-2">
                <button id="closeAddVehicleModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddVehicleBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Add</button>
            </div>
        </div>
    </div>


    <!-- NEW: Modal for adding a Weapon -->
    <div id="addWeaponModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Weapon</h3>
            <input type="text" id="weaponTypeInput" placeholder="Enter weapon type (e.g., Pistol, Rifle)" class="w-full p-3 mb-2 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <input type="text" id="weaponModelInput" placeholder="Enter weapon model (e.g., M1911, M4A1)" class="w-full p-3 mb-2 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <input type="text" id="weaponSerialInput" placeholder="Enter serial number" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <!-- Checkboxes for Custom and F9 -->
            <div class="flex items-center justify-start space-x-8 mb-4">
                <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                    <input type="checkbox" id="weaponCustomCheckbox" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-800 border-gray-600 rounded focus:ring-blue-500">
                    <span>Custom</span>
                </label>
                <label class="flex items-center space-x-2 text-gray-300 cursor-pointer">
                    <input type="checkbox" id="weaponF9Checkbox" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-800 border-gray-600 rounded focus:ring-blue-500">
                    <span>F9</span>
                </label>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="closeAddWeaponModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddWeaponBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Add</button>
            </div>
        </div>
    </div>


    <!-- Modal for adding an Officer -->
    <div id="addOfficerModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Officer</h3>

            <!-- Officer Search Bar -->
            <input type="text" id="officer-search-input" placeholder="Search for an officer..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">

            <!-- Placeholder for a loading spinner -->
            <div id="officer-list-loading" class="flex justify-center items-center h-24 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
            <!-- The list of officers will be populated here -->
            <div id="officer-list-container" class="space-y-2 max-h-64 overflow-y-auto mb-4 p-2 bg-gray-700 rounded-md">
                <!-- Officers will be dynamically added here -->
            </div>
            <!-- Error message container -->
            <p id="officer-list-error" class="text-red-400 text-sm hidden">Failed to load officer data. Please ensure the sheet is published to the web and the link is correct.</p>
            <div class="flex justify-end space-x-2">
                <button id="closeAddOfficerModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddOfficerBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>Add Selected Officer</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding a Criminal -->
    <div id="addCriminalModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Criminal</h3>
            <input type="text" id="criminalNameInput" placeholder="Enter criminal's name..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <!-- NEW Fingerprint Input Field -->
            <input type="text" id="criminalFingerprintInput" placeholder="Enter fingerprint data (e.g., T4BXONYI1543425)..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <div class="flex justify-end space-x-2">
                <button id="closeAddCriminalModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddCriminalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Add</button>
            </div>
        </div>
    </div>

    <!-- UPDATED Modal for adding a Charge -->
    <div id="addChargeModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Add Charge</h3>
            <!-- Search Bar for Charges -->
            <input type="text" id="charge-search-input" placeholder="Search for a charge..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-colors duration-200">
            <!-- Placeholder for a loading spinner -->
            <div id="charge-list-loading" class="flex justify-center items-center h-24 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
            <!-- The list of charges will be populated here -->
            <div id="charge-list-container" class="space-y-2 max-h-64 overflow-y-auto mb-4 p-2 bg-gray-700 rounded-md">
                <!-- Charges will be dynamically added here -->
            </div>
            <!-- Error message container -->
            <p id="charge-list-error" class="text-red-400 text-sm hidden">Failed to load charge data. Please ensure the sheet is published to the web and the link is correct.</p>
            <div class="flex justify-end space-x-2">
                <button id="closeAddChargeModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="saveAddChargeBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>Add Selected Charge(s)</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete this report? This action cannot be undone.</p>
            <div class="flex justify-end space-x-2">
                <button id="cancelDeleteBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">Yes, Delete</button>
            </div>
        </div>
    </div>


    <!-- JavaScript for dynamic functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Hamburger menu functionality
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const navLinks = document.querySelector('.nav-links');

            hamburgerBtn.addEventListener('click', () => {
                navLinks.classList.toggle('show-menu');
            });

            // Settings Modal functionality
            const settingsIcon = document.getElementById('settingsIcon');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');

            settingsIcon.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeSettingsModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            // Reusable modal for adding general items (Evidence, Tags, etc.)
            const addItemModal = document.getElementById('addItemModal');
            const addItemInput = document.getElementById('addItemInput');
            const saveAddItemBtn = document.getElementById('saveAddItemBtn');
            const closeAddItemModalBtn = document.getElementById('closeAddItemModalBtn');
            let currentListId = null;

            // Loop through all buttons that have the .add-item-btn class
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.addEventListener('click', () => {
                    // Get the data attribute to know which list to add to
                    currentListId = button.dataset.listId;
                    addItemInput.value = '';
                    const h3Text = button.closest('div').querySelector('h3').textContent.trim();
                    document.querySelector('#addItemModal h3').textContent = `Add ${h3Text}`;
                    addItemInput.placeholder = `Enter new ${h3Text.toLowerCase()}...`;
                    addItemModal.classList.remove('hidden');
                    addItemInput.focus();
                });
            });

            closeAddItemModalBtn.addEventListener('click', () => {
                addItemModal.classList.add('hidden');
            });

            saveAddItemBtn.addEventListener('click', () => {
                const itemText = addItemInput.value.trim();
                if (itemText) {
                    const list = document.getElementById(currentListId);
                    // Check if there's a placeholder and remove it
                    if (list.firstElementChild && list.firstElementChild.textContent.includes('NO')) {
                        list.innerHTML = '';
                    }

                    const newItem = document.createElement('li');
                    newItem.className = "flex items-center space-x-2 p-2 border border-gray-700 rounded-md bg-gray-700 text-white";
                    newItem.innerHTML = `
                                            <input type="text" value="${itemText}" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                            <button class="remove-item-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs transition-colors duration-200">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            </button>
                                        `;
                    list.appendChild(newItem);

                    // Add event listener to the new remove button
                    newItem.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                        e.target.closest('li').remove();
                        if (list.children.length === 0) {
                            // Re-add placeholder if the list is empty
                            const placeholderText = list.closest('div').querySelector('h3').textContent.trim();
                            list.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO ${placeholderText.toUpperCase()}</li>`;
                        }
                    });

                    addItemModal.classList.add('hidden');
                }
            });

            // ===============================================
            // NEW: Add Vehicle Modal Functionality
            // ===============================================
            const addVehicleBtn = document.getElementById('add-vehicle-btn');
            const addVehicleModal = document.getElementById('addVehicleModal');
            const closeAddVehicleModalBtn = document.getElementById('closeAddVehicleModalBtn');
            const saveAddVehicleBtn = document.getElementById('saveAddVehicleBtn');
            const vehicleOwnerInput = document.getElementById('vehicleOwnerInput');
            const vehiclePlateInput = document.getElementById('vehiclePlateInput');
            const vehicleModelInput = document.getElementById('vehicleModelInput');
            const vehicleImpoundedCheckbox = document.getElementById('vehicleImpoundedCheckbox');
            const vehiclesList = document.getElementById('vehicles-list');

            addVehicleBtn.addEventListener('click', () => {
                vehicleOwnerInput.value = '';
                vehiclePlateInput.value = '';
                vehicleModelInput.value = '';
                vehicleImpoundedCheckbox.checked = false;
                addVehicleModal.classList.remove('hidden');
                vehicleOwnerInput.focus();
            });

            closeAddVehicleModalBtn.addEventListener('click', () => {
                addVehicleModal.classList.add('hidden');
            });

            saveAddVehicleBtn.addEventListener('click', () => {
                const owner = vehicleOwnerInput.value.trim();
                const plate = vehiclePlateInput.value.trim();
                const model = vehicleModelInput.value.trim();
                const impounded = vehicleImpoundedCheckbox.checked;

                if (owner || plate || model) {
                    if (vehiclesList.firstElementChild && vehiclesList.firstElementChild.textContent.includes('NO VEHICLES INVOLVED')) {
                        vehiclesList.innerHTML = '';
                    }

                    const newVehicleItem = document.createElement('li');
                    newVehicleItem.className = "flex flex-col space-y-1 p-2 border border-gray-700 rounded-md bg-gray-700 text-white";
                    newVehicleItem.innerHTML = `
                                        <div class="flex justify-between items-center w-full">
                                            <span class="font-bold text-base">${model || 'N/A'}</span>
                                            <button class="remove-item-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs transition-colors duration-200">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-300">Owner: ${owner || 'N/A'}</p>
                                        <p class="text-xs text-gray-300">Plate: ${plate || 'N/A'}</p>
                                        <p class="text-xs ${impounded ? 'text-yellow-400' : 'text-gray-500'}">Impounded</p>
                                    `;
                    vehiclesList.appendChild(newVehicleItem);

                    newVehicleItem.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                        e.target.closest('li').remove();
                        if (vehiclesList.children.length === 0) {
                            vehiclesList.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO VEHICLES INVOLVED</li>`;
                        }
                    });

                    addVehicleModal.classList.add('hidden');
                }
            });

            // ===============================================
            // NEW: Add Civilian Modal Functionality
            // ===============================================
            const addCivilianBtn = document.getElementById('add-civilian-btn');
            const addCivilianModal = document.getElementById('addCivilianModal');
            const closeAddCivilianModalBtn = document.getElementById('closeAddCivilianModalBtn');
            const saveAddCivilianBtn = document.getElementById('saveAddCivilianBtn');
            const civilianNameInput = document.getElementById('civilianNameInput');
            const civilianRoleSelect = document.getElementById('civilianRoleSelect');
            const civiliansList = document.getElementById('civilians-list');

            addCivilianBtn.addEventListener('click', () => {
                civilianNameInput.value = '';
                civilianRoleSelect.value = 'Victim';
                addCivilianModal.classList.remove('hidden');
                civilianNameInput.focus();
            });

            closeAddCivilianModalBtn.addEventListener('click', () => {
                addCivilianModal.classList.add('hidden');
            });

            saveAddCivilianBtn.addEventListener('click', () => {
                const name = civilianNameInput.value.trim();
                const role = civilianRoleSelect.value;

                if (name) {
                    if (civiliansList.firstElementChild && civiliansList.firstElementChild.textContent.includes('NO CIVILIANS INVOLVED')) {
                        civiliansList.innerHTML = '';
                    }

                    const newCivilianItem = document.createElement('li');
                    newCivilianItem.className = "flex justify-between items-center p-2 border border-gray-700 rounded-md bg-gray-700 text-white";
                    newCivilianItem.innerHTML = `
                                        <span>${name} - <span class="text-gray-400">${role}</span></span>
                                        <button class="remove-item-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs transition-colors duration-200">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        </button>
                                    `;
                    civiliansList.appendChild(newCivilianItem);

                    newCivilianItem.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                        e.target.closest('li').remove();
                        if (civiliansList.children.length === 0) {
                            civiliansList.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO CIVILIANS INVOLVED</li>`;
                        }
                    });

                    addCivilianModal.classList.add('hidden');
                }
            });


            // ===============================================
            // NEW: Add Weapon Modal Functionality
            // ===============================================
            const addWeaponBtn = document.getElementById('add-weapon-btn');
            const addWeaponModal = document.getElementById('addWeaponModal');
            const closeAddWeaponModalBtn = document.getElementById('closeAddWeaponModalBtn');
            const saveAddWeaponBtn = document.getElementById('saveAddWeaponBtn');
            const weaponTypeInput = document.getElementById('weaponTypeInput');
            const weaponModelInput = document.getElementById('weaponModelInput');
            const weaponSerialInput = document.getElementById('weaponSerialInput');
            const weaponCustomCheckbox = document.getElementById('weaponCustomCheckbox');
            const weaponF9Checkbox = document.getElementById('weaponF9Checkbox');
            const weaponsList = document.getElementById('weapons-list');
            const returnWeaponsDropdown = document.getElementById('return-weapons');

            // Function to check weapons and update the 'Can return weapons' dropdown
            function updateReturnWeaponStatus() {
                const weaponItems = weaponsList.querySelectorAll('li');
                let hasSpecialWeapon = false;

                if (weaponsList.firstElementChild && weaponsList.firstElementChild.textContent.includes('NO WEAPONS INVOLVED')) {
                    returnWeaponsDropdown.disabled = false;
                    return;
                }

                weaponItems.forEach(item => {
                    const customP = item.querySelector('p:nth-of-type(3)');
                    const f9P = item.querySelector('p:nth-of-type(4)');

                    if ((customP && customP.textContent === 'Custom' && customP.classList.contains('text-green-400')) ||
                        (f9P && f9P.textContent === 'F9' && f9P.classList.contains('text-green-400'))) {
                        hasSpecialWeapon = true;
                    }
                });

                if (hasSpecialWeapon) {
                    returnWeaponsDropdown.value = 'Yes';
                    returnWeaponsDropdown.disabled = true;
                } else {
                    returnWeaponsDropdown.disabled = false;
                }
            }


            addWeaponBtn.addEventListener('click', () => {
                // Clear inputs and show modal
                weaponTypeInput.value = '';
                weaponModelInput.value = '';
                weaponSerialInput.value = '';
                weaponCustomCheckbox.checked = false;
                weaponF9Checkbox.checked = false;
                addWeaponModal.classList.remove('hidden');
                weaponTypeInput.focus();
            });

            closeAddWeaponModalBtn.addEventListener('click', () => {
                addWeaponModal.classList.add('hidden');
            });

            saveAddWeaponBtn.addEventListener('click', () => {
                const type = weaponTypeInput.value.trim();
                const model = weaponModelInput.value.trim();
                const serial = weaponSerialInput.value.trim();
                const isCustom = weaponCustomCheckbox.checked;
                const isF9 = weaponF9Checkbox.checked;

                if (type || model || serial) { // Only add if at least one field has data
                    // Remove placeholder if it exists
                    if (weaponsList.firstElementChild && weaponsList.firstElementChild.textContent.includes('NO WEAPONS INVOLVED')) {
                        weaponsList.innerHTML = '';
                    }

                    const newWeaponItem = document.createElement('li');
                    newWeaponItem.className = "flex flex-col space-y-1 p-2 border border-gray-700 rounded-md bg-gray-700 text-white";
                    newWeaponItem.innerHTML = `
                                            <div class="flex justify-between items-center w-full">
                                                <span class="font-bold text-base">${type || 'N/A'}</span>
                                                <button class="remove-item-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs transition-colors duration-200">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-300">Model: ${model || 'N/A'}</p>
                                            <p class="text-xs text-gray-300">Serial: ${serial || 'N/A'}</p>
                                            <div class="flex space-x-4 mt-2">
                                                <p class="text-xs ${isCustom ? 'text-green-400' : 'text-gray-500'}">Custom</p>
                                                <p class="text-xs ${isF9 ? 'text-green-400' : 'text-gray-500'}">F9</p>
                                            </div>
                                        `;
                    weaponsList.appendChild(newWeaponItem);

                    // Add event listener to the new remove button
                    newWeaponItem.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                        e.target.closest('li').remove();
                        if (weaponsList.children.length === 0) {
                            weaponsList.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO WEAPONS INVOLVED</li>`;
                        }
                        updateReturnWeaponStatus(); // Check status after removing a weapon
                    });

                    addWeaponModal.classList.add('hidden');
                    updateReturnWeaponStatus(); // Check status after adding a weapon
                }
            });


            // ===============================================
            // Officer List Functionality for multiple selections and search
            // ===============================================
            const addOfficerBtn = document.getElementById('add-officer-btn');
            const addOfficerModal = document.getElementById('addOfficerModal');
            const officersList = document.getElementById('officers-list');
            const officerListContainer = document.getElementById('officer-list-container');
            const officerListLoading = document.getElementById('officer-list-loading');
            const officerListError = document.getElementById('officer-list-error');
            const saveAddOfficerBtn = document.getElementById('saveAddOfficerBtn');
            const closeAddOfficerModalBtn = document.getElementById('closeAddOfficerModalBtn');
            const officerSearchInput = document.getElementById('officer-search-input');

            // Configuration for all the Google Sheets
            const departments = {
                'upd': {
                    name: 'UPD',
                    // Published key for the UPD sheet
                    publishedKey: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                    gid: '0'
                },
                'lscso': {
                    name: 'LSCSO',
                    // Published key for the LSCSO sheet
                    publishedKey: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                    gid: '1747285908'
                },
                'lspd': {
                    name: 'LSPD',
                    // Published key for the State Police sheet
                    publishedKey: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                    gid: '394994291'
                },
                'fbi': {
                    name: 'FBI',
                    // Published key for the FBI sheet
                    publishedKey: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                    gid: '248128167'
                }
            };

            // Changed to an array to hold multiple selections
            let selectedOfficers = [];
            // Store the full list of all officers to enable search filtering
            let allOfficers = [];

            // Function to fetch and parse the Google Sheet data for all departments
            async function fetchAllOfficerData() {
                officerListContainer.innerHTML = '';
                officerListLoading.classList.remove('hidden');
                officerListError.classList.add('hidden');
                saveAddOfficerBtn.disabled = true;

                try {
                    // Fetch data for all four departments concurrently
                    const [updResponse, lscsoResponse, lspdResponse, fbiResponse] = await Promise.all([
                        fetch(`https://docs.google.com/spreadsheets/d/e/${departments['upd'].publishedKey}/pub?gid=${departments['upd'].gid}&single=true&output=csv`),
                        fetch(`https://docs.google.com/spreadsheets/d/e/${departments['lscso'].publishedKey}/pub?gid=${departments['lscso'].gid}&single=true&output=csv`),
                        fetch(`https://docs.google.com/spreadsheets/d/e/${departments['lspd'].publishedKey}/pub?gid=${departments['lspd'].gid}&single=true&output=csv`),
                        fetch(`https://docs.google.com/spreadsheets/d/e/${departments['fbi'].publishedKey}/pub?gid=${departments['fbi'].gid}&single=true&output=csv`)
                    ]);

                    if (!updResponse.ok || !lscsoResponse.ok || !lspdResponse.ok || !fbiResponse.ok) {
                        throw new Error('Failed to fetch data from one or more departments.');
                    }

                    const updCsvText = await updResponse.text();
                    const lscsoCsvText = await lscsoResponse.text();
                    const lspdCsvText = await lspdResponse.text();
                    const fbiCsvText = await fbiResponse.text();

                    const updOfficers = parseCSV(updCsvText, 'name');
                    const lscsoOfficers = parseCSV(lscsoCsvText, 'name');
                    const lspdOfficers = parseCSV(lspdCsvText, 'name');
                    const fbiOfficers = parseCSV(fbiCsvText, 'name');

                    // Combine all four lists and then use a Set to get unique names
                    let combinedOfficers = [...updOfficers, ...lscsoOfficers, ...lspdOfficers, ...fbiOfficers];
                    const uniqueOfficers = [...new Set(combinedOfficers)];
                    allOfficers = uniqueOfficers.sort(); // Sort the unique list

                    if (allOfficers.length > 0) {
                        populateOfficerList(allOfficers);
                        officerListError.classList.add('hidden');
                    } else {
                        officerListContainer.innerHTML = '<p class="text-center text-gray-400 p-4">No officers found in the specified sheets.</p>';
                        officerListError.classList.remove('hidden');
                    }

                } catch (error) {
                    console.error('Error fetching officer data:', error);
                    officerListError.classList.remove('hidden');
                    officerListContainer.innerHTML = '<p class="text-center text-red-400 p-4">Failed to load data. Please ensure the sheet is published to the web with the correct URL format.</p>';
                } finally {
                    officerListLoading.classList.add('hidden');
                }
            }

            // Function to parse the CSV and get all names from the correct column
            function parseCSV(csv, columnName) {
                const lines = csv.split('\n');
                const items = [];
                let columnIndex = -1;
                let dataStartIndex = -1;

                // Dynamically find the header row containing the specified column name
                for (let i = 0; i < lines.length && i < 15; i++) {
                    const headerLine = lines[i];
                    if (headerLine) {
                        const headers = headerLine.split(',').map(header => header.trim().replace(/^"|"$/g, ''));
                        const foundIndex = headers.findIndex(header => header.toLowerCase() === columnName);
                        if (foundIndex !== -1) {
                            columnIndex = foundIndex;
                            dataStartIndex = i + 1; // The data starts on the next line
                            break; // Stop searching once the header is found
                        }
                    }
                }

                if (columnIndex !== -1) {
                    for (let i = dataStartIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const columns = line.split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                            if (columns[columnIndex] && columns[columnIndex].length > 0) {
                                const item = columns[columnIndex];
                                // Check for valid data and skip headers or placeholders
                                if (item.toLowerCase() !== columnName && item.toLowerCase() !== "0" && item.length > 2) {
                                    items.push(item);
                                }
                            }
                        }
                    }
                }
                return items;
            }

            // Function to populate the modal with the list of officers
            function populateOfficerList(officersToDisplay) {
                officerListContainer.innerHTML = '';
                officersToDisplay.forEach(officerName => {
                    const officerElement = document.createElement('div');
                    officerElement.className = 'officer-item p-2 rounded-md cursor-pointer hover:bg-gray-600 transition-colors duration-200 border border-gray-700';
                    officerElement.textContent = officerName;

                    // Re-apply 'selected' class if this officer was previously selected
                    if (selectedOfficers.includes(officerName)) {
                        officerElement.classList.add('selected');
                    }

                    officerElement.addEventListener('click', () => {
                        officerElement.classList.toggle('selected');
                        if (officerElement.classList.contains('selected')) {
                            // Add to selected list
                            selectedOfficers.push(officerName);
                        } else {
                            // Remove from selected list
                            selectedOfficers = selectedOfficers.filter(name => name !== officerName);
                        }
                        // Enable/disable save button based on selection
                        saveAddOfficerBtn.disabled = selectedOfficers.length === 0;
                    });
                    officerListContainer.appendChild(officerElement);
                });
            }

            // Event listener for opening the officer modal
            addOfficerBtn.addEventListener('click', () => {
                addOfficerModal.classList.remove('hidden');
                // Fetch all data when the modal is first opened
                if (allOfficers.length === 0) {
                    fetchAllOfficerData();
                } else {
                    // If data is already fetched, just populate the list with all officers
                    populateOfficerList(allOfficers);
                }
            });

            // Event listener for the search bar
            officerSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredOfficers = allOfficers.filter(officer =>
                    officer.toLowerCase().includes(searchTerm)
                );
                populateOfficerList(filteredOfficers);
            });

            // Event listener for closing the officer modal
            closeAddOfficerModalBtn.addEventListener('click', () => {
                addOfficerModal.classList.add('hidden');
                // Reset search bar and filter
                officerSearchInput.value = '';
                populateOfficerList(allOfficers); // Reset the list
                // Do not clear selectedOfficers, so the user can re-open and see their selections
                saveAddOfficerBtn.disabled = selectedOfficers.length === 0;
            });

            // Event listener for saving the selected officers
            saveAddOfficerBtn.addEventListener('click', () => {
                if (selectedOfficers.length > 0) {
                    // Check if there's a placeholder and remove it
                    if (officersList.querySelector('li').textContent.includes('NO')) {
                        officersList.innerHTML = '';
                    }

                    // Loop through the array of selected officers and add each one
                    selectedOfficers.forEach(officer => {
                        const newItem = document.createElement('li');
                        newItem.className = "flex items-center space-x-2 p-2 border border-gray-700 rounded-md bg-gray-700 text-white";
                        newItem.innerHTML = `
                                                <input type="text" value="${officer}" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                                <button class="remove-item-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs transition-colors duration-200">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                </button>
                                            `;
                        officersList.appendChild(newItem);

                        // Add event listener to the new remove button
                        newItem.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                            e.target.closest('li').remove();
                            if (officersList.children.length === 0) {
                                // Re-add placeholder if the list is empty
                                officersList.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO OFFICERS INVOLVED</li>`;
                            }
                        });
                    });

                    addOfficerModal.classList.add('hidden');
                    selectedOfficers = []; // Clear selection for next time
                    saveAddOfficerBtn.disabled = true;
                }
            });

            // ===============================================
            // Criminals Involved section functionality (add and remove)
            // AND NEW CHARGE MODAL FUNCTIONALITY
            // ===============================================
            const addCriminalBtn = document.getElementById('add-criminal-btn');
            const addCriminalModal = document.getElementById('addCriminalModal');
            const closeAddCriminalModalBtn = document.getElementById('closeAddCriminalModalBtn');
            const saveAddCriminalBtn = document.getElementById('saveAddCriminalBtn');
            const criminalNameInput = document.getElementById('criminalNameInput');
            const criminalFingerprintInput = document.getElementById('criminalFingerprintInput'); // NEW fingerprint input
            const criminalsList = document.getElementById('criminals-list');

            // Charge Modal elements
            const addChargeModal = document.getElementById('addChargeModal');
            const closeAddChargeModalBtn = document.getElementById('closeAddChargeModalBtn');
            const saveAddChargeBtn = document.getElementById('saveAddChargeBtn');
            const chargeSearchInput = document.getElementById('charge-search-input');
            const chargeListContainer = document.getElementById('charge-list-container');
            const chargeListLoading = document.getElementById('charge-list-loading');
            const chargeListError = document.getElementById('charge-list-error');

            let currentChargesList = null; // To store a reference to the specific criminal's charges list
            let allCharges = [];
            let selectedCharges = [];

            // Charge List spreadsheet configuration
            const chargesSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSYcwC9pL7T2jDPO1erEsrKCtdqxROKmhcv1KzvcpdOAqRRcdkUedq04ge1sbFN-52MtgKAorKeMyOK/pub?gid=1243525972&single=true&output=csv';

            // Function to fetch and parse the charge list data
            async function fetchChargeData() {
                chargeListContainer.innerHTML = '';
                chargeListLoading.classList.remove('hidden');
                chargeListError.classList.add('hidden');
                saveAddChargeBtn.disabled = true;

                try {
                    const response = await fetch(chargesSheetUrl);
                    if (!response.ok) {
                        throw new Error('Failed to fetch charge data.');
                    }

                    const csvText = await response.text();
                    allCharges = parseChargeCSV(csvText);

                    if (allCharges.length > 0) {
                        populateChargeList(allCharges);
                        chargeListError.classList.add('hidden');
                    } else {
                        chargeListContainer.innerHTML = '<p class="text-center text-gray-400 p-4">No charges found in the spreadsheet.</p>';
                        chargeListError.classList.remove('hidden');
                    }

                } catch (error) {
                    console.error('Error fetching charge data:', error);
                    chargeListError.classList.remove('hidden');
                    chargeListContainer.innerHTML = '<p class="text-center text-red-400 p-4">Failed to load charge data. Please check the network connection and URL.</p>';
                } finally {
                    chargeListLoading.classList.add('hidden');
                }
            }

            // Function to parse the charge CSV and get title code and description
            function parseChargeCSV(csv) {
                const lines = csv.split('\n');
                const charges = [];
                let titleCodeIndex = -1;
                let descriptionIndex = -1;
                let dataStartIndex = -1;

                // Dynamically find the header row containing 'Title Code' and 'Charge Description'
                for (let i = 0; i < lines.length && i < 15; i++) {
                    const headerLine = lines[i];
                    if (headerLine) {
                        const headers = headerLine.split(',').map(header => header.trim().replace(/^"|"$/g, ''));
                        titleCodeIndex = headers.findIndex(header => header.toLowerCase() === 'title code');
                        descriptionIndex = headers.findIndex(header => header.toLowerCase() === 'charge description');
                        if (titleCodeIndex !== -1 && descriptionIndex !== -1) {
                            dataStartIndex = i + 1; // The data starts on the next line
                            break; // Stop searching once the header is found
                        }
                    }
                }

                if (titleCodeIndex !== -1 && descriptionIndex !== -1) {
                    for (let i = dataStartIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const columns = line.split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                            const titleCode = columns[titleCodeIndex];
                            const description = columns[descriptionIndex];

                            if (titleCode && description) {
                                // Create a combined string for display
                                const fullCharge = `${titleCode}: ${description}`;
                                charges.push(fullCharge);
                            }
                        }
                    }
                }
                return charges;
            }

            // Function to populate the modal with the list of charges
            function populateChargeList(chargesToDisplay) {
                chargeListContainer.innerHTML = '';
                chargesToDisplay.forEach(charge => {
                    const chargeElement = document.createElement('div');
                    chargeElement.className = 'charge-item p-2 rounded-md cursor-pointer hover:bg-gray-600 transition-colors duration-200 border border-gray-700';
                    chargeElement.textContent = charge;

                    if (selectedCharges.includes(charge)) {
                        chargeElement.classList.add('selected');
                    }

                    chargeElement.addEventListener('click', () => {
                        chargeElement.classList.toggle('selected');
                        if (chargeElement.classList.contains('selected')) {
                            selectedCharges.push(charge);
                        } else {
                            selectedCharges = selectedCharges.filter(name => name !== charge);
                        }
                        saveAddChargeBtn.disabled = selectedCharges.length === 0;
                    });
                    chargeListContainer.appendChild(chargeElement);
                });
            }

            addCriminalBtn.addEventListener('click', () => {
                criminalNameInput.value = '';
                criminalFingerprintInput.value = ''; // NEW: clear fingerprint input
                addCriminalModal.classList.remove('hidden');
                criminalNameInput.focus();
            });

            closeAddCriminalModalBtn.addEventListener('click', () => {
                addCriminalModal.classList.add('hidden');
            });

            saveAddCriminalBtn.addEventListener('click', () => {
                const criminalName = criminalNameInput.value.trim();
                const fingerprintId = criminalFingerprintInput.value.trim(); // NEW: get fingerprint value

                if (criminalName) {
                    if (criminalsList.querySelector('li').textContent.includes('NO')) {
                        criminalsList.innerHTML = '';
                    }

                    const newCriminalItem = document.createElement('li');
                    newCriminalItem.className = 'p-4 border border-gray-700 rounded-md bg-gray-800';
                    newCriminalItem.innerHTML = `
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="font-bold text-lg">${criminalName}</h4>
                                                <button class="remove-item-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs transition-colors duration-200">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                </button>
                                            </div>
                                            ${fingerprintId ? `<p class="text-sm text-gray-400 mb-2"><strong>Fingerprint:</strong> ${fingerprintId}</p>` : ''}
                                            <div class="mt-2 space-y-2">
                                                <h5 class="text-md font-semibold">Charges:</h5>
                                                <ul class="charges-list list-disc list-inside space-y-1 text-gray-400">
                                                    <li class="text-sm">No charges added yet.</li>
                                                </ul>
                                                <button class="add-charge-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-2 rounded-full transition-colors duration-200 mt-2">+ Add Charge</button>
                                            </div>
                                        `;
                    criminalsList.appendChild(newCriminalItem);

                    // Add event listener for the criminal's remove button
                    newCriminalItem.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                        e.target.closest('li').remove();
                        if (criminalsList.children.length === 0) {
                            criminalsList.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO CRIMINALS INVOLVED</li>`;
                        }
                    });

                    // Add event listener for the new "Add Charge" button
                    newCriminalItem.querySelector('.add-charge-btn').addEventListener('click', () => {
                        // Store a reference to this specific criminal's charges list
                        currentChargesList = newCriminalItem.querySelector('.charges-list');
                        addChargeModal.classList.remove('hidden');
                        if (allCharges.length === 0) {
                            fetchChargeData();
                        } else {
                            populateChargeList(allCharges);
                        }
                    });

                    addCriminalModal.classList.add('hidden');
                }
            });

            // "Add Charge" modal functionality
            closeAddChargeModalBtn.addEventListener('click', () => {
                addChargeModal.classList.add('hidden');
                // Reset selected charges
                selectedCharges = [];
                chargeSearchInput.value = '';
                // The list will be re-populated from allCharges when the modal is reopened
                saveAddChargeBtn.disabled = true;
            });

            // Event listener for the charge search bar
            chargeSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCharges = allCharges.filter(charge =>
                    charge.toLowerCase().includes(searchTerm)
                );
                populateChargeList(filteredCharges);
            });

            saveAddChargeBtn.addEventListener('click', () => {
                if (selectedCharges.length > 0 && currentChargesList) {
                    // Check for the placeholder and remove it
                    if (currentChargesList.querySelector('li').textContent.includes('No charges added yet.')) {
                        currentChargesList.innerHTML = '';
                    }

                    // Loop through selected charges and add them to the list
                    selectedCharges.forEach(chargeText => {
                        const newChargeItem = document.createElement('li');
                        newChargeItem.className = 'flex items-center justify-between text-sm';
                        newChargeItem.innerHTML = `
                                                <span>${chargeText}</span>
                                                <button class="remove-charge-btn text-red-400 hover:text-red-500 transition-colors duration-200">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                </button>
                                            `;
                        currentChargesList.appendChild(newChargeItem);

                        // Add event listener to the new remove charge button
                        newChargeItem.querySelector('.remove-charge-btn').addEventListener('click', (e) => {
                            e.target.closest('li').remove();
                            if (currentChargesList.children.length === 0) {
                                currentChargesList.innerHTML = `<li class="text-sm">No charges added yet.</li>`;
                            }
                        });
                    });

                    addChargeModal.classList.add('hidden');
                    // Reset selections for the next time the modal is opened
                    selectedCharges = [];
                    saveAddChargeBtn.disabled = true;
                }
            });

            // ===============================================
            // AI Report Generation Functionality
            // ===============================================
            const generateReportBtn = document.getElementById('generate-report-btn');
            const reportDescription = document.getElementById('report-description');
            const descriptionLoadingContainer = document.getElementById('description-loading-container');
            const caseTitle = document.getElementById('caseTitle');


            // Get references to the new report detail fields
            const postalLocation = document.getElementById('postal-location');
            const levelOfForce = document.getElementById('level-of-force');
            const medicalTreatment = document.getElementById('medical-treatment');
            const gsrTest = document.getElementById('gsr-test');
            const legalRepresentation = document.getElementById('legal-representation');
            const mirandized = document.getElementById('mirandized');
            const returnWeapons = document.getElementById('return-weapons');
            const plea = document.getElementById('plea');

            // Function to extract items from a simple list (Evidence, etc.), handling placeholders
            function getListItems(listId) {
                const list = document.getElementById(listId);
                const items = [];
                // Check if the placeholder exists. If so, return an empty array.
                if (list.firstElementChild && list.firstElementChild.textContent.includes('NO')) {
                    return items;
                }

                // Otherwise, get the text from each input field in the list
                list.querySelectorAll('li input').forEach(input => {
                    if (input.value.trim()) {
                        items.push(input.value.trim());
                    }
                });
                return items;
            }

            // NEW Function to extract weapon details
            function getWeaponData() {
                const weapons = [];
                const weaponList = document.getElementById('weapons-list');
                if (weaponList.firstElementChild && weaponList.firstElementChild.textContent.includes('NO WEAPONS INVOLVED')) {
                    return weapons;
                }

                weaponList.querySelectorAll('li').forEach(weaponItem => {
                    const type = weaponItem.querySelector('span').textContent.trim();
                    const model = weaponItem.querySelector('p:nth-of-type(1)').textContent.replace('Model: ', '').trim();
                    const serial = weaponItem.querySelector('p:nth-of-type(2)').textContent.replace('Serial: ', '').trim();
                    const isCustom = weaponItem.querySelector('div:last-child p:first-child').classList.contains('text-green-400');
                    const isF9 = weaponItem.querySelector('div:last-child p:last-child').classList.contains('text-green-400');
                    weapons.push({ type, model, serial, isCustom, isF9 });
                });
                return weapons;
            }

            // NEW Function to extract vehicle details
            function getVehicleData() {
                const vehicles = [];
                const vehicleList = document.getElementById('vehicles-list');
                if (vehicleList.firstElementChild && vehicleList.firstElementChild.textContent.includes('NO VEHICLES INVOLVED')) {
                    return vehicles;
                }

                vehicleList.querySelectorAll('li').forEach(vehicleItem => {
                    const model = vehicleItem.querySelector('span').textContent.trim();
                    const owner = vehicleItem.querySelector('p:nth-of-type(1)').textContent.replace('Owner: ', '').trim();
                    const plate = vehicleItem.querySelector('p:nth-of-type(2)').textContent.replace('Plate: ', '').trim();
                    const impounded = vehicleItem.querySelector('p:nth-of-type(3)').classList.contains('text-yellow-400');
                    vehicles.push({ model, owner, plate, impounded });
                });
                return vehicles;
            }

            // NEW function to get civilian data
            function getCivilianData() {
                const civilians = [];
                const civilianList = document.getElementById('civilians-list');
                if (civilianList.firstElementChild && civilianList.firstElementChild.textContent.includes('NO CIVILIANS INVOLVED')) {
                    return civilians;
                }
                civilianList.querySelectorAll('li').forEach(item => {
                    const text = item.querySelector('span').textContent;
                    const [name, role] = text.split(' - ');
                    civilians.push({ name: name.trim(), role: role.trim() });
                });
                return civilians;
            }


            // Function to extract criminal data and their charges
            function getCriminalData() {
                const criminals = [];
                const criminalList = document.getElementById('criminals-list');
                // Check if the placeholder exists. If so, return an empty array.
                if (criminalList.firstElementChild && criminalList.firstElementChild.textContent.includes('NO')) {
                    return criminals;
                }

                // Iterate over each criminal's list item
                criminalList.querySelectorAll('li').forEach(criminalItem => {
                    const nameElement = criminalItem.querySelector('h4');
                    const fingerprintElement = criminalItem.querySelector('p strong');
                    const chargesListElement = criminalItem.querySelector('.charges-list');

                    if (nameElement) {
                        const name = nameElement.textContent.trim();
                        const fingerprint = fingerprintElement ? fingerprintElement.nextSibling.textContent.trim() : 'N/A';

                        const charges = [];
                        if (chargesListElement && !chargesListElement.firstElementChild.textContent.includes('No charges added yet.')) {
                            chargesListElement.querySelectorAll('li span').forEach(chargeSpan => {
                                charges.push(chargeSpan.textContent.trim());
                            });
                        }

                        criminals.push({ name, fingerprint, charges });
                    }
                });
                return criminals;
            }

            // Helper function for exponential backoff
            const exponentialBackoff = async (fn, retries = 5, delay = 1000) => {
                try {
                    return await fn();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return exponentialBackoff(fn, retries - 1, delay * 2);
                    } else {
                        throw error;
                    }
                }
            };

            generateReportBtn.addEventListener('click', async () => {
                // Show loading spinner and hide textarea
                reportDescription.classList.add('hidden');
                descriptionLoadingContainer.classList.remove('hidden');

                try {
                    // Gather all data from the report form
                    const evidence = getListItems('evidence-list');
                    const linkedReports = getListItems('linked-reports-list');
                    const evidenceLockerNumbers = getListItems('evidence-locker-list');
                    const tags = getListItems('tags-list');
                    const weapons = getWeaponData();
                    const vehicles = getVehicleData();
                    const civilians = getCivilianData();
                    const officers = getListItems('officers-list');
                    const criminals = getCriminalData();

                    // Update Case Title based on criminal data
                    if (criminals.length === 0) {
                        caseTitle.textContent = 'New Case';
                    } else if (criminals.length === 1) {
                        const suspect = criminals[0];
                        if (suspect.charges.length === 1) {
                            const chargeText = (suspect.charges[0].split(': ')[1] || suspect.charges[0]).trim();
                            caseTitle.textContent = `${suspect.name} - ${chargeText}`;
                        } else if (suspect.charges.length > 1) {
                            caseTitle.textContent = `${suspect.name} - Multiple`;
                        } else {
                            caseTitle.textContent = suspect.name;
                        }
                    } else {
                        caseTitle.textContent = 'Multiple Suspects';
                    }


                    // Get values from the new report detail fields
                    const postal = postalLocation.value.trim() || 'N/A';
                    const forceLevel = levelOfForce.value;
                    const medical = medicalTreatment.value;
                    const gsr = gsrTest.value;
                    const legal = legalRepresentation.value;
                    const miranda = mirandized.value;
                    const returnW = returnWeapons.value;
                    const criminalPlea = plea.value;

                    // Determine the perspective for the AI prompt
                    let officerName = 'an experienced police officer';
                    if (officers.length > 0) {
                        officerName = officers[0];
                    }

                    // Format weapons data for the prompt
                    const weaponsText = weapons.length > 0
                        ? weapons.map(w => `Type: ${w.type}, Model: ${w.model}, Serial: ${w.serial}, Custom: ${w.isCustom ? 'Yes' : 'No'}, F9: ${w.isF9 ? 'Yes' : 'No'}`).join('\n')
                        : 'None';

                    // Format vehicle data for the prompt
                    const vehiclesText = vehicles.length > 0
                        ? vehicles.map(v => `Model: ${v.model}, Owner: ${v.owner}, Plate: ${v.plate}, Impounded: ${v.impounded ? 'Yes' : 'No'}`).join('\n')
                        : 'None';

                    // Format civilian data for the prompt
                    const civiliansText = civilians.length > 0
                        ? civilians.map(c => `Name: ${c.name}, Role: ${c.role}`).join('\n')
                        : 'None';

                    // Create a simple string of all charges for the AI prompt
                    const allChargesText = criminals.flatMap(c => c.charges).join(', ');

                    // Create the detailed prompt for the Gemini API
                    const prompt = `
                                        You are ${officerName}, an officer tasked with writing a formal police report.
                                        Please fill out the following template using the provided data.
                                        Write a concise and professional summary for the 'Debrief' section.
                                        For the 'Justification of Charges' section, explain why the charges were given based on the provided list of charges.

                                        Debrief:
                                        Justification of Charges:
                                        Postal/Location: ${postal}
                                        Evidence/Items Seized: ${evidence.length > 0 ? evidence.join(', ') : 'None'}
                                        Evidence Locker Number(s): ${evidenceLockerNumbers.length > 0 ? evidenceLockerNumbers.join(', ') : 'None'}
                                        Level of Force: ${forceLevel}
                                        Medical Treatment (Y | N): ${medical}
                                        GSR Test (positive | negative): ${gsr}
                                        Legal Representation: ${legal}
                                        Mirandized (Y | N): ${miranda}
                                        Can return weapons (Y | N): ${returnW}
                                        Plea (guilty | not guilty | no contest): ${criminalPlea}

                                        Additional Data for context:
                                        - **Linked Reports:** ${linkedReports.length > 0 ? linkedReports.join(', ') : 'None'}
                                        - **Tags:** ${tags.length > 0 ? tags.join(', ') : 'None'}
                                        - **Weapons Involved:**
                                        ${weaponsText}
                                        - **Vehicles Involved:**
                                        ${vehiclesText}
                                        - **Civilians Involved:**
                                        ${civiliansText}
                                        - **Officers Involved:** ${officers.length > 0 ? officers.join(', ') : 'None'}
                                        - **Criminals Involved:**
                                        ${criminals.length > 0 ? criminals.map(c => `  - Name: ${c.name}, Fingerprint: ${c.fingerprint}, Charges: ${c.charges.length > 0 ? c.charges.join(', ') : 'None'}`).join('\n') : 'None'}

                                        - **All Charges:** ${allChargesText || 'None'}

                                        Do not add any additional fields or information that is not requested.
                                        `;

                    // API call to the Gemini 2.5 Flash model
                    const callGeminiApi = async () => {
                        const chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Unexpected API response structure.');
                        }
                    };

                    const generatedReport = await exponentialBackoff(callGeminiApi);

                    // Place the generated text into the textarea
                    reportDescription.value = generatedReport;
                    reportDescription.classList.remove('hidden');

                } catch (error) {
                    console.error('Error generating report:', error);
                    reportDescription.value = `Error generating report: ${error.message}`;
                    reportDescription.classList.remove('hidden');
                } finally {
                    // Hide loading spinner
                    descriptionLoadingContainer.classList.add('hidden');
                }
            });

            // ===============================================
            // Local Storage Functionality
            // ===============================================

            const reportFieldsToSave = [
                'caseTitle', 'report-description', 'postal-location', 'level-of-force',
                'medical-treatment', 'gsr-test', 'legal-representation',
                'mirandized', 'return-weapons', 'plea'
            ];

            const reportListsToSave = [
                'evidence-list', 'linked-reports-list', 'evidence-locker-list',
                'tags-list', 'weapons-list', 'vehicles-list', 'civilians-list',
                'officers-list', 'criminals-list'
            ];

            function saveReportData() {
                const data = {};
                // Save fields
                reportFieldsToSave.forEach(id => {
                    const element = document.getElementById(id);
                    if (element.tagName === 'H1') {
                        data[id] = element.textContent;
                    } else {
                        data[id] = element.value;
                    }
                });
                // Save lists
                reportListsToSave.forEach(id => {
                    data[id] = document.getElementById(id).innerHTML;
                });

                localStorage.setItem('policeReportData', JSON.stringify(data));
            }

            function loadReportData() {
                const savedData = localStorage.getItem('policeReportData');
                if (savedData) {
                    const data = JSON.parse(savedData);

                    // Load fields
                    reportFieldsToSave.forEach(id => {
                        if (data[id]) {
                            const element = document.getElementById(id);
                            if (element.tagName === 'H1') {
                                element.textContent = data[id];
                            } else {
                                element.value = data[id];
                            }
                        }
                    });

                    // Load lists
                    reportListsToSave.forEach(id => {
                        if (data[id]) {
                            const listElement = document.getElementById(id);
                            listElement.innerHTML = data[id];
                            reAttachListEventListeners(listElement);
                        }
                    });

                    updateReturnWeaponStatus();
                }
            }

            function reAttachListEventListeners(listElement) {
                // Re-attach remove buttons for simple lists
                listElement.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const listItem = e.target.closest('li');
                        const list = listItem.parentElement;
                        listItem.remove();
                        if (list.children.length === 0) {
                            const placeholderText = list.closest('div').querySelector('h3').textContent.trim();
                            list.innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO ${placeholderText.toUpperCase()}</li>`;
                        }
                        if (list.id === 'weapons-list') {
                            updateReturnWeaponStatus();
                        }
                    });
                });

                // Re-attach event listeners specific to the criminals list
                if (listElement.id === 'criminals-list') {
                    listElement.querySelectorAll('.add-charge-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            currentChargesList = button.closest('li').querySelector('.charges-list');
                            addChargeModal.classList.remove('hidden');
                            if (allCharges.length === 0) {
                                fetchChargeData();
                            } else {
                                populateChargeList(allCharges);
                            }
                        });
                    });
                    listElement.querySelectorAll('.remove-charge-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const chargeItem = e.target.closest('li');
                            const chargesList = chargeItem.parentElement;
                            chargeItem.remove();
                            if (chargesList.children.length === 0) {
                                chargesList.innerHTML = `<li class="text-sm">No charges added yet.</li>`;
                            }
                        });
                    });
                }
            }


            function clearReportData() {
                localStorage.removeItem('policeReportData');
            }

            // Load data on page load
            loadReportData();

            // Save data before leaving the page
            window.addEventListener('beforeunload', saveReportData);


            // ===============================================
            // Delete Button and Confirmation Modal Functionality
            // ===============================================
            const deleteBtn = document.getElementById('deleteBtn');
            const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            // Event listener to show the confirmation modal when the delete button is clicked
            deleteBtn.addEventListener('click', () => {
                deleteConfirmationModal.classList.remove('hidden');
            });

            // Event listener to close the confirmation modal when the cancel button is clicked
            cancelDeleteBtn.addEventListener('click', () => {
                deleteConfirmationModal.classList.add('hidden');
            });

            // Event listener for the final deletion action
            confirmDeleteBtn.addEventListener('click', () => {
                // Here you would add the logic to actually delete the report.
                // For this example, we'll just log a message and reset the form.
                console.log("Report deleted.");

                clearReportData(); // Clear from local storage

                // Close the modal
                deleteConfirmationModal.classList.add('hidden');

                // Reset the form to a "new case" state
                document.getElementById('caseTitle').textContent = 'New Case';
                document.getElementById('report-description').value = '';

                // Reset the new fields
                postalLocation.value = '';
                levelOfForce.value = 'None';
                medicalTreatment.value = 'No';
                gsrTest.value = 'Not Applicable';
                legalRepresentation.value = 'No';
                mirandized.value = 'No';
                returnWeapons.value = 'No';
                returnWeapons.disabled = false; // Re-enable the dropdown
                plea.value = 'Not Applicable';

                // Reset all the lists to their initial placeholder states
                document.getElementById('evidence-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO ATTACHED EVIDENCE</li>`;
                document.getElementById('linked-reports-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO LINKED REPORTS</li>`;
                document.getElementById('evidence-locker-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO EVIDENCE LOCKER NUMBERS</li>`;
                document.getElementById('tags-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO TAGS</li>`;
                document.getElementById('weapons-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO WEAPONS INVOLVED</li>`;
                document.getElementById('vehicles-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO VEHICLES INVOLVED</li>`;
                document.getElementById('civilians-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO CIVILIANS INVOLVED</li>`;
                document.getElementById('officers-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO OFFICERS INVOLVED</li>`;
                document.getElementById('criminals-list').innerHTML = `<li class="p-2 border border-gray-700 rounded-md">NO CRIMINALS INVOLVED</li>`;
            });
        });
    </script>
</body>
</html>
