<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport meta tag is crucial for responsive behavior across devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Report Generator</title>
    <!-- Favicon link updated with a fallback URL for robustness -->
    <link rel="icon" type="image/png" href="LSPD.png" onerror="this.href='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
    <!-- Tailwind CSS CDN - provides responsive utility classes out of the box -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8; /* Light gray background */
            color: #333; /* Dark gray text */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
    </style>
</head>
<body class="antialiased">
    <!-- Header Section -->
    <header class="bg-blue-900 text-white shadow-lg py-4 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50 rounded-b-lg relative">
        <div class="flex items-center">
            <!-- LSPD Logo -->
            <img src="LSPD.png" alt="LSPD Logo" class="mr-4 w-16 h-16 object-contain" onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
            <!-- Responsive font size: text-2xl for small screens, text-3xl for medium screens and up -->
            <h1 class="text-2xl md:text-3xl font-bold">Los Santos Police Department</h1>
        </div>

        <!-- Hamburger Menu Button for Mobile -->
        <button id="hamburgerBtn" class="hamburger-menu text-white focus:outline-none md:hidden">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h4"></path>
            </svg>
        </button>

        <!-- Navigation Menu -->
        <!-- Added md:flex-grow to nav to allow it to take available space -->
        <nav class="nav-links md:flex md:flex-grow md:justify-end">
            <!-- Changed md:space-x-8 to md:space-x-4 and added md:flex-wrap for stacking -->
            <ul class="flex flex-col md:flex-row md:flex-wrap md:justify-end space-y-2 md:space-y-0 md:space-x-4 text-sm font-medium">
                <li><a href="index.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700 current-page">Dashboard</a></li>
                <li><a href="SOP.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">SOPs</a></li>
                <li><a href="training.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Training</a></li>
                <li><a href="forms.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Forms</a></li>
                <li><a href="roster.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Roster</a></li>
                <li><a href="hr.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">HR Info</a></li>
                <li><a href="report.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Report Generator</a></li>
                <li><a href="charges.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Charge Calculator</a></li>
                <li><a href="info.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Common Information</a></li>
            </ul>
        </nav>
    </header>
    <!-- Main Content Section -->
    <main class="w-full px-4 md:px-8 py-12 flex justify-center items-start">
        <!-- Police Report Generator Section -->
        <section class="bg-blue-50 p-8 rounded-lg shadow-inner w-full">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Police Report Generator</h2>
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full">

                <!-- Department Dropdown -->
                <div class="mb-6">
                    <label for="department" class="block text-gray-700 text-sm font-semibold mb-2">
                        Department
                    </label>
                    <select id="department"
                            name="department"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="LSPD">Los Santos Police Department</option>
                        <option value="LSCSO">Los Santos County Sheriff's Office</option>
                    </select>
                </div>

                <!-- Text Box 1: Officer Name and Badge Number -->
                <div class="mb-6">
                    <label for="officerInfo" class="block text-gray-700 text-sm font-semibold mb-2">
                        Officer Name and Badge Number
                    </label>
                    <input type="text"
                           id="officerInfo"
                           name="officerInfo"
                           placeholder="Enter officer name and badge number"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 text-gray-800">
                </div>

                <!-- Text Box 2: Suspect First and Last Name -->
                <div class="mb-6">
                    <label for="suspectName" class="block text-gray-700 text-sm font-semibold mb-2">
                        Suspect First and Last Name
                    </label>
                    <input type="text"
                           id="suspectName"
                           name="suspectName"
                           placeholder="Enter suspect's first and last name"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 text-gray-800">
                </div>

                <!-- Text Box 3: Charges -->
                <div class="mb-6">
                    <label for="charges" class="block text-gray-700 text-sm font-semibold mb-2">
                        Charges
                    </label>
                    <input type="text"
                           id="charges"
                           name="charges"
                           placeholder="Enter charges (e.g., Theft, Assault)"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 text-gray-800">
                </div>

                <!-- Mirandized Dropdown -->
                <div class="mb-6">
                    <label for="mirandized" class="block text-gray-700 text-sm font-semibold mb-2">
                        Mirandized (Required)
                    </label>
                    <select id="mirandized"
                            name="mirandized"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="">Select an option</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <!-- GSR Test Dropdown -->
                <div class="mb-6">
                    <label for="gsrTest" class="block text-gray-700 text-sm font-semibold mb-2">
                        GSR Test (Required)
                    </label>
                    <select id="gsrTest"
                            name="gsrTest"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="">Select an option</option>
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>

                <!-- Name of Legal Representation -->
                <div class="mb-6">
                    <label for="legalRepresentation" class="block text-gray-700 text-sm font-semibold mb-2">
                        Name of Legal Representation (leave blank if none present)
                    </label>
                    <input type="text"
                           id="legalRepresentation"
                           name="legalRepresentation"
                           placeholder="Enter legal representation name"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 text-gray-800">
                </div>

                <!-- Items Seized -->
                <div class="mb-6">
                    <label for="itemsSeized" class="block text-gray-700 text-sm font-semibold mb-2">
                        Items Seized
                    </label>
                    <textarea id="itemsSeized"
                              name="itemsSeized"
                              rows="3"
                              placeholder="List any items seized (e.g., Weapon, Contraband)"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400 text-gray-800"></textarea>
                </div>

                <!-- Level of Force Dropdown -->
                <div class="mb-6">
                    <label for="levelOfForce" class="block text-gray-700 text-sm font-semibold mb-2">
                        Level of Force
                    </label>
                    <select id="levelOfForce"
                            name="levelOfForce"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="">Select Level of Force</option>
                        <option value="Level 1 Officer Presence">A) Level 1 Officer Presence — No force is used. Considered the best way to resolve a situation.</option>
                        <option value="Level 2 Verbalization">B) Level 2 Verbalization — Force is not-physical.</option>
                        <option value="Level 3 Empty-Hand Control">C) Level 3 Empty-Hand Control — Officers use bodily force to gain control of a situation.</option>
                        <option value="Level 4 Less-Lethal Methods">D) Level 4 Less-Lethal Methods — Officers use less-lethal technologies to gain control of a situation.</option>
                        <option value="Level 5 Lethal Force">E) Level 5 Lethal Force — Officers use lethal weapons to gain control of a situation. It should only be used if a suspect poses a serious threat to the officer or another individual.</option>
                    </select>
                </div>

                <!-- Medical Treatment Dropdown -->
                <div class="mb-6">
                    <label for="medicalTreatment" class="block text-gray-700 text-sm font-semibold mb-2">
                        Medical Treatment
                    </label>
                    <select id="medicalTreatment"
                            name="medicalTreatment"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="">Select an option</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <!-- Weapons Seized -->
                <div class="mb-6">
                    <label for="weaponsSeized" class="block text-gray-700 text-sm font-semibold mb-2">
                        Weapons Seized
                    </label>
                    <input type="text"
                           id="weaponsSeized"
                           name="weaponsSeized"
                           placeholder="List any weapons seized"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 text-gray-800">
                </div>

                <!-- Are Weapons Returnable Dropdown -->
                <div class="mb-6">
                    <label for="weaponsReturnable" class="block text-gray-700 text-sm font-semibold mb-2">
                        Are weapons returnable?
                    </label>
                    <select id="weaponsReturnable"
                            name="weaponsReturnable"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="">Select an option</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>

                <!-- Plea Type Dropdown -->
                <div class="mb-6">
                    <label for="pleaType" class="block text-gray-700 text-sm font-semibold mb-2">
                        Plea Type:
                    </label>
                    <select id="pleaType"
                            name="pleaType"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm text-gray-800">
                        <option value="">Select Plea Type</option>
                        <option value="guilty">Guilty</option>
                        <option value="not guilty">Not Guilty</option>
                        <option value="no contest">No Contest</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>

                <!-- Text Area: Officer Narrative -->
                <div class="mb-6">
                    <label for="narrative" class="block text-gray-700 text-sm font-semibold mb-2">
                        Officer Narrative
                    </label>
                    <textarea id="narrative"
                              name="narrative"
                              rows="5"
                              placeholder="Enter officer narrative here..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400 text-gray-800"></textarea>
                </div>

                <!-- Text Area: Generated Report -->
                <div class="mb-6 relative">
                    <label for="generatedReport" class="block text-gray-700 text-sm font-semibold mb-2">
                        Generated Report
                    </label>
                    <button type="button"
                            id="copyReportBtn"
                            class="absolute top-0 right-0 mt-2 mr-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition duration-200 ease-in-out hidden"
                            title="Copy report to clipboard">
                        Copy Report
                    </button>
                    <textarea id="generatedReport"
                              name="generatedReport"
                              rows="10"
                              readonly
                              placeholder="Your generated report will appear here..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y text-gray-800 pt-10"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="mt-8">
                    <button type="button"
                            id="generateReportBtn"
                            class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out shadow-md">
                        Generate Report
                    </button>
                </div>

                <!-- Loading Indicator for AI Generation -->
                <div id="loadingIndicator" class="hidden text-center text-blue-600 mt-4 font-semibold">
                    Generating report... Please wait.
                </div>
            </div>
        </section>
    </main>

    <!-- Footer Section - Internal Contacts -->
    <!-- Grid layout that changes columns based on screen size: 1 column on small, 3 on medium screens and up -->
    <footer class="bg-gray-800 text-white py-10 px-6 md:px-12 rounded-t-lg">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Internal Contact Info (content removed, titles remain) -->
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">Internal Contacts</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://discord.gg/7FwxdpfDTM" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Discord</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1383775099777318972" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Chat</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1383782578976456735" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Cadet Support</a></li>
                </ul>
            </div>
            <!-- Internal Quick Links (text links added) -->
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">Quick Access</h4>
                <ul class="space-y-2 text-sm">
                    <!-- Added text-sm here -->
                    <li><a href="https://docs.google.com/document/d/1etjilZ1dAHGviw33MV5Zs-b5dXqcSHyoYIHvHiRIyy4/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">LSPD SOP</a></li>
                    <li><a href="https://docs.google.com/document/d/1hKQ4fw9b1_yQELhPi1p1b4M6uiSaYb7bBp-9C6GVTdY/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Los Santos Police Department Interview Procedure & Questions</a></li>
                    <li><a href="https://docs.google.com/document/d/1d004FfAhZBgESn88Mx21N3CGqXlcoNeP9_sadn_ePak/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Promotional Pathway & Subdivision Assignment Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/14QIEsYMWpTssti1xGbGWiMxQ2b0jbiYxuMmvV8XWUUo/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Highway Enforcement and Apprehension Team (HEAT) Activation Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/1Ggf7SS5voiIjr3iSLB3VtAc47JN3aDjm2J_gYnpoZ6s/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Disciplinary Guidelines</a></li>
                    <li><a href="https://nlspd.net/" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">LSPD Website</a></li>
                </ul>
            </div>
            <!-- Copyright & Internal System Info (content removed, titles remain) -->
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">System Information</h4>
                <p class="text-gray-500 text-sm mb-2">Unauthorized Access Strictly Prohibited</p>
                <p class="text-gray-500 text-sm mb-2">For LSPD Personnel Use Only</p>
                <p class="text-500 text-sm mb-2">Created and Maintained by FiveM "NightLife RP"</p>
                <p class="text-gray-500 text-sm">&copy; 2025 Los Santos Police Department Internal Systems.</p>
            </div>
        </div>
        <!-- Font Awesome for any potential internal icons (though less needed here) -->
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    </footer>

    <script>
        // Get references to elements
        const departmentSelect = document.getElementById('department');
        const officerInfoInput = document.getElementById('officerInfo');
        const suspectNameInput = document.getElementById('suspectName');
        const chargesInput = document.getElementById('charges');
        const narrativeTextarea = document.getElementById('narrative');
        const mirandizedSelect = document.getElementById('mirandized');
        const gsrTestSelect = document.getElementById('gsrTest');
        const legalRepresentationInput = document.getElementById('legalRepresentation');
        const itemsSeizedTextarea = document.getElementById('itemsSeized');
        const levelOfForceSelect = document.getElementById('levelOfForce');
        const medicalTreatmentSelect = document.getElementById('medicalTreatment');
        const weaponsSeizedInput = document.getElementById('weaponsSeized');
        const weaponsReturnableSelect = document.getElementById('weaponsReturnable');
        const pleaTypeSelect = document.getElementById('pleaType');


        const generatedReportTextarea = document.getElementById('generatedReport');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // IMPORTANT: Gemini API Key Configuration
        // If you are running this code on YOUR OWN WEB SERVER:
        // 1. Go to Google AI Studio (https://aistudio.google.com/app/apikey) or Google Cloud.
        // 2. Generate a new API key.
        // 3. Replace the empty string below with your ACTUAL, VALID API key.
        //    Example: const apiKey = "YOUR_ACTUAL_GEMINI_API_KEY_HERE";
        // If you are running this within the Google Canvas environment, leave this as "".
        const apiKey = "AIzaSyCsWMWfmCfR59mcAy4as7XR95YY__7hayc";

        // Add event listener to the "Generate Report" button
        generateReportBtn.addEventListener('click', async () => {
            // Get values from input fields
            const department = departmentSelect.value;
            const officerInfo = officerInfoInput.value.trim();
            const suspectName = suspectNameInput.value.trim();
            const charges = chargesInput.value.trim();
            const narrative = narrativeTextarea.value.trim();
            const mirandized = mirandizedSelect.value;
            const gsrTest = gsrTestSelect.value;
            const legalRepresentation = legalRepresentationInput.value.trim();
            const itemsSeized = itemsSeizedTextarea.value.trim();
            const levelOfForce = levelOfForceSelect.value;
            const medicalTreatment = medicalTreatmentSelect.value;
            const weaponsSeized = weaponsSeizedInput.value.trim();
            const weaponsReturnable = weaponsReturnableSelect.value;
            const pleaType = pleaTypeSelect.value;

            // Get current local date, time, and timezone
            const now = new Date();
            const localDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const localTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;


            // Clear previous generated report value and ensure it's truly empty
            generatedReportTextarea.value = '';
            copyReportBtn.classList.add('hidden'); // Hide copy button initially or on new generation
            loadingIndicator.classList.remove('hidden');

            // Basic validation for required fields
            if (!officerInfo || !suspectName || !charges || !narrative || mirandized === "" || gsrTest === "" || medicalTreatment === "" || weaponsReturnable === "" || pleaType === "" || levelOfForce === "") {
                generatedReportTextarea.value = 'Please fill in all required fields (Department, Officer Info, Suspect Name, Charges, Officer Narrative, Mirandized, GSR Test, Level of Force, Medical Treatment, Weapons Returnable, Plea Type) to generate the report.';
                loadingIndicator.classList.add('hidden');
                return;
            }

            // Determine which API key to use
            // If running in the Canvas environment, __api_key__ will be automatically provided.
            // Otherwise, it falls back to the 'apiKey' variable defined above (which you need to set on your server).
            const finalApiKey = typeof __api_key__ !== 'undefined' ? __api_key__ : apiKey;

            // --- Debugging aid: Log the API key being used ---
            console.log('Using API Key (first 5 chars):', finalApiKey.substring(0, 5) + '...');
            // --- End debugging aid ---

            // Check if the API key is genuinely missing or still the placeholder
            if (!finalApiKey || finalApiKey === "YOUR_ACTUAL_GEMINI_API_KEY_HERE") {
                generatedReportTextarea.value = 'Error: Gemini API Key is not configured. Please ensure your API key is correctly set in the JavaScript code. If running on your own server, replace the empty string for `apiKey` with your actual key.';
                console.error('API Key not configured. Please set your actual Gemini API key if running on your own server.');
                loadingIndicator.classList.add('hidden');
                return;
            }

            try {
                let chatHistory = [];
                // Construct a detailed prompt for the Gemini API, including all new fields
                const prompt = `${localDate}, ${localTime} ${timeZone}

Officer: ${officerInfo} ${department}
City/State: Los Santos, San Andreas (SA)

Generate a detailed, professional, and concise police report. The report must strictly adhere to the information provided in the "Officer Narrative" and other text fields. Do not include any information that is not directly deducible from the provided inputs. The output must strictly follow the format provided below, with no additional text, introductory phrases, or markdown formatting (like bold, italics, headers, or bullet points). Ensure all fields are populated appropriately based on the input. If a field is not directly deducible from the input, provide a reasonable placeholder or "N/A". The report should be written as if you were the officer writing it.

Suspect Name: ${suspectName}
Charges: ${charges}
Officer Narrative: ${narrative}
Mirandized: ${mirandized}
GSR Test: ${gsrTest}
Name of Legal Representation: ${legalRepresentation || 'N/A'}
Items Seized: ${itemsSeized || 'None'}
Level of Force: ${levelOfForce}
Medical Treatment: ${medicalTreatment}
Weapons Seized: ${weaponsSeized || 'None'}
Are Weapons Returnable: ${weaponsReturnable}
Plea Type: ${pleaType}

---
Strict Output Format:
Debrief: [Detailed summary of the incident based on the narrative and provided information. Focus on the factual account of events, what happened, and actions taken by law enforcement.]

Justification of Charges:
${charges.split(',').map(charge => `(${charge.trim()}): [Reason for this specific charge based on the narrative and incident details]`).join('\n')}

Postal/Location: [Location of the incident, if mentioned in narrative, otherwise provide a general placeholder like "Los Santos, SA"]

Evidence/Items Seized: ${itemsSeized || 'None'}

Level of Force: ${levelOfForce}
Medical Treatment (Y | N): ${medicalTreatment}
GSR Test (positive | negative): ${gsrTest}
Legal Representation: ${legalRepresentation || 'N/A'}
Mirandized (Y | N): ${mirandized}
Can return weapons (Y | N): ${weaponsReturnable}
Plea (guilty | not guilty | no contest): ${pleaType}
`;

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${finalApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Check if the response was successful (status 2xx)
                if (!response.ok) {
                    const errorBody = await response.text();
                    generatedReportTextarea.value = `Error: API call failed with status ${response.status}. Details: ${errorBody}`;
                    console.error('API Error Response:', response.status, errorBody);
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let generatedText = result.candidates[0].content.parts[0].text;
                    // Post-process the generated text to remove any stray '>' or '<' characters and trim whitespace
                    generatedText = generatedText.replace(/[<>]/g, '').trim();
                    generatedReportTextarea.value = generatedText;
                    copyReportBtn.classList.remove('hidden'); // Show copy button on successful generation
                } else {
                    generatedReportTextarea.value = 'Failed to generate report. Gemini API returned an unexpected structure or no content.';
                    console.error('Gemini API returned an unexpected structure or no content:', result);
                    copyReportBtn.classList.add('hidden'); // Hide copy button on failure
                }
            } catch (error) {
                // Catch network errors, JSON parsing errors, etc.
                generatedReportTextarea.value = `An error occurred: ${error.message}. Please check your network connection and try again.`;
                console.error('Error during API call or processing:', error);
                copyReportBtn.classList.add('hidden'); // Hide copy button on error
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // Add event listener for the new Copy Report button
        copyReportBtn.addEventListener('click', () => {
            // Get the value, trim leading/trailing whitespace, and remove any leftover '<' or '>'
            let textToCopy = generatedReportTextarea.value.trim().replace(/[<>]/g, '');

            // Create a temporary textarea element to hold the text for copying
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            // Append it to the body to make it selectable, but make it invisible
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);

            tempTextArea.select(); // Select the text in the temporary textarea
            document.execCommand('copy'); // Copy the selected text

            // Provide a visual cue that text has been copied
            const originalText = copyReportBtn.textContent;
            copyReportBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyReportBtn.textContent = originalText;
            }, 1500); // Change back after 1.5 seconds
        });
    </script>
</body>
</html>
