<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPD MDT - Report Generator</title>
    <link rel="icon" href="[https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png](https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png)" type="image/png">

    <!-- General Meta Tags -->
    <meta name="description" content="A comprehensive tool for officers of the Unified Police Department to generate, manage, and file official incident reports.">
    <meta name="author" content="Unified Police Department">
    <meta name="keywords" content="police, report generator, UPD, law enforcement, MDT">

    <!-- Tailwind CSS CDN -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
        import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, collection, query, where } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            addDoc,
            getDoc,
            getDocs,
            onSnapshot,
            collection,
            query,
            where
        };
    </script>

    <style>
        @import url('[https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap)');

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #ffffff;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #60a5fa;
            --modal-content-bg: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

            .report-modal-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

        .report-modal-content {
            background-color: #1f2937;
            color: #f1f5f9;
            border-radius: 12px;
            padding: 24px;
            max-width: 90%;
            width: 550px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #addChargeModal .report-modal-content, #viewReportsModal .report-modal-content {
            width: 80vw;
            max-width: 1200px;
        }

        .officer-item.selected, .charge-item.selected {
            background-color: #dc2626;
            color: #ffffff;
            border: 2px solid #ef4444;
            font-weight: 600;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

            #sidebar.sidebar-hidden {
                transform: translateX(-100%);
            }

        .disabled-section {
            opacity: 0.5;
            pointer-events: none;
        }
        /* New styles for the improved toggle */
        .report-toggle-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }

        html.dark .report-toggle-btn.active {
            background-color: #60a5fa; /* blue-400 */
        }
    </style>
</head>
<body class="antialiased bg-gray-100 dark:bg-slate-900">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute md:relative z-20 flex-col w-64 bg-white dark:bg-slate-800 shadow-lg transition-transform duration-300 -translate-x-full md:translate-x-0">
            <div class="flex items-center justify-center h-20 border-b dark:border-slate-700 flex-shrink-0 flex-col">
                <div class="flex items-center">
                    <img src="[https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png](https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png)" alt="UPD Logo" class="w-12 h-12 object-contain">
                    <h1 class="text-xl font-bold ml-2 text-slate-800 dark:text-white">UPD Portal</h1>
                </div>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Report Generator</p>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2 overflow-y-auto">
                <div>
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Core</h3>
                    <a href="index.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span class="ml-3">Dashboard</span>
                    </a>
                </div>
                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Resources</h3>
                    <a href="SOP.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="ml-3">SOPs</span>
                    </a>
                    <a href="training.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path d="M12 14l9-5-9-5-9 5 9 5z"></path><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14z"></path></svg>
                        <span class="ml-3">Training</span>
                    </a>
                </div>
                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Tools</h3>
                    <a href="forms.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <span class="ml-3">Forms</span>
                    </a>
                    <a href="report.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg bg-slate-200 dark:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="ml-3">Report Generator</span>
                    </a>
                    <a href="charges.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3.25a3.25 3.25 0 00-3.25-3.25H9.25A3.25 3.25 0 006 13.75V17m0 0h12M6 17H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1m-6-14v2m-6-2v2"></path></svg>
                        <span class="ml-3">Charge Calculator</span>
                    </a>
                </div>
                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Personnel</h3>
                    <a href="roster.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a3.001 3.001 0 015.644 0M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="ml-3">Roster</span>
                    </a>
                    <a href="hr.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a4 4 0 110-8 4 4 0 010 8z"></path></svg>
                        <span class="ml-3">HR Info</span>
                    </a>
                    <a href="info.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="ml-3">Common Information</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Header -->
            <header class="bg-white dark:bg-slate-800 shadow-md flex items-center justify-between p-4 border-b dark:border-slate-700">
                <button id="hamburgerBtn" class="text-slate-500 focus:outline-none md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div class="flex-1"></div>
                <div class="flex items-center ml-4">
                    <button id="save-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mr-2">Save Report</button>
                    <button id="view-saved-reports-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mr-2">View Saved Reports</button>
                    <div class="relative" id="warrant-dropdown-container">
                        <button id="warrant-dropdown-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Request Warrant</button>
                        <div id="warrant-dropdown-menu" class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden">
                            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-modal-id="arrest-warrant-modal">Arrest Warrant</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-modal-id="search-warrant-modal">Search Warrant</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-modal-id="seizure-warrant-modal">Property Seizure Warrant</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" data-modal-id="hold-warrant-modal">Investigative Hold Warrant</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-900 text-white">
                <div class="flex items-center justify-between p-4 bg-gray-800 text-white shadow-md">
                    <div class="flex-grow text-center">
                        <h1 id="caseTitle" class="text-lg md:text-2xl font-bold">New Arrest Report</h1>
                    </div>
                    <div>
                        <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Delete</button>
                    </div>
                </div>

                <!-- Report Type Toggle -->
                <div class="p-4 flex justify-center items-center space-x-4 bg-gray-800">
                    <div id="report-type-toggle" class="inline-flex rounded-md shadow-sm" role="group">
                        <button type="button" data-type="arrest" class="report-toggle-btn active px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                            Arrest Report
                        </button>
                        <button type="button" data-type="traffic" class="report-toggle-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                            Traffic Citation
                        </button>
                    </div>
                </div>

                <div class="p-4 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Left Column -->
                    <div class="col-span-1 flex flex-col space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">Evidence / Seized Items</h3>
                                <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full" data-list-id="evidence-list">+ Add</button>
                            </div>
                            <ul id="evidence-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO ITEMS SEIZED"><li class="placeholder-item p-2 border border-gray-700 rounded-md">NO ITEMS SEIZED</li></ul>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">Linked Reports</h3>
                                <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full" data-list-id="linked-reports-list">+ Add</button>
                            </div>
                            <ul id="linked-reports-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO LINKED REPORTS"><li class="placeholder-item p-2 border border-gray-700 rounded-md">NO LINKED REPORTS</li></ul>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">Officer/Driver Statement</h3>
                                <button id="generate-report-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-1 px-3 rounded-full">Generate with AI</button>
                            </div>
                            <div id="description-loading-container" class="hidden flex justify-center items-center flex-grow bg-gray-700 rounded-b-lg"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div></div>
                            <textarea id="report-description" placeholder="Enter the initial debrief, summary, or driver's statement here..." class="w-full flex-grow p-2 bg-gray-700 text-white rounded-b-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-600" style="min-height: 200px;"></textarea>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="col-span-1 flex flex-col space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">Tags</h3>
                                <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full" data-list-id="tags-list">+ Add</button>
                            </div>
                            <ul id="tags-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO TAGS"><li class="placeholder-item p-2 border border-gray-700 rounded-md">NO TAGS</li></ul>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">Officers Involved</h3>
                                <button id="add-officer-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full">+ Add</button>
                            </div>
                            <ul id="officers-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO OFFICERS INVOLVED"><li class="placeholder-item p-2 border border-gray-700 rounded-md">NO OFFICERS INVOLVED</li></ul>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-lg">Suspects / Drivers</h3>
                                <button id="add-criminal-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full">+ Add</button>
                            </div>
                            <ul id="criminals-list" class="space-y-4 text-sm text-gray-400" data-placeholder="NO SUSPECTS / DRIVERS"><li class="placeholder-item p-2 border border-gray-700 rounded-md">NO SUSPECTS / DRIVERS</li></ul>
                        </div>

                        <!-- Traffic Details Section -->
                        <div id="traffic-details-section" class="bg-gray-800 p-4 rounded-lg shadow-lg hidden">
                            <h3 class="font-semibold text-lg mb-4">Traffic Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="vehicle-make" class="block text-sm font-medium text-gray-400">Vehicle Make/Model</label><input type="text" id="vehicle-make" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="vehicle-color" class="block text-sm font-medium text-gray-400">Color</label><input type="text" id="vehicle-color" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="vehicle-plate" class="block text-sm font-medium text-gray-400">Plate</label><input type="text" id="vehicle-plate" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="vehicle-owner" class="block text-sm font-medium text-gray-400">Registered Owner</label><input type="text" id="vehicle-owner" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="driver-license" class="block text-sm font-medium text-gray-400">Driverâ€™s License #</label><input type="text" id="driver-license" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="stop-reason" class="block text-sm font-medium text-gray-400">Reason for Stop</label><input type="text" id="stop-reason" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="observed-violations" class="block text-sm font-medium text-gray-400">Observed Violations</label><input type="text" id="observed-violations" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="speed" class="block text-sm font-medium text-gray-400">Speed (if applicable)</label><input type="text" id="speed" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="radar-used" class="block text-sm font-medium text-gray-400">Radar/Lidar Used</label><select id="radar-used" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>No</option><option>Yes</option></select></div>
                                <div><label for="traffic-conditions" class="block text-sm font-medium text-gray-400">Traffic Conditions</label><input type="text" id="traffic-conditions" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="weather-conditions" class="block text-sm font-medium text-gray-400">Weather Conditions</label><input type="text" id="weather-conditions" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="vehicle-search" class="block text-sm font-medium text-gray-400">Vehicle Search Conducted</label><select id="vehicle-search" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>No</option><option>Yes</option></select></div>
                            </div>
                        </div>

                        <!-- Report Details Section -->
                        <div id="arrest-details-section" class="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <h3 class="font-semibold text-lg mb-4">Arrest Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="postal-location" class="block text-sm font-medium text-gray-400">Postal/Location</label><input type="text" id="postal-location" class="w-full p-2 bg-gray-700 text-white rounded-md"></div>
                                <div><label for="level-of-force" class="block text-sm font-medium text-gray-400">Level of Force</label><select id="level-of-force" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>None</option><option>Verbal Commands</option><option>Physical Restraint</option><option>Taser Deployment</option><option>Lethal Force</option></select></div>
                                <div id="medical-treatment-wrapper"><label for="medical-treatment" class="block text-sm font-medium text-gray-400">Medical Treatment</label><select id="medical-treatment" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>No</option><option>Yes</option></select></div>
                                <div id="gsr-test-wrapper"><label for="gsr-test" class="block text-sm font-medium text-gray-400">GSR Test</label><select id="gsr-test" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>Not Applicable</option><option>Positive</option><option>Negative</option></select></div>
                                <div id="legal-rep-wrapper"><label for="legal-representation" class="block text-sm font-medium text-gray-400">Legal Representation</label><select id="legal-representation" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>No</option><option>Yes</option></select></div>
                                <div><label for="mirandized" class="block text-sm font-medium text-gray-400">Mirandized</label><select id="mirandized" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>No</option><option>Yes</option></select></div>
                                <div id="return-weapons-wrapper"><label for="return-weapons" class="block text-sm font-medium text-gray-400">Can return weapons</label><select id="return-weapons" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>No</option><option>Yes</option></select></div>
                                <div><label for="plea" class="block text-sm font-medium text-gray-400">Plea</label><select id="plea" class="w-full p-2 bg-gray-700 text-white rounded-md"><option>Not Applicable</option><option>Guilty</option><option>Not Guilty</option><option>No Contest</option></select></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="addItemModal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Add Item</h3><input type="text" id="addItemInput" placeholder="Enter item name..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><div class="flex justify-end space-x-2"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="saveAddItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add</button></div></div></div>
    <div id="addOfficerModal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Add Officer</h3><input type="text" id="officer-search-input" placeholder="Search for an officer..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><div id="officer-list-loading" class="flex justify-center items-center h-24 hidden"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div><div id="officer-list-container" class="space-y-2 max-h-64 overflow-y-auto mb-4 p-2 bg-gray-700 rounded-md"></div><p id="officer-list-error" class="text-red-400 text-sm hidden">Failed to load officer data.</p><div class="flex justify-end space-x-2"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="saveAddOfficerBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Add Selected</button></div></div></div>
    <div id="addCriminalModal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Add Suspect/Driver</h3><input type="text" id="criminalNameInput" placeholder="Enter name..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><div class="flex justify-end space-x-2"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="saveAddCriminalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add</button></div></div></div>
    <div id="addChargeModal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Add Charge/Citation</h3><input type="text" id="charge-search-input" placeholder="Search for a charge..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><div id="charge-list-loading" class="flex justify-center items-center h-24 hidden"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div><div id="charge-list-container" class="space-y-4 max-h-[60vh] overflow-y-auto mb-4 p-2 bg-gray-800 rounded-md"></div><p id="charge-list-error" class="text-red-400 text-sm hidden">Failed to load charge data.</p><div class="flex justify-end space-x-2"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="saveAddChargeBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Add Selected</button></div></div></div>
    <div id="viewReportsModal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Saved Reports</h3><div id="saved-reports-loading" class="flex justify-center items-center h-24"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div><div id="saved-reports-list" class="space-y-2 max-h-[60vh] overflow-y-auto mb-4 p-2 bg-gray-800 rounded-md"></div><div class="flex justify-end"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button></div></div></div>
    <div id="deleteConfirmationModal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Confirm Deletion</h3><p class="text-gray-300 mb-6">Are you sure you want to delete this report? This action cannot be undone.</p><div class="flex justify-end space-x-2"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Delete</button></div></div></div>

    <!-- Warrant Modals -->
    <div id="arrest-warrant-modal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Arrest Warrant Request</h3><input type="text" id="arrest-suspect-details" placeholder="Suspect Name & Details..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><textarea id="arrest-warrant-text" placeholder="Generated warrant request will appear here..." class="w-full p-2 bg-gray-800 text-white rounded-md" rows="10"></textarea><div class="flex justify-end space-x-2 mt-4"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button class="generate-warrant-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg" data-warrant-type="arrest">Generate Warrant Request</button></div></div></div>
    <div id="search-warrant-modal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Search Warrant Request</h3><input type="text" id="search-location-details" placeholder="Location to be Searched..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><textarea id="search-warrant-text" placeholder="Generated warrant request will appear here..." class="w-full p-2 bg-gray-800 text-white rounded-md" rows="10"></textarea><div class="flex justify-end space-x-2 mt-4"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button class="generate-warrant-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg" data-warrant-type="search">Generate Warrant Request</button></div></div></div>
    <div id="seizure-warrant-modal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Property Seizure Warrant Request</h3><input type="text" id="seizure-property-details" placeholder="Property to be Seized..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><textarea id="seizure-warrant-text" placeholder="Generated warrant request will appear here..." class="w-full p-2 bg-gray-800 text-white rounded-md" rows="10"></textarea><div class="flex justify-end space-x-2 mt-4"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button class="generate-warrant-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg" data-warrant-type="seizure">Generate Warrant Request</button></div></div></div>
    <div id="hold-warrant-modal" class="report-modal-overlay hidden"><div class="report-modal-content"><h3 class="text-xl font-bold mb-4">Investigative Hold Warrant Request</h3><input type="text" id="hold-suspect-details" placeholder="Suspect to be Held..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md"><textarea id="hold-warrant-text" placeholder="Generated warrant request will appear here..." class="w-full p-2 bg-gray-800 text-white rounded-md" rows="10"></textarea><div class="flex justify-end space-x-2 mt-4"><button class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button class="generate-warrant-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg" data-warrant-type="hold">Generate Warrant Request</button></div></div></div>


    <script type="module">
        let db, auth, userId;
        let geminiApiKey = null; // Key will be fetched from Firestore

        const firebaseConfig = { apiKey: "AIzaSyDU7DRAxCzqu81DTa7k0DXaBRcMpk0sElc", authDomain: "upd-system.firebaseapp.com", projectId: "upd-system", storageBucket: "upd-system.appspot.com", messagingSenderId: "28223003678", appId: "1:28223003678:web:d8b2c8a22a3f7d1b3e4f5a" };
        const appId = 'report-generator';

        async function fetchGeminiApiKey() {
            if (geminiApiKey) return geminiApiKey; // Return cached key

            if (!db) {
                console.error("Firestore is not initialized. Cannot fetch API key.");
                return null;
            }

            try {
                // Fetch the API key from a protected document in Firestore
                const docRef = window.firebase.doc(db, "apikeys", "Gemini");
                const docSnap = await window.firebase.getDoc(docRef);

                if (docSnap.exists() && docSnap.data().API) {
                    geminiApiKey = docSnap.data().API;
                    console.log("Gemini API Key loaded successfully from Firestore.");
                    return geminiApiKey;
                } else {
                    console.error("Gemini API Key not found in Firestore document: /apikeys/Gemini");
                    alert("Critical configuration error: Gemini API Key not found. AI features will be disabled.");
                    return null;
                }
            } catch (error) {
                console.error("Error fetching Gemini API Key from Firestore:", error);
                alert("Failed to fetch API key. AI features may not work. Check Firestore permissions and data.");
                return null;
            }
        }


        const getReportDataAsObject = () => ({
            caseTitle: document.getElementById('caseTitle').textContent, description: document.getElementById('report-description').value, location: document.getElementById('postal-location').value, forceLevel: document.getElementById('level-of-force').value, medicalTreatment: document.getElementById('medical-treatment').value, gsrTest: document.getElementById('gsr-test').value, legalRepresentation: document.getElementById('legal-representation').value, mirandized: document.getElementById('mirandized').value, returnWeapons: document.getElementById('return-weapons').value, plea: document.getElementById('plea').value, evidence: document.getElementById('evidence-list').innerHTML, linkedReports: document.getElementById('linked-reports-list').innerHTML, tags: document.getElementById('tags-list').innerHTML, officers: document.getElementById('officers-list').innerHTML, criminals: document.getElementById('criminals-list').innerHTML, arrestWarrantText: document.getElementById('arrest-warrant-text').value, searchWarrantText: document.getElementById('search-warrant-text').value, seizureWarrantText: document.getElementById('seizure-warrant-text').value, holdWarrantText: document.getElementById('hold-warrant-text').value,
            vehicleMake: document.getElementById('vehicle-make').value, vehicleColor: document.getElementById('vehicle-color').value, vehiclePlate: document.getElementById('vehicle-plate').value, vehicleOwner: document.getElementById('vehicle-owner').value, driverLicense: document.getElementById('driver-license').value, stopReason: document.getElementById('stop-reason').value, observedViolations: document.getElementById('observed-violations').value, speed: document.getElementById('speed').value, radarUsed: document.getElementById('radar-used').value, trafficConditions: document.getElementById('traffic-conditions').value, weatherConditions: document.getElementById('weather-conditions').value, vehicleSearch: document.getElementById('vehicle-search').value,
            reportType: document.querySelector('.report-toggle-btn.active').dataset.type,
        });

        const populateFormWithData = (data) => {
            document.getElementById('caseTitle').textContent = data.caseTitle || 'New Case'; document.getElementById('report-description').value = data.description || ''; document.getElementById('postal-location').value = data.location || ''; document.getElementById('level-of-force').value = data.forceLevel || 'None'; document.getElementById('medical-treatment').value = data.medicalTreatment || 'No'; document.getElementById('gsr-test').value = data.gsrTest || 'Not Applicable'; document.getElementById('legal-representation').value = data.legalRepresentation || 'No'; document.getElementById('mirandized').value = data.mirandized || 'No'; document.getElementById('return-weapons').value = data.returnWeapons || 'No'; document.getElementById('plea').value = data.plea || 'Not Applicable'; document.getElementById('evidence-list').innerHTML = data.evidence || '<li class="placeholder-item p-2 border border-gray-700 rounded-md">NO ATTACHED EVIDENCE</li>'; document.getElementById('linked-reports-list').innerHTML = data.linkedReports || '<li class="placeholder-item p-2 border border-gray-700 rounded-md">NO LINKED REPORTS</li>'; document.getElementById('tags-list').innerHTML = data.tags || '<li class="placeholder-item p-2 border border-gray-700 rounded-md">NO TAGS</li>'; document.getElementById('officers-list').innerHTML = data.officers || '<li class="placeholder-item p-2 border border-gray-700 rounded-md">NO OFFICERS INVOLVED</li>'; document.getElementById('criminals-list').innerHTML = data.criminals || '<li class="placeholder-item p-2 border border-gray-700 rounded-md">NO CRIMINALS INVOLVED</li>'; document.getElementById('arrest-warrant-text').value = data.arrestWarrantText || ''; document.getElementById('search-warrant-text').value = data.searchWarrantText || ''; document.getElementById('seizure-warrant-text').value = data.seizureWarrantText || ''; document.getElementById('hold-warrant-text').value = data.holdWarrantText || '';
            document.getElementById('vehicle-make').value = data.vehicleMake || ''; document.getElementById('vehicle-color').value = data.vehicleColor || ''; document.getElementById('vehicle-plate').value = data.vehiclePlate || ''; document.getElementById('vehicle-owner').value = data.vehicleOwner || ''; document.getElementById('driver-license').value = data.driverLicense || ''; document.getElementById('stop-reason').value = data.stopReason || ''; document.getElementById('observed-violations').value = data.observedViolations || ''; document.getElementById('speed').value = data.speed || ''; document.getElementById('radar-used').value = data.radarUsed || 'No'; document.getElementById('traffic-conditions').value = data.trafficConditions || ''; document.getElementById('weather-conditions').value = data.weatherConditions || ''; document.getElementById('vehicle-search').value = data.vehicleSearch || 'No';

            const isTraffic = data.reportType === 'traffic';
            toggleReportMode(isTraffic);
        };

        async function saveReportToFirestore() {
            if (!db || !userId) { alert("Firebase is not ready. Cannot save report."); return; }
            const reportData = getReportDataAsObject(); reportData.authorId = userId; reportData.createdAt = new Date().toISOString();
            try { await window.firebase.addDoc(window.firebase.collection(db, `artifacts/${appId}/public/data/reports`), reportData); alert("Report saved successfully!"); } catch (error) { console.error("Error saving report:", error); alert("Failed to save report."); }
        };

        function loadReportsFromFirestore() {
            if (!db || !userId) return;
            const q = window.firebase.query(window.firebase.collection(db, `artifacts/${appId}/public/data/reports`), window.firebase.where("authorId", "==", userId));
            const listEl = document.getElementById('saved-reports-list'); const loadingEl = document.getElementById('saved-reports-loading');
            window.firebase.onSnapshot(q, (snapshot) => {
                loadingEl.classList.add('hidden'); listEl.innerHTML = '';
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-center text-gray-400">No saved reports found.</p>'; return; }
                snapshot.forEach(doc => {
                    const report = { id: doc.id, ...doc.data() }; const div = document.createElement('div'); div.className = 'p-3 rounded-md cursor-pointer bg-gray-700 hover:bg-gray-600'; div.dataset.reportId = report.id;
                    div.innerHTML = `<h4 class="font-bold text-white">${report.caseTitle || 'Untitled Report'}</h4><p class="text-xs text-gray-400">Saved: ${new Date(report.createdAt).toLocaleString()}</p>`;
                    div.addEventListener('click', () => loadSpecificReport(report.id)); listEl.appendChild(div);
                });
            }, (error) => { console.error("Error loading reports:", error); listEl.innerHTML = '<p class="text-center text-red-400">Failed to load reports.</p>'; });
        };

        async function loadSpecificReport(reportId) {
            if (!db) return;
            try {
                const docRef = window.firebase.doc(db, `artifacts/${appId}/public/data/reports`, reportId); const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap.exists()) { populateFormWithData(docSnap.data()); document.getElementById('viewReportsModal').classList.add('hidden'); } else { alert("Could not find the selected report."); }
            } catch (error) { console.error("Error loading specific report:", error); }
        }

        async function sendDiscordReportNotification(criminals, officers) {
            if (!db) { console.error("Firestore is not initialized. Cannot fetch webhook."); return; }
            try {
                const webhooksCollection = window.firebase.collection(db, 'webhooks', 'discord', 'discords'); const webhookSnapshot = await window.firebase.getDocs(webhooksCollection);
                if (webhookSnapshot.empty) { console.log("No Discord webhook documents found in Firestore."); return; }
                webhookSnapshot.forEach(async (doc) => {
                    const webhookData = doc.data(); const discordWebhookUrl = webhookData.Webhook;
                    if (!discordWebhookUrl || !discordWebhookUrl.startsWith('[https://discord.com/api/webhooks/](https://discord.com/api/webhooks/)')) { console.error(`Invalid webhook URL in doc ${doc.id}:`, discordWebhookUrl); return; }
                    const payload = { username: "UPD Report Bot", avatar_url: "[https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png](https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png)", embeds: [{ title: "New Incident Report Filed", color: 15158332, fields: [{ name: "Suspect(s)", value: "```" + (criminals.map(c => c.name).join('\n') || 'N/A') + "```" }, { name: "Involved Officer(s)", value: "```" + (officers.join('\n') || 'N/A') + "```" }, { name: "Charges Filed", value: "```" + (criminals.flatMap(c => c.charges).join('\n') || 'None') + "```" }], timestamp: new Date().toISOString() }] };
                    try { await fetch(discordWebhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); console.log(`Notification sent to: ${webhookData['Discord Server']}`); } catch (fetchError) { console.error(`Error sending notification to ${webhookData['Discord Server']}:`, fetchError); }
                });
            } catch (error) { console.error('Error fetching Discord webhooks:', error); }
        }

        try {
            const app = window.firebase.initializeApp(firebaseConfig); auth = window.firebase.getAuth(app); db = window.firebase.getFirestore(app); console.log("Firebase Initialized");
            window.firebase.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; console.log("User is signed in with UID:", userId);
                    loadReportsFromFirestore();
                    await fetchGeminiApiKey(); // Fetch the API key after authentication
                } else {
                    try {
                        await window.firebase.signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error signing in anonymously:", error);
                    }
                }
            });
        } catch (e) { console.error("Error initializing Firebase:", e); alert("Firebase could not be initialized."); }

        document.addEventListener('DOMContentLoaded', () => {
            const openModal = (modal) => modal.classList.remove('hidden'); const closeModal = (modal) => modal.classList.add('hidden');
            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.report-modal-overlay'))));

            let currentListId = null;
            document.querySelectorAll('.add-item-btn').forEach(button => button.addEventListener('click', () => { currentListId = button.dataset.listId; openModal(document.getElementById('addItemModal')); }));
            document.getElementById('saveAddItemBtn').addEventListener('click', () => { const input = document.getElementById('addItemInput'); const list = document.getElementById(currentListId); if (input.value.trim() && list) { if (list.querySelector('.placeholder-item')) list.innerHTML = ''; addListItem(list, input.value.trim()); input.value = ''; closeModal(document.getElementById('addItemModal')); } });

            document.getElementById('add-officer-btn').addEventListener('click', () => { openModal(document.getElementById('addOfficerModal')); if (allOfficers.length === 0) fetchAllOfficerData(); });
            document.getElementById('add-criminal-btn').addEventListener('click', () => openModal(document.getElementById('addCriminalModal')));
            document.getElementById('save-report-btn').addEventListener('click', saveReportToFirestore);
            document.getElementById('view-saved-reports-btn').addEventListener('click', () => openModal(document.getElementById('viewReportsModal')));
            document.getElementById('deleteBtn').addEventListener('click', () => openModal(document.getElementById('deleteConfirmationModal')));

            const warrantDropdownBtn = document.getElementById('warrant-dropdown-btn'); const warrantDropdownMenu = document.getElementById('warrant-dropdown-menu');
            warrantDropdownBtn.addEventListener('click', () => warrantDropdownMenu.classList.toggle('hidden'));
            document.addEventListener('click', (e) => { if (!document.getElementById('warrant-dropdown-container').contains(e.target)) warrantDropdownMenu.classList.add('hidden'); });
            document.querySelectorAll('#warrant-dropdown-menu a').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); const modalId = e.target.dataset.modalId; openModal(document.getElementById(modalId)); warrantDropdownMenu.classList.add('hidden'); }));

            const sidebar = document.getElementById('sidebar'); const hamburgerBtn = document.getElementById('hamburgerBtn');
            hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('-translate-x-full'); });

            function addListItem(list, text) { const li = document.createElement('li'); li.className = "flex items-center justify-between p-2 border border-gray-700 rounded-md bg-gray-700 text-white"; li.innerHTML = `<span>${text}</span><button class="remove-item-btn text-red-400 hover:text-red-500 text-2xl font-bold">&times;</button>`; list.appendChild(li); }
            document.body.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { const listItem = e.target.closest('li'); const list = listItem.parentElement; listItem.remove(); if (list.children.length === 0) { const placeholderText = list.dataset.placeholder || 'NO ITEMS'; list.innerHTML = `<li class="placeholder-item p-2 border border-gray-700 rounded-md">${placeholderText}</li>`; } } });

            let allOfficers = []; let allCharges = [];
            const officerSheets = { 'upd': { name: 'UPD', publishedKey: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi', gid: '0' } };
            const chargesSheetUrl = '[https://docs.google.com/spreadsheets/d/e/2PACX-1vQa6HZQ9JM5Unzwe4zZDX8A21m6zV4oGvDuEbSEqA9f3m3CqplUUUlmCScNHf79a8Sr1nem0div9YT2/pub?output=csv](https://docs.google.com/spreadsheets/d/e/2PACX-1vQa6HZQ9JM5Unzwe4zZDX8A21m6zV4oGvDuEbSEqA9f3m3CqplUUUlmCScNHf79a8Sr1nem0div9YT2/pub?output=csv)';
            async function fetchAllOfficerData() { const container = document.getElementById('officer-list-container'); const loading = document.getElementById('officer-list-loading'); loading.classList.remove('hidden'); try { const responses = await Promise.all(Object.values(officerSheets).map(sheet => fetch(`https://docs.google.com/spreadsheets/d/e/${sheet.publishedKey}/pub?gid=${sheet.gid}&single=true&output=csv`))); const texts = await Promise.all(responses.map(res => res.text())); allOfficers = texts.flatMap(text => parseCSV(text, 'name')).filter(Boolean).sort(); populateList(container, allOfficers, 'officer-item', (name) => name); } catch (error) { console.error('Error fetching officer data:', error); document.getElementById('officer-list-error').classList.remove('hidden'); } finally { loading.classList.add('hidden'); } }
            async function fetchChargeData() { const container = document.getElementById('charge-list-container'); const loading = document.getElementById('charge-list-loading'); loading.classList.remove('hidden'); try { const response = await fetch(chargesSheetUrl); const csvText = await response.text(); allCharges = parseChargeCSV(csvText); populateChargeList(allCharges); } catch (error) { console.error('Error fetching charges:', error); document.getElementById('charge-list-error').classList.remove('hidden'); } finally { loading.classList.add('hidden'); } }
            function parseCSV(csv, columnName) { const lines = csv.split('\n'); const items = []; if (lines.length < 1) return items; const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase()); const colIndex = headers.indexOf(columnName.toLowerCase()); if (colIndex === -1) return items; for (let i = 1; i < lines.length; i++) { const columns = lines[i].split(','); if (columns[colIndex]) { const item = columns[colIndex].trim().replace(/^"|"$/g, ''); if (item) items.push(item); } } return items; }
            function parseChargeCSV(csv) { const lines = csv.split('\n').slice(1); return lines.map(line => { const parts = line.split(','); return { penalCode: parts[0] || 'N/A', chargeName: parts[1] || 'N/A', description: parts[2] || 'N/A', jailTime: parts[3] || 'N/A', fineAmount: parts[4] || 'N/A', }; }).filter(c => c.chargeName !== 'N/A'); }
            function populateList(container, data, itemClass, textFn) { container.innerHTML = ''; data.forEach(item => { const div = document.createElement('div'); div.className = `${itemClass} p-2 rounded-md cursor-pointer hover:bg-gray-600 border border-gray-700`; div.textContent = textFn(item); div.dataset.value = typeof item === 'string' ? item : JSON.stringify(item); container.appendChild(div); }); }
            function populateChargeList(charges) { const container = document.getElementById('charge-list-container'); container.innerHTML = ''; charges.forEach(charge => { const div = document.createElement('div'); div.className = 'charge-item p-3 rounded-md cursor-pointer bg-red-800 hover:bg-red-700 border border-gray-600'; div.dataset.value = `${charge.penalCode}: ${charge.chargeName}`; div.innerHTML = `<p class="font-bold text-white">${charge.chargeName}</p><p class="text-xs text-gray-400">${charge.penalCode}</p><p class="text-sm text-gray-300 mt-1">${charge.description}</p><div class="text-right text-xs mt-1"><span>${charge.jailTime} Months / ${charge.fineAmount}</span></div>`; container.appendChild(div); }); }

            let selectedOfficers = [], selectedCharges = [], currentChargesList = null;
            document.getElementById('officer-list-container').addEventListener('click', e => { if (e.target.classList.contains('officer-item')) { e.target.classList.toggle('selected'); selectedOfficers = Array.from(document.querySelectorAll('.officer-item.selected')).map(el => el.dataset.value); document.getElementById('saveAddOfficerBtn').disabled = selectedOfficers.length === 0; } });
            document.getElementById('charge-list-container').addEventListener('click', e => { const target = e.target.closest('.charge-item'); if (target) { target.classList.toggle('selected'); selectedCharges = Array.from(document.querySelectorAll('.charge-item.selected')).map(el => el.dataset.value); document.getElementById('saveAddChargeBtn').disabled = selectedCharges.length === 0; } });
            document.getElementById('saveAddOfficerBtn').addEventListener('click', () => { const list = document.getElementById('officers-list'); if (list.querySelector('.placeholder-item')) list.innerHTML = ''; selectedOfficers.forEach(officer => addListItem(list, officer)); closeModal(document.getElementById('addOfficerModal')); });
            document.getElementById('saveAddCriminalBtn').addEventListener('click', () => { const name = document.getElementById('criminalNameInput').value.trim(); if (!name) return; const list = document.getElementById('criminals-list'); if (list.querySelector('.placeholder-item')) list.innerHTML = ''; const li = document.createElement('li'); li.className = 'p-4 border border-gray-700 rounded-md bg-gray-800'; li.innerHTML = `<div class="flex items-center justify-between mb-2"><h4 class="font-bold text-lg">${name}</h4><button class="remove-item-btn text-red-400 hover:text-red-500 text-2xl">&times;</button></div><h5 class="text-md font-semibold">Charges:</h5><ul class="charges-list list-disc list-inside space-y-1 text-gray-400" data-placeholder="No charges added yet."><li class="placeholder-item">No charges added yet.</li></ul><button class="add-charge-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded-full mt-2">+ Add Charge</button>`; list.appendChild(li); document.getElementById('criminalNameInput').value = ''; closeModal(document.getElementById('addCriminalModal')); });
            document.getElementById('criminals-list').addEventListener('click', e => { if (e.target.classList.contains('add-charge-btn')) { currentChargesList = e.target.previousElementSibling; openModal(document.getElementById('addChargeModal')); if (allCharges.length === 0) fetchChargeData(); } });
            document.getElementById('saveAddChargeBtn').addEventListener('click', () => { if (!currentChargesList) return; if (currentChargesList.querySelector('.placeholder-item')) currentChargesList.innerHTML = ''; selectedCharges.forEach(charge => addListItem(currentChargesList, charge)); document.querySelectorAll('.charge-item.selected').forEach(el => el.classList.remove('selected')); selectedCharges = []; document.getElementById('saveAddChargeBtn').disabled = true; closeModal(document.getElementById('addChargeModal')); });

            async function generateAIContent(prompt, outputTextarea) {
                if (!geminiApiKey) {
                    alert("Gemini API Key is not available. AI generation is disabled. Please check the Firestore configuration.");
                    return;
                }
                const loadingContainer = document.getElementById('description-loading-container');
                loadingContainer.classList.remove('hidden'); outputTextarea.classList.add('hidden');
                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json(); outputTextarea.value = result.candidates[0].content.parts[0].text;
                } catch (error) { console.error('Error generating content:', error); outputTextarea.value = `Error: Could not generate content. ${error.message}`; } finally { loadingContainer.classList.add('hidden'); outputTextarea.classList.remove('hidden'); }
            }

            document.getElementById('generate-report-btn').addEventListener('click', async () => {
                const isTraffic = document.querySelector('.report-toggle-btn.active').dataset.type === 'traffic';
                const officers = getListData('officers-list');
                const criminals = getCriminalData();
                const evidence = getListData('evidence-list');
                const reportData = getReportDataAsObject();
                let prompt;

                if (isTraffic) {
                    prompt = `Generate a formal police traffic citation based on the following details. Structure the report using the exact markdown headings provided below. Do not add numbers or bullet points to the headings. The "Officer's Statement" should be a detailed, first-person narrative based on the "Reason for Stop".

# Unified Police Department - Traffic Citation

## Case Details
**Date:** ${new Date().toLocaleDateString()}
**Time:** ${new Date().toLocaleTimeString()}
**Location (postal):** ${reportData.location}
**Issuing Officer(s):** ${officers.join(', ') || 'N/A'}

## Vehicle Information
**Vehicle Make/Model:** ${reportData.vehicleMake}
**Color:** ${reportData.vehicleColor}
**License Plate:** ${reportData.vehiclePlate}
**Registered Owner:** ${reportData.vehicleOwner}

## Driver Information
**Driver Name:** ${criminals.map(c => c.name).join(', ') || 'N/A'}
**Driverâ€™s License #:** ${reportData.driverLicense}

## Incident Details
**Reason for Stop:** ${reportData.stopReason}
**Observed Violations:** ${reportData.observedViolations}
**Charges/Citations Issued:** ${criminals.flatMap(c => c.charges).join(', ') || 'None'}
**Speed (if applicable):** ${reportData.speed}
**Radar/Lidar Used:** ${reportData.radarUsed}
**Traffic Conditions:** ${reportData.trafficConditions}
**Weather Conditions:** ${reportData.weatherConditions}
**Vehicle Search Conducted:** ${reportData.vehicleSearch}
**Items Seized (if any):** ${evidence.join(', ') || 'None'}

## Statements
**Driverâ€™s Statement:**
${reportData.description}

**Officerâ€™s Statement:**
[AI to generate a formal, first-person narrative based on the 'Reason for Stop' and 'Observed Violations' details provided above.]`;
                } else {
                    prompt = `Generate a formal police arrest report based on the following details. Structure the report using the exact markdown headings provided below. Do not add numbers or bullet points to the headings. The "Officer's Narrative" should be a detailed, first-person account based on the "Initial Summary" information.

# Unified Police Department - Arrest Report

## Incident Information
**Date:** ${new Date().toLocaleDateString()}
**Time:** ${new Date().toLocaleTimeString()}
**Location (postal):** ${reportData.location}
**Reporting Officer(s):** ${officers.join(', ') || 'N/A'}

## Suspect Information
**Suspect(s):** ${criminals.map(c => c.name).join(', ') || 'N/A'}
**Charges:** ${criminals.flatMap(c => c.charges).join(', ') || 'None'}
**Plea:** ${reportData.plea}

## Procedural Information
**Detained/Arrested:** ${criminals.length > 0 ? 'Yes' : 'No'}
**Miranda Rights Read:** ${reportData.mirandized}
**Legal Representation Requested:** ${reportData.legalRepresentation}
**Suspect(s) Searched:** [AI should infer 'Yes' or 'No' based on seized items]
**Items Seized:** ${evidence.join(', ') || 'None'}
**Cash Seized:** [AI should state amount if mentioned in summary, otherwise 'N/A']
**GSR Test:** ${reportData.gsrTest}
**Fingerprints Taken:** [AI should state 'Taken as per standard procedure' if suspects are listed]

## Officer's Narrative
**Initial Summary:**
${reportData.description}

**Full Narrative:**
[AI to generate a formal, first-person narrative based on the 'Initial Summary' details provided above.]`;
                }

                await generateAIContent(prompt, document.getElementById('report-description'));
                await sendDiscordReportNotification(criminals, officers);
            });

            document.querySelectorAll('.generate-warrant-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const warrantType = btn.dataset.warrantType; const reportData = getReportDataAsObject(); const criminals = getCriminalData(); const officers = getListData('officers-list'); const evidence = getListData('evidence-list'); let specificDetails = ''; let outputTextarea;
                    switch (warrantType) {
                        case 'arrest': specificDetails = `**Suspect to be Arrested:** ${document.getElementById('arrest-suspect-details').value}`; outputTextarea = document.getElementById('arrest-warrant-text'); break;
                        case 'search': specificDetails = `**Location to be Searched:** ${document.getElementById('search-location-details').value}`; outputTextarea = document.getElementById('search-warrant-text'); break;
                        case 'seizure': specificDetails = `**Property to be Seized:** ${document.getElementById('seizure-property-details').value}`; outputTextarea = document.getElementById('seizure-warrant-text'); break;
                        case 'hold': specificDetails = `**Suspect to be Held for Investigation:** ${document.getElementById('hold-suspect-details').value}`; outputTextarea = document.getElementById('hold-warrant-text'); break;
                    }
                    const prompt = `Generate a formal, legally sound warrant request for an **${warrantType.toUpperCase()} WARRANT**. Base the probable cause and all details on the comprehensive incident report data provided below. The request must be formatted for a judge, citing specific details from the report to establish probable cause. --- **FULL INCIDENT REPORT DATA:** **Case Title:** ${reportData.caseTitle} **Reporting Officer(s):** ${officers.join(', ') || 'N/A'} **Date/Time of Incident (Implied by report generation):** ${new Date().toLocaleString()} **Location of Incident:** ${reportData.location} **Chronological Debrief / Incident Summary:** ${reportData.description} **Involved Criminals/Suspects:** ${criminals.map(c => `- ${c.name} (Charges: ${c.charges.join(', ') || 'None'})`).join('\n') || 'None Listed'} **Evidence Collected:** - ${evidence.join('\n- ') || 'None Listed'} **Post-Arrest Details:** - Level of Force Used: ${reportData.forceLevel} - Medical Treatment Administered: ${reportData.medicalTreatment} - GSR Test: ${reportData.gsrTest} - Mirandized: ${reportData.mirandized} - Legal Representation Requested: ${reportData.legalRepresentation} - Plea Entered: ${reportData.plea} --- **SPECIFIC WARRANT DETAILS:** **Type of Warrant Requested:** ${warrantType.toUpperCase()} ${specificDetails} --- Now, generate the complete warrant request text.`;
                    await generateAIContent(prompt, outputTextarea);
                });
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', () => { populateFormWithData({}); closeModal(document.getElementById('deleteConfirmationModal')); });

            const getListData = (listId) => Array.from(document.querySelectorAll(`#${listId} li:not(.placeholder-item) span`)).map(span => span.textContent);
            const getCriminalData = () => Array.from(document.querySelectorAll('#criminals-list > li:not(.placeholder-item)')).map(li => ({ name: li.querySelector('h4').textContent, charges: Array.from(li.querySelectorAll('.charges-list li:not(.placeholder-item) span')).map(span => span.textContent) }));

            // Report Type Toggle Logic
            const reportTypeToggleContainer = document.getElementById('report-type-toggle');
            const trafficDetailsSection = document.getElementById('traffic-details-section');
            const arrestDetailsSection = document.getElementById('arrest-details-section');
            const caseTitle = document.getElementById('caseTitle');

            const sectionsToToggle = [
                'medical-treatment-wrapper', 'gsr-test-wrapper', 'legal-rep-wrapper', 'return-weapons-wrapper'
            ];

            function toggleReportMode(isTraffic) {
                document.querySelectorAll('.report-toggle-btn').forEach(b => b.classList.remove('active'));
                if (isTraffic) {
                    document.querySelector('.report-toggle-btn[data-type="traffic"]').classList.add('active');
                    caseTitle.textContent = "New Traffic Citation";
                    trafficDetailsSection.classList.remove('hidden');
                    arrestDetailsSection.classList.add('hidden');
                    sectionsToToggle.forEach(id => document.getElementById(id)?.parentElement.classList.add('disabled-section'));
                } else {
                    document.querySelector('.report-toggle-btn[data-type="arrest"]').classList.add('active');
                    caseTitle.textContent = "New Arrest Report";
                    trafficDetailsSection.classList.add('hidden');
                    arrestDetailsSection.classList.remove('hidden');
                    sectionsToToggle.forEach(id => document.getElementById(id)?.parentElement.classList.remove('disabled-section'));
                }
            }

            reportTypeToggleContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.report-toggle-btn');
                if (button) {
                    toggleReportMode(button.dataset.type === 'traffic');
                }
            });

            // Initialize view
            toggleReportMode(false); // Default to Arrest Report
        });
    </script>
</body>
</html>