<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPD MDT - Report Generator</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png" type="image/png">

    <!-- General Meta Tags -->
    <meta name="description" content="A comprehensive tool for officers of the Unified Police Department to generate, manage, and file official incident reports.">
    <meta name="author" content="Unified Police Department">
    <meta name="keywords" content="police, report generator, UPD, law enforcement, MDT">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            addDoc,
            getDoc,
            getDocs,
            onSnapshot,
            collection,
            query,
            where
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #ffffff;
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #60a5fa;
            --modal-content-bg: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .settings-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: var(--modal-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .settings-modal-overlay.is-open {
                display: flex;
            }

        .modal-box {
            background-color: var(--modal-content-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 500px;
        }

        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

            .report-modal-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

        .report-modal-content {
            background-color: #1f2937;
            color: #f1f5f9;
            border-radius: 12px;
            padding: 24px;
            max-width: 90%;
            width: 450px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #addChargeModal .report-modal-content, #viewReportsModal .report-modal-content {
            width: 80vw;
            max-width: 1200px;
        }

        .officer-item.selected, .charge-item.selected {
            background-color: #dc2626;
            color: #ffffff;
            border: 2px solid #ef4444;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header Section -->
    <header class="bg-blue-900 text-white shadow-lg py-4 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center">
            <img src="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png" alt="UPD Logo" class="mr-4 w-16 h-16 object-contain">
            <h1 class="text-2xl md:text-3xl font-bold">Unified Police Department</h1>
        </div>
        <div class="flex items-center">
            <nav id="nav-links" class="hidden md:flex items-center">
                <ul class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 text-sm font-medium">
                    <li><a href="index.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Dashboard</a></li>
                    <li><a href="report.html" class="text-white bg-blue-700 font-semibold py-1 px-2 rounded-md">Report Generator</a></li>
                    <li><a href="charges.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Charge Calculator</a></li>
                </ul>
            </nav>
            <div class="flex items-center ml-4">
                <button id="save-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mr-2">Save Report</button>
                <button id="view-saved-reports-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mr-2">View Saved Reports</button>
            </div>
        </div>
    </header>

    <!-- Main Content Section: MDT Report Interface -->
    <main class="bg-gray-900 text-white min-h-screen">
        <div class="flex items-center justify-between p-4 bg-gray-800 text-white rounded-b-lg shadow-md">
            <div class="flex-grow text-center">
                <h1 id="caseTitle" class="text-lg md:text-2xl font-bold">New Case</h1>
            </div>
            <div>
                <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Delete</button>
            </div>
        </div>

        <!-- Main Report Body Container -->
        <div class="p-4 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Left Column -->
            <div class="col-span-1 flex flex-col space-y-4">
                <!-- Evidence Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Evidence</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="evidence-list">+ Add</button>
                    </div>
                    <ul id="evidence-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO ATTACHED EVIDENCE">
                        <li class="placeholder-item p-2 border border-gray-700 rounded-md">NO ATTACHED EVIDENCE</li>
                    </ul>
                </div>
                <!-- Linked Reports Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Linked Reports</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="linked-reports-list">+ Add</button>
                    </div>
                    <ul id="linked-reports-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO LINKED REPORTS">
                        <li class="placeholder-item p-2 border border-gray-700 rounded-md">NO LINKED REPORTS</li>
                    </ul>
                </div>
                <!-- Description Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Description</h3>
                        <button id="generate-report-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">
                            Generate with AI
                        </button>
                    </div>
                    <div id="description-loading-container" class="hidden flex justify-center items-center flex-grow bg-gray-700 rounded-b-lg">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                    </div>
                    <textarea id="report-description" placeholder="Enter the initial debrief or summary of the incident here..." class="w-full flex-grow p-2 bg-gray-700 text-white rounded-b-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-600" style="min-height: 200px;"></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-span-1 flex flex-col space-y-4">
                <!-- Tags Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Tags</h3>
                        <button class="add-item-btn bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-list-id="tags-list">+ Add</button>
                    </div>
                    <ul id="tags-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO TAGS">
                        <li class="placeholder-item p-2 border border-gray-700 rounded-md">NO TAGS</li>
                    </ul>
                </div>
                <!-- Officers Involved Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Officers Involved</h3>
                        <button id="add-officer-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <ul id="officers-list" class="space-y-1 text-sm text-gray-400" data-placeholder="NO OFFICERS INVOLVED">
                        <li class="placeholder-item p-2 border border-gray-700 rounded-md">NO OFFICERS INVOLVED</li>
                    </ul>
                </div>
                <!-- Criminals Involved Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg">Criminals Involved</h3>
                        <button id="add-criminal-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">+ Add</button>
                    </div>
                    <ul id="criminals-list" class="space-y-4 text-sm text-gray-400" data-placeholder="NO CRIMINALS INVOLVED">
                        <li class="placeholder-item p-2 border border-gray-700 rounded-md">NO CRIMINALS INVOLVED</li>
                    </ul>
                </div>

                <!-- Report Details Section -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-lg mb-4">Report Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="postal-location" class="block text-sm font-medium text-gray-400">Postal/Location</label>
                            <input type="text" id="postal-location" placeholder="Enter postal code or address" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div>
                            <label for="level-of-force" class="block text-sm font-medium text-gray-400">Level of Force</label>
                            <select id="level-of-force" class="w-full p-2 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option>None</option>
                                <option>Verbal Commands</option>
                                <option>Physical Restraint</option>
                                <option>Taser Deployment</option>
                                <option>Lethal Force</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="addItemModal" class="report-modal-overlay hidden">
        <div class="report-modal-content">
            <h3 class="text-xl font-bold mb-4">Add Item</h3>
            <input type="text" id="addItemInput" placeholder="Enter item name..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md">
            <div class="flex justify-end space-x-2">
                <button id="closeAddItemModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="saveAddItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add</button>
            </div>
        </div>
    </div>
    <div id="addOfficerModal" class="report-modal-overlay hidden">
        <div class="report-modal-content">
            <h3 class="text-xl font-bold mb-4">Add Officer</h3>
            <input type="text" id="officer-search-input" placeholder="Search for an officer..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md">
            <div id="officer-list-loading" class="flex justify-center items-center h-24 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
            <div id="officer-list-container" class="space-y-2 max-h-64 overflow-y-auto mb-4 p-2 bg-gray-700 rounded-md"></div>
            <p id="officer-list-error" class="text-red-400 text-sm hidden">Failed to load officer data.</p>
            <div class="flex justify-end space-x-2">
                <button id="closeAddOfficerModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="saveAddOfficerBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Add Selected</button>
            </div>
        </div>
    </div>
    <div id="addCriminalModal" class="report-modal-overlay hidden">
        <div class="report-modal-content">
            <h3 class="text-xl font-bold mb-4">Add Criminal</h3>
            <input type="text" id="criminalNameInput" placeholder="Enter criminal's name..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md">
            <div class="flex justify-end space-x-2">
                <button id="closeAddCriminalModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="saveAddCriminalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add</button>
            </div>
        </div>
    </div>
    <div id="addChargeModal" class="report-modal-overlay hidden">
        <div class="report-modal-content">
            <h3 class="text-xl font-bold mb-4">Add Charge</h3>
            <input type="text" id="charge-search-input" placeholder="Search for a charge..." class="w-full p-3 mb-4 bg-gray-700 text-white rounded-md">
            <div id="charge-list-loading" class="flex justify-center items-center h-24 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
            <div id="charge-list-container" class="space-y-4 max-h-[60vh] overflow-y-auto mb-4 p-2 bg-gray-800 rounded-md"></div>
            <p id="charge-list-error" class="text-red-400 text-sm hidden">Failed to load charge data.</p>
            <div class="flex justify-end space-x-2">
                <button id="closeAddChargeModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="saveAddChargeBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Add Selected</button>
            </div>
        </div>
    </div>
    <div id="viewReportsModal" class="report-modal-overlay hidden">
        <div class="report-modal-content">
            <h3 class="text-xl font-bold mb-4">Saved Reports</h3>
            <div id="saved-reports-loading" class="flex justify-center items-center h-24">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
            <div id="saved-reports-list" class="space-y-2 max-h-[60vh] overflow-y-auto mb-4 p-2 bg-gray-800 rounded-md"></div>
            <div class="flex justify-end">
                <button id="closeViewReportsModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    <div id="deleteConfirmationModal" class="report-modal-overlay hidden">
        <div class="report-modal-content">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete this report? This action cannot be undone.</p>
            <div class="flex justify-end space-x-2">
                <button id="cancelDeleteBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        let db, auth, userId;

        // =================================================================================
        // CONFIGURATION: Add your own Firebase and API keys here
        // =================================================================================

        //UPDATED: Firebase configuration with your project details.
        const firebaseConfig = {
            apiKey: "AIzaSyDU7DRAxCzqu81DTa7k0DXaBRcMpk0sElc",
            authDomain: "upd-system.firebaseapp.com",
            projectId: "upd-system",
            storageBucket: "upd-system.appspot.com",
            messagingSenderId: "28223003678",
            appId: "1:28223003678:web:d8b2c8a22a3f7d1b3e4f5a" // This App ID is from your original file.
        };

        //UPDATED: Gemini API Key has been added.
        const geminiApiKey = 'AIzaSyAbU7k_19bBgnGpFtX742tYGwLySd_U3fI';

        //TODO: Add your own Discord Webhook URL here to receive report notifications.
        const discordWebhookUrl = 'YOUR_DISCORD_WEBHOOK_URL';

        // =================================================================================
        // Firebase Initialization
        // =================================================================================
        const appId = 'report-generator';

        try {
            const app = window.firebase.initializeApp(firebaseConfig);
            auth = window.firebase.getAuth(app);
            db = window.firebase.getFirestore(app);
            console.log("Firebase Initialized");

            window.firebase.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User is signed in with UID:", userId);
                    loadReportsFromFirestore();
                } else {
                    try {
                        await window.firebase.signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error signing in anonymously:", error);
                    }
                }
            });
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Firebase could not be initialized. Please check your firebaseConfig in the script.");
        }

        // =================================================================================
        // Main Application Logic
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {

            // --- Modal Management ---
            const addItemModal = document.getElementById('addItemModal');
            const addOfficerModal = document.getElementById('addOfficerModal');
            const addCriminalModal = document.getElementById('addCriminalModal');
            const addChargeModal = document.getElementById('addChargeModal');
            const viewReportsModal = document.getElementById('viewReportsModal');
            const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');

            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            // Generic item adding
            let currentListId = null;
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.addEventListener('click', () => {
                    currentListId = button.dataset.listId;
                    openModal(addItemModal);
                });
            });

            document.getElementById('saveAddItemBtn').addEventListener('click', () => {
                const input = document.getElementById('addItemInput');
                const list = document.getElementById(currentListId);
                if (input.value.trim() && list) {
                    if (list.querySelector('.placeholder-item')) {
                        list.innerHTML = '';
                    }
                    addListItem(list, input.value.trim());
                    input.value = '';
                    closeModal(addItemModal);
                }
            });

            // Specific modals
            document.getElementById('add-officer-btn').addEventListener('click', () => {
                openModal(addOfficerModal);
                if (allOfficers.length === 0) fetchAllOfficerData();
            });
            document.getElementById('add-criminal-btn').addEventListener('click', () => openModal(addCriminalModal));
            document.getElementById('save-report-btn').addEventListener('click', saveReportToFirestore);
            document.getElementById('view-saved-reports-btn').addEventListener('click', () => openModal(viewReportsModal));
            document.getElementById('deleteBtn').addEventListener('click', () => openModal(deleteConfirmationModal));

            // Close buttons
            document.getElementById('closeAddItemModalBtn').addEventListener('click', () => closeModal(addItemModal));
            document.getElementById('closeAddOfficerModalBtn').addEventListener('click', () => closeModal(addOfficerModal));
            document.getElementById('closeAddCriminalModalBtn').addEventListener('click', () => closeModal(addCriminalModal));
            document.getElementById('closeAddChargeModalBtn').addEventListener('click', () => closeModal(addChargeModal));
            document.getElementById('closeViewReportsModalBtn').addEventListener('click', () => closeModal(viewReportsModal));
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal(deleteConfirmationModal));

            // --- List Management ---
            function addListItem(list, text) {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between p-2 border border-gray-700 rounded-md bg-gray-700 text-white";
                li.innerHTML = `<span>${text}</span><button class="remove-item-btn text-red-400 hover:text-red-500 text-2xl font-bold">&times;</button>`;
                list.appendChild(li);
            }

            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-item-btn')) {
                    const listItem = e.target.closest('li');
                    const list = listItem.parentElement;
                    listItem.remove();
                    if (list.children.length === 0) {
                        const placeholderText = list.dataset.placeholder || 'NO ITEMS';
                        list.innerHTML = `<li class="placeholder-item p-2 border border-gray-700 rounded-md">${placeholderText}</li>`;
                    }
                }
            });

            // --- Officer & Charge Data Fetching ---
            let allOfficers = [];
            let allCharges = [];

            const officerSheets = {
                'upd': { name: 'UPD', publishedKey: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi', gid: '0' }
                // Add other departments here if needed
            };
            const chargesSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQa6HZQ9JM5Unzwe4zZDX8A21m6zV4oGvDuEbSEqA9f3m3CqplUUUlmCScNHf79a8Sr1nem0div9YT2/pub?output=csv';

            async function fetchAllOfficerData() {
                const container = document.getElementById('officer-list-container');
                const loading = document.getElementById('officer-list-loading');
                loading.classList.remove('hidden');

                try {
                    const responses = await Promise.all(
                        Object.values(officerSheets).map(sheet =>
                            fetch(`https://docs.google.com/spreadsheets/d/e/${sheet.publishedKey}/pub?gid=${sheet.gid}&single=true&output=csv`)
                        )
                    );
                    const texts = await Promise.all(responses.map(res => res.text()));
                    allOfficers = texts.flatMap(text => parseCSV(text, 'name')).filter(Boolean).sort();
                    populateList(container, allOfficers, 'officer-item', (name) => name);
                } catch (error) {
                    console.error('Error fetching officer data:', error);
                    document.getElementById('officer-list-error').classList.remove('hidden');
                } finally {
                    loading.classList.add('hidden');
                }
            }

            async function fetchChargeData() {
                const container = document.getElementById('charge-list-container');
                const loading = document.getElementById('charge-list-loading');
                loading.classList.remove('hidden');
                try {
                    const response = await fetch(chargesSheetUrl);
                    const csvText = await response.text();
                    allCharges = parseChargeCSV(csvText);
                    populateChargeList(allCharges);
                } catch (error) {
                    console.error('Error fetching charges:', error);
                    document.getElementById('charge-list-error').classList.remove('hidden');
                } finally {
                    loading.classList.add('hidden');
                }
            }

            function parseCSV(csv, columnName) {
                const lines = csv.split('\n');
                const items = [];
                if (lines.length < 1) return items;
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
                const colIndex = headers.indexOf(columnName.toLowerCase());
                if (colIndex === -1) return items;

                for (let i = 1; i < lines.length; i++) {
                    const columns = lines[i].split(',');
                    if (columns[colIndex]) {
                        const item = columns[colIndex].trim().replace(/^"|"$/g, '');
                        if (item) items.push(item);
                    }
                }
                return items;
            }

            function parseChargeCSV(csv) {
                // Simplified parser for demo
                const lines = csv.split('\n').slice(1); // Skip header
                return lines.map(line => {
                    const parts = line.split(',');
                    return {
                        penalCode: parts[0] || 'N/A',
                        chargeName: parts[1] || 'N/A',
                        description: parts[2] || 'N/A',
                        jailTime: parts[3] || 'N/A',
                        fineAmount: parts[4] || 'N/A',
                    };
                }).filter(c => c.chargeName !== 'N/A');
            }

            function populateList(container, data, itemClass, textFn) {
                container.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `${itemClass} p-2 rounded-md cursor-pointer hover:bg-gray-600 border border-gray-700`;
                    div.textContent = textFn(item);
                    div.dataset.value = typeof item === 'string' ? item : JSON.stringify(item);
                    container.appendChild(div);
                });
            }

            function populateChargeList(charges) {
                const container = document.getElementById('charge-list-container');
                container.innerHTML = ''; // Clear previous list
                charges.forEach(charge => {
                    const div = document.createElement('div');
                    div.className = 'charge-item p-3 rounded-md cursor-pointer bg-red-800 hover:bg-red-700 border border-gray-600';
                    div.dataset.value = `${charge.penalCode}: ${charge.chargeName}`;
                    div.innerHTML = `
                            <p class="font-bold text-white">${charge.chargeName}</p>
                            <p class="text-xs text-gray-400">${charge.penalCode}</p>
                            <p class="text-sm text-gray-300 mt-1">${charge.description}</p>
                            <div class="text-right text-xs mt-1"><span>${charge.jailTime} Months / ${charge.fineAmount}</span></div>
                        `;
                    container.appendChild(div);
                });
            }

            // --- Selection & Saving from Modals ---
            let selectedOfficers = [];
            let selectedCharges = [];
            let currentChargesList = null;

            document.getElementById('officer-list-container').addEventListener('click', e => {
                if (e.target.classList.contains('officer-item')) {
                    e.target.classList.toggle('selected');
                    selectedOfficers = Array.from(document.querySelectorAll('.officer-item.selected')).map(el => el.dataset.value);
                    document.getElementById('saveAddOfficerBtn').disabled = selectedOfficers.length === 0;
                }
            });

            document.getElementById('charge-list-container').addEventListener('click', e => {
                const target = e.target.closest('.charge-item');
                if (target) {
                    target.classList.toggle('selected');
                    selectedCharges = Array.from(document.querySelectorAll('.charge-item.selected')).map(el => el.dataset.value);
                    document.getElementById('saveAddChargeBtn').disabled = selectedCharges.length === 0;
                }
            });

            document.getElementById('saveAddOfficerBtn').addEventListener('click', () => {
                const list = document.getElementById('officers-list');
                if (list.querySelector('.placeholder-item')) list.innerHTML = '';
                selectedOfficers.forEach(officer => addListItem(list, officer));
                closeModal(addOfficerModal);
            });

            document.getElementById('saveAddCriminalBtn').addEventListener('click', () => {
                const name = document.getElementById('criminalNameInput').value.trim();
                if (!name) return;
                const list = document.getElementById('criminals-list');
                if (list.querySelector('.placeholder-item')) list.innerHTML = '';

                const li = document.createElement('li');
                li.className = 'p-4 border border-gray-700 rounded-md bg-gray-800';
                li.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-lg">${name}</h4>
                            <button class="remove-item-btn text-red-400 hover:text-red-500 text-2xl">&times;</button>
                        </div>
                        <h5 class="text-md font-semibold">Charges:</h5>
                        <ul class="charges-list list-disc list-inside space-y-1 text-gray-400" data-placeholder="No charges added yet.">
                            <li class="placeholder-item">No charges added yet.</li>
                        </ul>
                        <button class="add-charge-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded-full mt-2">+ Add Charge</button>
                    `;
                list.appendChild(li);
                document.getElementById('criminalNameInput').value = '';
                closeModal(addCriminalModal);
            });

            document.getElementById('criminals-list').addEventListener('click', e => {
                if (e.target.classList.contains('add-charge-btn')) {
                    currentChargesList = e.target.previousElementSibling;
                    openModal(addChargeModal);
                    if (allCharges.length === 0) fetchChargeData();
                }
            });

            document.getElementById('saveAddChargeBtn').addEventListener('click', () => {
                if (!currentChargesList) return;
                if (currentChargesList.querySelector('.placeholder-item')) currentChargesList.innerHTML = '';
                selectedCharges.forEach(charge => addListItem(currentChargesList, charge));

                // Reset selection
                document.querySelectorAll('.charge-item.selected').forEach(el => el.classList.remove('selected'));
                selectedCharges = [];
                document.getElementById('saveAddChargeBtn').disabled = true;

                closeModal(addChargeModal);
            });


            // --- AI Report Generation ---
            document.getElementById('generate-report-btn').addEventListener('click', async () => {
                if (!geminiApiKey || geminiApiKey === 'YOUR_GEMINI_API_KEY') {
                    alert("Please add your Gemini API Key to the script file.");
                    return;
                }

                const descriptionLoading = document.getElementById('description-loading-container');
                const reportTextarea = document.getElementById('report-description');
                descriptionLoading.classList.remove('hidden');
                reportTextarea.classList.add('hidden');

                const officers = getListData('officers-list');
                const criminals = getCriminalData();

                const prompt = `
                        You are a police officer writing a formal report. Use the following data to create a comprehensive, first-person narrative in Markdown format.

                        **Initial Debrief from User:**
                        "${reportTextarea.value}"

                        **Involved Officers:**
                        - ${officers.join('\n- ') || 'None'}

                        **Arrested Individuals & Charges:**
                        ${criminals.map(c => `- **${c.name}**: ${c.charges.join(', ')}`).join('\n') || '- None'}

                        **Location:** ${document.getElementById('postal-location').value || 'N/A'}
                        **Level of Force:** ${document.getElementById('level-of-force').value || 'N/A'}

                        Structure the report with the following sections:
                        1.  **I. Administrative Details:** (Date, Time, Location, Officers)
                        2.  **II. Chronological Incident Debrief:** (Expand on the user's debrief in a formal narrative.)
                        3.  **III. Persons Involved:** (List suspects and their charges.)
                        4.  **IV. Justification for Actions:** (Explain the use of force and the reasons for the charges based on the debrief.)
                        5.  **V. Evidence:** (Mention any evidence from the debrief.)
                    `;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API error: ${response.status}`);

                    const result = await response.json();
                    reportTextarea.value = result.candidates[0].content.parts[0].text;

                    // Also send a notification to Discord
                    await sendDiscordReportNotification(criminals, officers);

                } catch (error) {
                    console.error('Error generating report:', error);
                    reportTextarea.value = `Error: Could not generate report. ${error.message}`;
                } finally {
                    descriptionLoading.classList.add('hidden');
                    reportTextarea.classList.remove('hidden');
                }
            });

            // --- Data Persistence (Firestore & Local) ---
            const getReportDataAsObject = () => ({
                caseTitle: document.getElementById('caseTitle').textContent,
                description: document.getElementById('report-description').value,
                location: document.getElementById('postal-location').value,
                forceLevel: document.getElementById('level-of-force').value,
                evidence: document.getElementById('evidence-list').innerHTML,
                linkedReports: document.getElementById('linked-reports-list').innerHTML,
                tags: document.getElementById('tags-list').innerHTML,
                officers: document.getElementById('officers-list').innerHTML,
                criminals: document.getElementById('criminals-list').innerHTML,
            });

            const populateFormWithData = (data) => {
                document.getElementById('caseTitle').textContent = data.caseTitle;
                document.getElementById('report-description').value = data.description;
                document.getElementById('postal-location').value = data.location;
                document.getElementById('level-of-force').value = data.forceLevel;
                document.getElementById('evidence-list').innerHTML = data.evidence;
                document.getElementById('linked-reports-list').innerHTML = data.linkedReports;
                document.getElementById('tags-list').innerHTML = data.tags;
                document.getElementById('officers-list').innerHTML = data.officers;
                document.getElementById('criminals-list').innerHTML = data.criminals;
            };

            window.saveReportToFirestore = async () => {
                if (!db || !userId) {
                    alert("Firebase is not ready. Cannot save report.");
                    return;
                }
                const reportData = getReportDataAsObject();
                reportData.authorId = userId;
                reportData.createdAt = new Date().toISOString();
                try {
                    await window.firebase.addDoc(window.firebase.collection(db, `artifacts/${appId}/public/data/reports`), reportData);
                    alert("Report saved successfully!");
                } catch (error) {
                    console.error("Error saving report:", error);
                    alert("Failed to save report.");
                }
            };

            window.loadReportsFromFirestore = () => {
                if (!db || !userId) return;
                const reportsCollection = window.firebase.collection(db, `artifacts/${appId}/public/data/reports`);
                const q = window.firebase.query(reportsCollection, window.firebase.where("authorId", "==", userId));
                const listEl = document.getElementById('saved-reports-list');
                const loadingEl = document.getElementById('saved-reports-loading');

                window.firebase.onSnapshot(q, (snapshot) => {
                    loadingEl.classList.add('hidden');
                    listEl.innerHTML = '';
                    if (snapshot.empty) {
                        listEl.innerHTML = '<p class="text-center text-gray-400">No saved reports found.</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const report = { id: doc.id, ...doc.data() };
                        const div = document.createElement('div');
                        div.className = 'p-3 rounded-md cursor-pointer bg-gray-700 hover:bg-gray-600';
                        div.dataset.reportId = report.id;
                        div.innerHTML = `
                                <h4 class="font-bold text-white">${report.caseTitle || 'Untitled Report'}</h4>
                                <p class="text-xs text-gray-400">Saved: ${new Date(report.createdAt).toLocaleString()}</p>
                            `;
                        div.addEventListener('click', () => loadSpecificReport(report.id));
                        listEl.appendChild(div);
                    });
                }, (error) => {
                    console.error("Error loading reports:", error);
                    listEl.innerHTML = '<p class="text-center text-red-400">Failed to load reports.</p>';
                });
            };

            async function loadSpecificReport(reportId) {
                if (!db) return;
                try {
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/public/data/reports`, reportId);
                    const docSnap = await window.firebase.getDoc(docRef);
                    if (docSnap.exists()) {
                        populateFormWithData(docSnap.data());
                        closeModal(viewReportsModal);
                    } else {
                        alert("Could not find the selected report.");
                    }
                } catch (error) {
                    console.error("Error loading specific report:", error);
                }
            }

            // Delete confirmation
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                // This would be where you delete from Firestore if a report is loaded
                // For now, it just clears the form
                document.querySelectorAll('ul').forEach(ul => {
                    const placeholderText = ul.dataset.placeholder || 'NO ITEMS';
                    ul.innerHTML = `<li class="placeholder-item p-2 border border-gray-700 rounded-md">${placeholderText}</li>`;
                });
                document.getElementById('caseTitle').textContent = 'New Case';
                document.getElementById('report-description').value = '';
                document.getElementById('postal-location').value = '';
                document.getElementById('level-of-force').value = 'None';
                closeModal(deleteConfirmationModal);
            });

            // --- Helper Functions ---
            const getListData = (listId) => Array.from(document.querySelectorAll(`#${listId} li:not(.placeholder-item) span`)).map(span => span.textContent);

            const getCriminalData = () => Array.from(document.querySelectorAll('#criminals-list > li:not(.placeholder-item)')).map(li => ({
                name: li.querySelector('h4').textContent,
                charges: Array.from(li.querySelectorAll('.charges-list li:not(.placeholder-item) span')).map(span => span.textContent)
            }));

            async function sendDiscordReportNotification(criminals, officers) {
                if (!discordWebhookUrl || discordWebhookUrl === 'YOUR_DISCORD_WEBHOOK_URL') {
                    console.log("Discord webhook URL not configured. Skipping notification.");
                    return;
                }

                const payload = {
                    username: "UPD Report Bot",
                    avatar_url: "https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png",
                    embeds: [{
                        title: "New Incident Report Filed",
                        color: 15158332, // Red
                        fields: [
                            { name: "Suspect(s)", value: "```" + (criminals.map(c => c.name).join('\n') || 'N/A') + "```" },
                            { name: "Involved Officer(s)", value: "```" + (officers.join('\n') || 'N/A') + "```" },
                            { name: "Charges Filed", value: "```" + (criminals.flatMap(c => c.charges).join('\n') || 'None') + "```" }
                        ],
                        timestamp: new Date().toISOString()
                    }]
                };

                try {
                    await fetch(discordWebhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (error) {
                    console.error('Error sending Discord notification:', error);
                }
            }
        });

    </script>
</body>
</html>
