<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono&effect=outline" rel="stylesheet" type="text/css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'); /* Added Inter font */

        @font-face {
            font-family: instruction;
            src: url(Lekton-Italic.ttf);
        }

        body {
            background-color: rgba(0, 0, 0, 0);
            margin: 0px auto;
            overflow: hidden;
            font-family: 'Inter', instruction, monospace; /* Prioritize Inter, fallback to instruction and monospace */
            font-size: 13px;
            color: #AFAFAF;
        }

        .Blink {
            animation: blinker 1.5s cubic-bezier(.5, 0, 1, 1) infinite alternate;
        }

        @keyframes blinker {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .top-right {
            float: right;
            width: auto;
            text-align: right;
        }

        .top-right-container {
            float: right;
            width: auto;
            text-align: right;
            /* edit the fourth value of the next line to change opacity */
            /* 0.0 is clear, 1.0 is completely opaque                   */
            background-color: rgba(0,0,0,0.5);
            padding: 5px;
            margin: 10px;
            -moz-border-radius: 10px;
            -webkit-border-radius: 10px;
            border-radius: 10px;
        }

        .container {
            width: 100wh;
            height: 100vh;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw; /* Use viewport width */
            height: 100vh; /* Use viewport height */
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Very high z-index */
        }

        .modal-content {
            background-color: #1f2937; /* dark gray background */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            width: 500px; /* Adjusted width for better readability */
            color: #e5e7eb; /* light gray text */
        }

        .officer-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            color: #1f2937;
        }

            .officer-item:hover {
                background-color: #d1d5db; /* Light gray hover */
            }

        /* Loading indicator styles */
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #logoutLogo {
            cursor: pointer; /* Add a pointer cursor to indicate it's clickable */
        }
    </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Added viewport meta tag for responsiveness -->
    <title>XION Bodycam Overlay</title>
</head>

<body>
    <audio id="beep" autoplay loop>
        <source src="double-beep.wav" type="audio/wav">
    </audio>

    <div class="top-right-container">
        <div class="top-right">
            <!-- LSPD Logo - Added id="logoutLogo" to make it clickable for logout -->
            <img id="logoutLogo" src="LSPD.png" width="64" height="64" border="0" onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
        </div>
        <div class="top-right">
            REC&nbsp;<i class="fa fa-circle text-danger Blink"></i>&nbsp;&nbsp;AXON&nbsp;BODYCAM&trade;&nbsp;&nbsp;<br />
            <span id="player">N/A</span> <!-- Default placeholder -->
            <span id="callsign">[N/A]</span>&nbsp;&nbsp;<br /> <!-- Default placeholder -->
            <span id="agency">N/A</span>&nbsp;&nbsp;<br /> <!-- Default placeholder -->
            <span style="padding:0px;margin:0px;" id="date-span">00 XXX 0000</span>
            <span style="padding:0px;margin:0px;" id="time-span">00:00:00</span>&nbsp;&nbsp;
            <button id="loginButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded-md text-xs mt-2" style="display: none;">Log In</button>
        </div>
    </div>

    <!-- Officer Selection Modal -->
    <div id="officerSelectionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-200 mb-4">Select Officer or Enter Manually</h3>

            <!-- Manual Entry Section -->
            <div class="mb-4 p-4 border border-gray-600 rounded-lg">
                <input type="text" id="manualNameInput" placeholder="Enter Name" class="w-full px-4 py-2 border border-gray-500 bg-gray-700 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                <input type="text" id="manualBadgeInput" placeholder="Enter Badge Number" class="w-full px-4 py-2 border border-gray-500 bg-gray-700 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                <select id="manualDepartmentSelect" class="w-full px-4 py-2 border border-gray-500 bg-gray-700 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                    <option value="LSPD">LSPD</option>
                    <option value="LSCSO">LSCSO</option>
                    <option value="State Police">State Police</option>
                </select>
                <button id="manualLoginBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Log In Manually
                </button>
            </div>

            <div class="text-center my-2 text-gray-400">OR</div>

            <input type="text"
                   id="officerSearchInput"
                   placeholder="Search officer from roster..."
                   class="w-full px-4 py-2 border border-gray-500 bg-gray-700 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div id="officerList" class="max-h-64 overflow-y-auto border border-gray-600 rounded-lg p-2 mb-4 bg-gray-200">
                <!-- Officer list will be populated here -->
                <div class="loader mx-auto my-4"></div> <!-- Loader for officer list -->
            </div>
            <div class="flex justify-end space-x-4">
                <button id="closeOfficerModalBtn"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>
</body>

<script>
        const monthNames = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

        // Get references to elements
        const playerSpan = document.getElementById('player');
        const callsignSpan = document.getElementById('callsign');
        const agencySpan = document.getElementById('agency');
        const loginButton = document.getElementById('loginButton');
        const logoutLogo = document.getElementById('logoutLogo'); // Get reference to the logo

        // Officer Selection Modal Elements
        const officerSelectionModal = document.getElementById('officerSelectionModal');
        const officerSearchInput = document.getElementById('officerSearchInput');
        const officerListDiv = document.getElementById('officerList');
        const closeOfficerModalBtn = document.getElementById('closeOfficerModalBtn');

        // Manual Login Elements
        const manualNameInput = document.getElementById('manualNameInput');
        const manualBadgeInput = document.getElementById('manualBadgeInput');
        const manualDepartmentSelect = document.getElementById('manualDepartmentSelect');
        const manualLoginBtn = document.getElementById('manualLoginBtn');

        // Global variable to store fetched officer roster data
        let officerRosterData = [];

        /**
         * Converts an Excel-style column letter (e.g., 'A', 'B', 'AA') to a 0-based index.
         * @param {string} columnLetter - The column letter (e.g., 'C').
         * @returns {number} The 0-based column index (e.g., 'C' returns 2).
         */
        function columnLetterToIndex(columnLetter) {
            let index = 0;
            for (let i = 0; i < columnLetter.length; i++) {
                index = index * 26 + (columnLetter.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
            }
            return index - 1; // Convert to 0-based index
        }

        // Configuration for different department sheets
        const departmentSheetConfig = {
            "LSPD": {
                sheetId: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                gid: '0',
                rowRanges: [
                    { start: 6, end: 6 }, { start: 9, end: 16 }, { start: 18, end: 22 },
                    { start: 24, end: 27 }, { start: 29, end: 32 }, { start: 34, end: 43 },
                    { start: 45, end: 54 }, { start: 56, end: 65 }, { start: 67, end: 78 },
                    { start: 80, end: 96 }, { start: 98, end: 117 }, { start: 119, end: 148 }
                ]
            },
            "LSCSO": {
                sheetId: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                gid: '1747285908',
                rowRanges: null
            },
            "State Police": {
                sheetId: '2PACX-1vT8yueJjp9o-XVH1_RXPji6N_IAP1DDbNLZ8l4__IqGCvVEUWscsdsJ6uNHZ8u6kDhhXkSxcdkdeDJi',
                gid: '394994291',
                rowRanges: null
            }
        };

        /**
         * Fetches CSV data from a Google Sheet, parses it, and populates the officerRosterData.
         * @param {string} department - The department for which to fetch the roster.
         */
        async function fetchOfficerRosterData(department) {
            officerListDiv.innerHTML = '<div class="loader mx-auto my-4"></div>';

            const config = departmentSheetConfig[department];
            if (!config) {
                console.error(`Configuration not found for department: ${department}`);
                officerListDiv.innerHTML = '<p class="text-red-500 text-center py-4">Department roster config missing.</p>';
                officerRosterData = [];
                return;
            }

            const csvUrl = `https://docs.google.com/spreadsheets/d/e/${config.sheetId}/pub?gid=${config.gid}&single=true&output=csv`;

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                const rawRows = csvText.trim().split('\n');
                if (rawRows.length === 0) {
                    officerRosterData = [];
                    officerListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No officers found.</p>';
                    return;
                }

                const filteredRowsData = [];
                const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

                if (config.rowRanges) {
                    const targetRows = new Set();
                    config.rowRanges.forEach(r => { for (let i = r.start; i <= r.end; i++) targetRows.add(i); });
                    rawRows.forEach((row, i) => {
                        if (targetRows.has(i + 1)) {
                            filteredRowsData.push(row.split(regex).map(c => c.replace(/^"(.*)"$/, '$1').trim()));
                        }
                    });
                } else {
                     rawRows.slice(1).forEach(rowString => {
                        const parsedCells = rowString.split(regex).map(cell => cell.replace(/^"(.*)"$/, '$1').trim());
                        const name = parsedCells[columnLetterToIndex('D')]?.trim();
                        const badge = parsedCells[columnLetterToIndex('C')]?.trim();
                        if (name && name !== 'N/A' && badge && badge !== 'N/A') {
                            filteredRowsData.push(parsedCells);
                        }
                    });
                }

                const nameCol = columnLetterToIndex('D');
                const badgeCol = columnLetterToIndex('C');
                officerRosterData = filteredRowsData.map(row => ({
                    name: row[nameCol]?.trim() || '',
                    badge: row[badgeCol]?.trim() || '',
                    department: department
                })).filter(o => o.name && o.badge && o.name !== 'N/A' && o.badge !== 'N/A');

                populateOfficerList(officerRosterData);
            } catch (error) {
                console.error(`Error fetching roster for ${department}:`, error);
                officerListDiv.innerHTML = `<p class="text-red-500 text-center py-4">Failed to load roster.</p>`;
            }
        }

        /**
         * Populates the officer list in the modal.
         * @param {Array<Object>} officers - The array of officer objects.
         * @param {string} [searchTerm=''] - The search term to filter officers.
         */
        function populateOfficerList(officers, searchTerm = '') {
            officerListDiv.innerHTML = '';
            const filtered = officers.filter(o =>
                o.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                o.badge.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filtered.length === 0) {
                officerListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No officers found.</p>';
                return;
            }

            filtered.forEach(officer => {
                const div = document.createElement('div');
                div.className = 'officer-item p-2 rounded-md hover:bg-blue-100 cursor-pointer text-gray-800 text-sm font-medium';
                div.textContent = `${officer.name} (${officer.badge})`;
                div.addEventListener('click', () => selectOfficer(officer));
                officerListDiv.appendChild(div);
            });
        }

        /**
         * Sets the selected officer's data and updates the UI.
         * @param {object} officer - The officer object {name, badge, department}.
         */
        function selectOfficer(officer) {
            playerSpan.innerHTML = officer.name;
            callsignSpan.innerHTML = `[${officer.badge}]`;
            agencySpan.innerHTML = officer.department;
            localStorage.setItem('loggedInOfficer', JSON.stringify(officer));
            officerSelectionModal.classList.add('hidden');
            loginButton.style.display = 'none';
        }

        /**
         * Logs in an officer using manually entered details.
         */
        function manualLogin() {
            const name = manualNameInput.value.trim();
            const badge = manualBadgeInput.value.trim();
            const department = manualDepartmentSelect.value;
            if (!name || !badge) {
                console.error("Name and Badge cannot be empty for manual login.");
                // You could add a visual indicator for the error here
                return;
            }
            selectOfficer({ name, badge, department });
            manualNameInput.value = '';
            manualBadgeInput.value = '';
        }

        /**
         * Logs the current officer out.
         */
        function logout() {
            localStorage.removeItem('loggedInOfficer');
            playerSpan.innerHTML = "N/A";
            callsignSpan.innerHTML = "[N/A]";
            agencySpan.innerHTML = "N/A";
            loginButton.style.display = 'block';
            console.log("Officer logged out.");
        }

        /**
         * Initializes the overlay.
         */
        async function init(){
            const loggedInOfficerJSON = localStorage.getItem('loggedInOfficer');
            let initialDepartment = "LSPD";

            if (loggedInOfficerJSON) {
                try {
                    const officer = JSON.parse(loggedInOfficerJSON);
                    selectOfficer(officer);
                    initialDepartment = officer.department || "LSPD";
                } catch (e) {
                    console.error("Error parsing loggedInOfficer from localStorage:", e);
                    logout(); // Clear corrupted data and reset UI
                }
            } else {
                loginButton.style.display = 'block';
            }

            await fetchOfficerRosterData(initialDepartment);
            clock();
        };

        /**
         * Gets the current local time.
         * @returns {Date} The current local Date object.
         */
        function getLocalTime() {
            return new Date();
        }

        /**
         * Updates the clock display continuously.
         */
        function clock(){
            const d = getLocalTime();
            const h = ("0" + d.getHours()).slice(-2);
            const m = ("0" + d.getMinutes()).slice(-2);
            const s = ("0" + d.getSeconds()).slice(-2);
            const day = ("0" + d.getDate()).slice(-2);
            const month = monthNames[d.getMonth()];
            const year = d.getFullYear();

            document.getElementById('time-span').innerHTML = `${h}:${m}:${s}`;
            document.getElementById('date-span').innerHTML = `${day}-${month}-${year}`;

            setTimeout(clock, 1000);
        };

        // --- EVENT LISTENERS ---
        logoutLogo.addEventListener('click', logout);
        manualLoginBtn.addEventListener('click', manualLogin);
        loginButton.addEventListener('click', () => {
            officerSelectionModal.classList.remove('hidden');
            officerSearchInput.value = '';
            fetchOfficerRosterData("LSPD");
        });
        officerSearchInput.addEventListener('input', (e) => {
            populateOfficerList(officerRosterData, e.target.value);
        });
        closeOfficerModalBtn.addEventListener('click', () => {
            officerSelectionModal.classList.add('hidden');
        });
        officerSelectionModal.addEventListener('click', (e) => {
            if (e.target === officerSelectionModal) {
                officerSelectionModal.classList.add('hidden');
            }
        });

        window.onload = init;
</script>

</html>
