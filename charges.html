<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPD - Offences & Charge Calculator</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Prioritize the platform-provided config, but use the hardcoded one as a fallback.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyDU7DRAxCzqu81DTa7k0DXaBRcMpk0sElc",
                authDomain: "upd-system.firebaseapp.com",
                projectId: "upd-system",
                storageBucket: "upd-system.appspot.com",
                messagingSenderId: "28223003678",
                appId: "1:28223003678:web:d1f8a6b0c2e3a4b5c6d7e8"
            };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.db = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.doc = doc;
        window.getDoc = getDoc;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display.swap');

        /* Define CSS variables for theming from index.html */
        :root {
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f1f5f9; /* slate-100 */
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #475569; /* slate-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #ffffff;
        }

        html.dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --modal-content-bg: #1e293b; /* slate-800 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Sidebar specific styles */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

            #sidebar.sidebar-hidden {
                transform: translateX(-100%);
            }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: var(--modal-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .modal-overlay.is-open {
                display: flex;
            }

        .modal-box {
            background-color: var(--modal-content-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 500px;
        }

        .data-modal-box {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

        html.dark ::-webkit-scrollbar-thumb {
            background: #555;
        }

            html.dark ::-webkit-scrollbar-thumb:hover {
                background: #777;
            }

        /* Search input specific styles */
        .search-input {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

            .search-input:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            }

        html.dark .search-input {
            background-color: #010409;
            border-color: #30363d;
        }

            html.dark .search-input:focus {
                border-color: #2f81f7;
                box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3);
            }

        /* Offense Card Styles */
        .offense-card {
            background-color: #B91C1C; /* Deep red for felonies */
            border: 2px solid #dc2626;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

            .offense-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            }

            .offense-card.selected {
                border-color: #3b82f6; /* Bright blue border for selected */
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            }

            .offense-card.infraction {
                background-color: #4a5568; /* Neutral gray for infractions */
                border-color: #718096;
            }

                .offense-card.infraction .text-red-200 {
                    color: #e2e8f0;
                }

                .offense-card.infraction .text-red-100 {
                    color: #cbd5e0;
                }

        /* Loader */
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 5rem auto;
        }

        html.dark .loader {
            border-color: #30363d;
            border-top-color: #2f81f7;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Calculator Panel */
        #calculator-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 420px;
            background-color: var(--bg-secondary);
            border-top-left-radius: 0.75rem;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }

        html.dark #calculator-panel {
            background-color: #161b22;
            border-top-color: #30363d;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
        }

        #calculator-panel.visible {
            transform: translateY(0);
        }

        #selected-charges-list {
            max-height: 150px;
        }

        /* Collapsible Category */
        .offense-grid {
            display: none;
        }

            .offense-grid.visible {
                display: grid;
            }

        .chevron-icon {
            transition: transform 0.3s ease-in-out;
        }

            .chevron-icon.rotated {
                transform: rotate(180deg);
            }
    </style>
</head>
<body class="antialiased">

    <div class="flex h-screen bg-gray-100 dark:bg-slate-900">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute md:relative z-20 flex-col w-64 bg-white dark:bg-slate-800 shadow-lg transition-transform duration-300 -translate-x-full md:translate-x-0">
            <div class="flex items-center justify-center h-20 border-b dark:border-slate-700 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png" alt="UPD Logo" class="w-12 h-12 object-contain">
                <h1 class="text-xl font-bold ml-2 text-slate-800 dark:text-white">UPD Portal</h1>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2 overflow-y-auto">
                <div>
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Core</h3>
                    <a href="index.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span class="ml-3">Dashboard</span>
                    </a>
                </div>
                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Resources</h3>
                    <a href="SOP.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="ml-3">SOPs</span>
                    </a>
                    <a href="training.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14l9-5-9-5-9 5 9 5z"></path><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14z"></path></svg>
                        <span class="ml-3">Training</span>
                    </a>
                </div>
                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Tools</h3>
                    <a href="forms.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <span class="ml-3">Forms</span>
                    </a>
                    <a href="report.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="ml-3">Report Generator</span>
                    </a>
                    <a href="charges.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg bg-slate-200 dark:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3.25a3.25 3.25 0 00-3.25-3.25H9.25A3.25 3.25 0 006 13.75V17m0 0h12M6 17H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1m-6-14v2m-6-2v2"></path></svg>
                        <span class="ml-3">Charge Calculator</span>
                    </a>
                </div>
                <div class="pt-2">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Personnel</h3>
                    <a href="roster.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a3.001 3.001 0 015.644 0M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="ml-3">Roster</span>
                    </a>
                    <a href="hr.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a4 4 0 110-8 4 4 0 010 8z"></path></svg>
                        <span class="ml-3">HR Info</span>
                    </a>
                    <a href="info.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="ml-3">Common Information</span>
                    </a>
                    <a id="highCommandLink" href="highcommand.html" class="hidden mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.789-2.75 9.566-1.74 2.777-2.5 4.434-2.5 4.434H12M12 11c0 3.517 1.009 6.789 2.75 9.566 1.74 2.777 2.5 4.434 2.5 4.434H12M12 11v-1.143c0-1.061-.416-2.078-1.172-2.834l-1.656-1.657a4.006 4.006 0 00-5.656 0l-1.657 1.657A4.006 4.006 0 002 8.857V11m10-11v-1.143c0-1.061.416-2.078 1.172-2.834l1.656-1.657a4.006 4.006 0 015.656 0l1.657 1.657A4.006 4.006 0 0122 8.857V11"></path></svg>
                        <span class="ml-3">High Command</span>
                    </a>
                </div>
                <!-- WEBSITE MANAGER LINK IN SIDEBAR -->
                <div id="websiteManagerContainer" class="pt-2 hidden">
                    <h3 class="px-3 text-xs uppercase text-slate-500 font-semibold tracking-wider">Management</h3>
                    <a id="websiteManagerLink" href="websitemanager.html" class="mt-1 flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="ml-3">Website Manager</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Header -->
            <header class="bg-white dark:bg-slate-800 shadow-md flex items-center justify-between p-4 border-b dark:border-slate-700">
                <button id="hamburgerBtn" class="text-slate-500 focus:outline-none md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div class="flex-1">
                    <h1 class="text-xl font-semibold text-slate-800 dark:text-white ml-2">Offences & Charge Calculator</h1>
                </div>
                <div class="flex items-center">
                    <div id="userInfo" class="hidden items-center">
                        <p id="userEmail" class="mr-4 text-sm text-slate-600 dark:text-slate-300"></p>
                        <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Logout</button>
                    </div>
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-all ml-4">
                        <svg class="w-6 h-6 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div><h1 class="text-3xl font-bold text-text-primary">Offences</h1></div>
                    <div class="flex items-center mt-4 sm:mt-0 w-full sm:w-auto">
                        <input type="text" id="offenseSearch" placeholder="Search Offences..." class="search-input w-full sm:w-64 px-4 py-2 rounded-md text-text-primary focus:outline-none">
                    </div>
                </div>
                <div id="offenses-container" class="space-y-8">
                    <div class="loader" id="loader"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Calculator Panel -->
    <div id="calculator-panel">
        <div class="p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-text-primary">Sentence Calculator</h3>
                <button id="clear-selection-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md transition">Clear</button>
            </div>
            <div id="selected-charges-list" class="bg-gray-200 dark:bg-gray-900 p-2 rounded-md overflow-y-auto border border-gray-300 dark:border-gray-700">
                <p class="text-gray-500 text-center text-sm">No charges selected.</p>
            </div>

            <!-- Totals -->
            <div class="grid grid-cols-2 gap-4 mt-4 text-center">
                <div>
                    <p class="text-sm text-text-secondary">Total Fine</p>
                    <p id="total-fine" class="text-xl font-bold text-green-600 dark:text-green-400">$0</p>
                </div>
                <div>
                    <p class="text-sm text-text-secondary">Total Time</p>
                    <p id="total-time" class="text-xl font-bold text-red-600 dark:text-red-400">0 Months</p>
                </div>
            </div>

            <!-- Reductions -->
            <div class="mt-4 pt-4 border-t border-border-color">
                <h4 class="font-semibold text-center mb-2">Sentence Reductions (%)</h4>
                <div class="flex justify-center items-center space-x-2 mb-3">
                    <div class="flex items-center">
                        <input id="reduction-both" type="radio" value="both" name="reduction-type" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" checked>
                        <label for="reduction-both" class="ml-2 text-sm font-medium text-text-primary">Both</label>
                    </div>
                    <div class="flex items-center">
                        <input id="reduction-fine" type="radio" value="fine" name="reduction-type" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <label for="reduction-fine" class="ml-2 text-sm font-medium text-text-primary">Fine</label>
                    </div>
                    <div class="flex items-center">
                        <input id="reduction-time" type="radio" value="time" name="reduction-type" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <label for="reduction-time" class="ml-2 text-sm font-medium text-text-primary">Time</label>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button class="reduction-btn text-sm bg-gray-200 dark:bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="5">5%</button>
                    <button class="reduction-btn text-sm bg-gray-200 dark:bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="10">10%</button>
                    <button class="reduction-btn text-sm bg-gray-200 dark:bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="15">15%</button>
                    <button class="reduction-btn text-sm bg-gray-200 dark:bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="25">25%</button>
                    <button class="reduction-btn text-sm bg-gray-200 dark:bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="50">50%</button>
                    <button class="reduction-btn text-sm bg-gray-200 dark:bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="75">75%</button>
                    <input type="number" id="custom-reduction" placeholder="Custom" class="col-span-2 text-sm bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded p-1 text-center focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Final Totals -->
            <div class="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-border-color text-center">
                <div>
                    <p class="text-sm text-text-secondary">Final Fine</p>
                    <p id="final-fine" class="text-2xl font-bold text-green-700 dark:text-green-300">$0</p>
                </div>
                <div>
                    <p class="text-sm text-text-secondary">Final Time</p>
                    <p id="final-time" class="text-2xl font-bold text-red-700 dark:text-red-300">0 Months</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modals -->
    <div id="settings-modal" class="modal-overlay"><div class="modal-box text-[var(--text-primary)]"><h2 class="text-2xl font-bold mb-6">Settings</h2><div class="mb-6"><h3 class="text-lg font-semibold mb-3">Website Theme</h3><div class="space-y-2"><label class="flex items-center"><input type="radio" name="theme" value="light" class="form-radio h-4 w-4 text-blue-600"><span class="ml-2">Light Mode</span></label><label class="flex items-center"><input type="radio" name="theme" value="dark" class="form-radio h-4 w-4 text-blue-600"><span class="ml-2">Dark Mode</span></label></div></div><div class="mb-6"><h3 class="text-lg font-semibold mb-3">Data Management</h3><div class="flex flex-col space-y-3"><button id="clear-data-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">Clear All Local Data</button><button id="view-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">View Stored Data</button></div></div><div class="mt-8 text-right"><button id="close-settings-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Close</button></div></div></div>
    <div id="view-data-modal" class="modal-overlay"><div class="modal-box data-modal-box text-[var(--text-primary)]"><h2 class="text-2xl font-bold mb-4">Local Storage Data</h2><div id="data-container" class="space-y-4 text-sm"></div><div class="mt-6 text-right"><button id="close-view-data-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Close</button></div></div></div>
    <div id="confirm-modal" class="modal-overlay"><div class="modal-box text-[var(--text-primary)]"><h2 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-text" class="mb-6">This action cannot be undone.</p><div class="flex justify-end space-x-4"><button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition">Confirm</button></div></div></div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- UNIFIED SIDEBAR & AUTH LOGIC ---
            (() => {
                const sidebar = document.getElementById('sidebar');
                const hamburgerBtn = document.getElementById('hamburgerBtn');
                const logoutButton = document.getElementById('logoutButton');
                const userInfoDiv = document.getElementById('userInfo');
                const userEmailP = document.getElementById('userEmail');
                const highCommandLink = document.getElementById('highCommandLink');
                const websiteManagerContainer = document.getElementById('websiteManagerContainer');
                const settingsModal = document.getElementById('settings-modal');
                const themeRadios = document.querySelectorAll('input[name="theme"]');
                const settingsBtn = document.getElementById('settings-btn');
                const closeSettingsBtn = document.getElementById('close-settings-btn');
                const viewDataBtn = document.getElementById('view-data-btn');
                const clearDataBtn = document.getElementById('clear-data-btn');
                const viewDataModal = document.getElementById('view-data-modal');
                const closeViewDataBtn = document.getElementById('close-view-data-btn');
                const dataContainer = document.getElementById('data-container');
                const confirmModal = document.getElementById('confirm-modal');
                const confirmOkBtn = document.getElementById('confirm-ok-btn');
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
                let confirmCallback = null;

                const applyTheme = (theme) => {
                    document.documentElement.classList.toggle('dark', theme === 'dark');
                    themeRadios.forEach(radio => radio.checked = radio.value === theme);
                };

                const updateLoginUI = async (user) => {
                    if (user) {
                        userInfoDiv.classList.remove('hidden');
                        userInfoDiv.classList.add('flex');
                        const userDocRef = window.doc(window.db, "users", user.uid);
                        const userDocSnap = await window.getDoc(userDocRef);
                        let userName = user.email;
                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            userName = userData.name || user.email;
                            const userAccessLevel = userData['access level'] || '';
                            if (userAccessLevel === 'High Command' || userAccessLevel === 'Website Manager') {
                                highCommandLink.classList.remove('hidden');
                            }
                            if (userAccessLevel === 'Website Manager') {
                                websiteManagerContainer.classList.remove('hidden');
                            }
                        }
                        userEmailP.textContent = userName;
                    } else {
                        userInfoDiv.classList.add('hidden');
                        userInfoDiv.classList.remove('flex');
                        userEmailP.textContent = '';
                        highCommandLink.classList.add('hidden');
                        websiteManagerContainer.classList.add('hidden');
                    }
                };

                window.onAuthStateChanged(window.firebaseAuth, updateLoginUI);

                hamburgerBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.toggle('-translate-x-full');
                });

                if (logoutButton) {
                    logoutButton.addEventListener('click', () => {
                        window.signOut(window.firebaseAuth).catch(error => console.error('Sign Out Error', error));
                    });
                }

                settingsBtn.addEventListener('click', () => settingsModal.classList.add('is-open'));
                closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('is-open'));

                const openConfirmModal = (callback) => { confirmCallback = callback; confirmModal.classList.add('is-open'); };
                const closeConfirmModal = () => { confirmModal.classList.remove('is-open'); confirmCallback = null; }
                confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); });
                confirmCancelBtn.addEventListener('click', closeConfirmModal);

                viewDataBtn.addEventListener('click', () => {
                    dataContainer.innerHTML = '';
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-[var(--bg-tertiary)] rounded-md';
                        itemEl.innerHTML = `<strong class="text-[var(--accent-color)]">${key}:</strong><pre class="whitespace-pre-wrap break-all">${value}</pre>`;
                        dataContainer.appendChild(itemEl);
                    }
                    if (localStorage.length === 0) dataContainer.innerHTML = '<p>No local data found.</p>';
                    viewDataModal.classList.add('is-open');
                });
                closeViewDataBtn.addEventListener('click', () => viewDataModal.classList.remove('is-open'));

                clearDataBtn.addEventListener('click', () => {
                    openConfirmModal(() => {
                        Object.keys(localStorage).forEach(key => { if (key !== 'theme') localStorage.removeItem(key); });
                        location.reload();
                    });
                });

                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                themeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                    localStorage.setItem('theme', e.target.value);
                    applyTheme(e.target.value);
                }));

            })();

            // --- CHARGE CALCULATOR LOGIC ---
            (() => {
                const offensesContainer = document.getElementById('offenses-container');
                const searchInput = document.getElementById('offenseSearch');
                const loader = document.getElementById('loader');
                const calculatorPanel = document.getElementById('calculator-panel');
                const selectedChargesList = document.getElementById('selected-charges-list');
                const totalFineEl = document.getElementById('total-fine');
                const totalTimeEl = document.getElementById('total-time');
                const finalFineEl = document.getElementById('final-fine');
                const finalTimeEl = document.getElementById('final-time');
                const clearSelectionBtn = document.getElementById('clear-selection-btn');
                const customReductionInput = document.getElementById('custom-reduction');

                let allOffenses = [];
                let selectedOffenses = [];
                let reductionPercent = 0;

                const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQa6HZQ9JM5Unzwe4zZDX8A21m6zV4oGvDuEbSEqA9f3m3CqplUUUlmCScNHf79a8Sr1nem0div9YT2/pub?output=csv';

                loadOffenses();

                async function loadOffenses() {
                    try {
                        const response = await fetch(CSV_URL);
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        const csvText = await response.text();
                        allOffenses = parseCSV(csvText);
                        renderOffenses(allOffenses);
                    } catch (error) {
                        console.error('Failed to load or parse offense data:', error);
                        offensesContainer.innerHTML = `<p class="text-red-400 text-center">Failed to load offense data.</p>`;
                    } finally {
                        loader.style.display = 'none';
                    }
                }

                function parseCSV(text) {
                    function parseCsvLine(line) {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        return result;
                    }

                    const lines = text.trim().split(/\r?\n/);
                    const offenses = [];
                    let headers = [];
                    let headerFound = false;
                    let dataStartIndex = 0;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.toLowerCase().includes('penal code') && line.toLowerCase().includes('charge name') && line.toLowerCase().includes('fine amount')) {
                            headers = parseCsvLine(line).map(h => h.toLowerCase().replace(/"/g, '').trim());
                            dataStartIndex = i + 1;
                            headerFound = true;
                            break;
                        }
                    }

                    if (!headerFound) {
                        console.error("Could not find required headers in CSV: 'Penal Code', 'Charge Name', 'Fine Amount'");
                        return [];
                    }

                    const chargeNameIndex = headers.indexOf('charge name');
                    const chargeDescriptionIndex = headers.indexOf('charge description');
                    const jailTimeIndex = headers.indexOf('jail time (months)');
                    const fineAmountIndex = headers.indexOf('fine amount');
                    const classificationIndex = headers.indexOf('felony/infraction');

                    let currentCategory = "Uncategorized";

                    for (let i = dataStartIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        if (line.startsWith('---')) {
                            currentCategory = line.split(',')[0].replace(/---/g, '').split(':')[1]?.trim() || 'Unnamed Category';
                            if (currentCategory.toLowerCase().includes('traffic')) {
                                currentCategory = 'Traffic Infractions';
                            }
                            continue;
                        }

                        const values = parseCsvLine(line);
                        let offenseData = null;
                        const chargeName = values[chargeNameIndex]?.replace(/"/g, '').trim() || '';

                        if (chargeName === '' && (values[chargeDescriptionIndex]?.replace(/"/g, '').trim() || '') !== '') {
                            const nameFromDescription = values[chargeDescriptionIndex]?.replace(/"/g, '').trim();
                            const fineString = values[jailTimeIndex]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '') || '0';

                            offenseData = {
                                category: 'Traffic Infractions',
                                name: nameFromDescription,
                                description: values[fineAmountIndex]?.replace(/"/g, '').trim() || '',
                                jailTime: 0,
                                fine: parseInt(fineString) || 0,
                                classification: 'Infraction'
                            };
                        } else if (chargeName !== '') {
                            const fineString = values[fineAmountIndex]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '') || '0';

                            offenseData = {
                                category: currentCategory,
                                name: chargeName,
                                description: values[chargeDescriptionIndex]?.replace(/"/g, '').trim() || '',
                                jailTime: parseInt(values[jailTimeIndex]?.replace(/"/g, '').trim()) || 0,
                                fine: parseInt(fineString) || 0,
                                classification: values[classificationIndex]?.replace(/"/g, '').trim() || 'Felony'
                            };
                        }

                        if (offenseData) {
                            offenses.push(offenseData);
                        }
                    }
                    return offenses;
                }

                function renderOffenses(offensesToRender) {
                    const grouped = offensesToRender.reduce((acc, offense) => {
                        (acc[offense.category] = acc[offense.category] || []).push(offense);
                        return acc;
                    }, {});

                    offensesContainer.innerHTML = Object.entries(grouped).map(([category, offenses]) => `
                            <section class="category-section">
                                <div class="category-header flex justify-between items-center p-2 rounded-md bg-slate-200 dark:bg-gray-800 cursor-pointer mb-4">
                                    <h3 class="text-xl font-semibold text-text-primary">${category}</h3>
                                    <svg class="chevron-icon w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                                <div class="offense-grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                    ${offenses.map(offense => createOffenseCardHTML(offense)).join('')}
                                </div>
                            </section>
                        `).join('');
                }

                function createOffenseCardHTML(offense) {
                    const cardClass = offense.classification === 'Infraction' ? 'infraction' : '';
                    return `
                            <div class="offense-card rounded-lg p-4 text-white flex flex-col justify-between h-full ${cardClass}" data-name="${offense.name}">
                                <div>
                                    <h4 class="font-bold text-md mb-1">${offense.name}</h4>
                                    <p class="text-xs text-gray-300 mb-2">${offense.description || 'No description available.'}</p>
                                    <p class="text-sm font-medium text-red-200">${offense.classification}</p>
                                </div>
                                <div class="mt-2 text-right">
                                    <p class="text-xs text-red-100">${offense.jailTime} Months / $${offense.fine.toLocaleString()}</p>
                                </div>
                            </div>`;
                }

                offensesContainer.addEventListener('click', (e) => {
                    const header = e.target.closest('.category-header');
                    if (header) {
                        const grid = header.nextElementSibling;
                        const icon = header.querySelector('.chevron-icon');
                        grid.classList.toggle('visible');
                        icon.classList.toggle('rotated');
                    } else {
                        const card = e.target.closest('.offense-card');
                        if (card) {
                            toggleChargeSelection(card.dataset.name);
                        }
                    }
                });

                function toggleChargeSelection(offenseName) {
                    const card = document.querySelector(`.offense-card[data-name="${offenseName}"]`);
                    const index = selectedOffenses.findIndex(o => o.name === offenseName);

                    if (index > -1) {
                        selectedOffenses.splice(index, 1);
                        card?.classList.remove('selected');
                    } else {
                        const offenseData = allOffenses.find(o => o.name === offenseName);
                        if (offenseData) {
                            selectedOffenses.push(offenseData);
                            card?.classList.add('selected');
                        }
                    }
                    updateCalculator();
                }

                function updateCalculator() {
                    calculatorPanel.classList.toggle('visible', selectedOffenses.length > 0);
                    renderSelectedCharges();
                    calculateAndDisplayTotals();
                }

                function renderSelectedCharges() {
                    if (selectedOffenses.length === 0) {
                        selectedChargesList.innerHTML = `<p class="text-gray-500 text-center text-sm">No charges selected.</p>`;
                        return;
                    }
                    selectedChargesList.innerHTML = selectedOffenses.map(o => `
                            <div class="text-sm flex justify-between items-center p-1 bg-gray-100 dark:bg-gray-800 rounded mb-1">
                                <span class="truncate pr-2">${o.name}</span>
                                <span class="whitespace-nowrap text-gray-500 dark:text-gray-400">$${o.fine.toLocaleString()} / ${o.jailTime}m</span>
                            </div>
                        `).join('');
                }

                function calculateAndDisplayTotals() {
                    const totals = selectedOffenses.reduce((acc, o) => {
                        acc.fine += o.fine;
                        acc.time += o.jailTime;
                        return acc;
                    }, { fine: 0, time: 0 });

                    totalFineEl.textContent = `$${totals.fine.toLocaleString()}`;
                    totalTimeEl.textContent = `${totals.time} Months`;

                    const reductionType = document.querySelector('input[name="reduction-type"]:checked').value;
                    let finalFine = totals.fine;
                    let finalTime = totals.time;

                    const reductionDecimal = reductionPercent / 100;

                    if (reductionType === 'both' || reductionType === 'fine') {
                        finalFine = Math.round(totals.fine * (1 - reductionDecimal));
                    }
                    if (reductionType === 'both' || reductionType === 'time') {
                        finalTime = Math.round(totals.time * (1 - reductionDecimal));
                    }

                    finalFineEl.textContent = `$${finalFine.toLocaleString()}`;
                    finalTimeEl.textContent = `${finalTime} Months`;
                }

                function clearSelections() {
                    selectedOffenses = [];
                    document.querySelectorAll('.offense-card.selected').forEach(c => c.classList.remove('selected'));
                    customReductionInput.value = '';
                    reductionPercent = 0;
                    updateCalculator();
                }

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const filteredOffenses = allOffenses.filter(o =>
                        o.name.toLowerCase().includes(searchTerm) ||
                        o.description.toLowerCase().includes(searchTerm)
                    );
                    renderOffenses(filteredOffenses);
                    document.querySelectorAll('.offense-grid').forEach(grid => {
                        grid.classList.toggle('visible', searchTerm.length > 0);
                    });
                    document.querySelectorAll('.chevron-icon').forEach(icon => {
                        icon.classList.toggle('rotated', searchTerm.length > 0);
                    });
                    selectedOffenses.forEach(so => {
                        const card = document.querySelector(`.offense-card[data-name="${so.name}"]`);
                        card?.classList.add('selected');
                    });
                });

                clearSelectionBtn.addEventListener('click', clearSelections);

                document.querySelectorAll('.reduction-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        reductionPercent = parseFloat(btn.dataset.value);
                        customReductionInput.value = reductionPercent;
                        calculateAndDisplayTotals();
                    });
                });

                customReductionInput.addEventListener('input', () => {
                    reductionPercent = parseFloat(customReductionInput.value) || 0;
                    calculateAndDisplayTotals();
                });

                document.querySelectorAll('input[name="reduction-type"]').forEach(radio => {
                    radio.addEventListener('change', calculateAndDisplayTotals);
                });
            })();
        });
    </script>
</body>
</html>
