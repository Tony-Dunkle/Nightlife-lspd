<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPD - Offences & Charge Calculator</title>

    <!-- Rich Embed Meta Tags for Social Sharing -->
    <meta name="description" content="A tool for the Unified Police Department to browse offenses and calculate fines and jail time with sentence reductions.">
    <meta name="theme-color" content="#0d1117">

    <!-- Open Graph / Facebook / Discord -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-site.com/charges.html"> <!-- Replace with your actual URL -->
    <meta property="og:title" content="UPD - Offences & Charge Calculator">
    <meta property="og:description" content="Browse all criminal offenses, search for specific charges, and calculate fines and jail time with reductions.">
    <meta property="og:image" content="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-site.com/charges.html"> <!-- Replace with your actual URL -->
    <meta property="twitter:title" content="UPD - Offences & Charge Calculator">
    <meta property="twitter:description" content="Browse all criminal offenses, search for specific charges, and calculate fines and jail time with reductions.">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png">

    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display.swap');

        /* Define CSS variables for theming from index.html */
        :root {
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f1f5f9; /* slate-100 */
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #475569; /* slate-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #ffffff;
        }

        html.dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --modal-content-bg: #1e293b; /* slate-800 */
        }

        html, body {
            height: 100%;
        }

        /* General body styles from index.html */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        main {
            flex-grow: 1;
            padding-bottom: 350px;
        }

        /* Mobile Nav Specific Styles from index.html */
        #nav-links.nav-mobile-active {
            display: flex !important;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #1e40af;
            flex-direction: column;
            padding: 1rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        html.dark #nav-links.nav-mobile-active {
            background-color: #111827;
        }

        /* Modal Styles for Settings Modal */
        .settings-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: var(--modal-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .settings-modal-overlay.is-open {
                display: flex;
            }

        .modal-box {
            background-color: var(--modal-content-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 500px;
        }

        .data-modal-box {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        /* Style for the search input */
        .search-input {
            background-color: #010409;
            border: 1px solid #30363d;
        }

            .search-input:focus {
                outline: none;
                border-color: #2f81f7;
                box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3);
            }
        /* Styling for the offense cards */
        .offense-card {
            background-color: #B91C1C; /* A deep red for felonies */
            border: 2px solid #dc2626;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

            .offense-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            }

            .offense-card.selected {
                border-color: #3b82f6; /* Bright blue border for selected */
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            }
            /* Styling for infraction cards */
            .offense-card.infraction {
                background-color: #4a5568; /* A neutral gray for infractions */
                border-color: #718096;
            }

                .offense-card.infraction .text-red-200 {
                    color: #e2e8f0;
                }

                .offense-card.infraction .text-red-100 {
                    color: #cbd5e0;
                }
        /* Loader animation */
        .loader {
            border: 4px solid #30363d;
            border-top: 4px solid #2f81f7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 5rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Calculator Panel Styles */
        #calculator-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 420px;
            background-color: #161b22;
            border-top-left-radius: 0.75rem;
            border-top: 1px solid #30363d;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }

            #calculator-panel.visible {
                transform: translateY(0);
            }

        #selected-charges-list {
            max-height: 150px;
        }
        /* Collapsible Category Styles */
        .offense-grid {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }

        .chevron-icon {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header Section from index.html (Login button removed) -->
    <header class="bg-blue-900 text-white shadow-lg py-4 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center">
            <img src="https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png" alt="UPD Logo" class="mr-4 w-16 h-16 object-contain">
            <h1 class="text-2xl md:text-3xl font-bold">Unified Police Department</h1>
        </div>

        <div class="flex items-center">
            <nav id="nav-links" class="hidden md:flex items-center">
                <!-- Combined and updated navigation links -->
                <ul class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 text-sm font-medium">
                    <li><a href="index.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Dashboard</a></li>
                    <li><a href="SOP.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">SOPs</a></li>
                    <li><a href="training.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Training</a></li>
                    <li><a href="forms.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Forms</a></li>
                    <li><a href="roster.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Roster</a></li>
                    <li><a href="hr.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">HR Info</a></li>
                    <li><a href="report.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Report Generator</a></li>
                    <li><a href="charges.html" class="text-white bg-blue-700 font-semibold py-1 px-2 rounded-md">Charge Calculator</a></li>
                    <li><a href="info.html" class="text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Common Information</a></li>
                </ul>
            </nav>

            <div class="flex items-center ml-4">
                <button id="settings-btn" class="p-2 rounded-full hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <button id="hamburgerBtn" class="hamburger-menu p-2 rounded-md hover:bg-white/10 focus:outline-none md:hidden ml-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="p-4 sm:p-6 lg:p-8 bg-[#0d1117] text-[#c9d1d9]">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div><h1 class="text-3xl font-bold text-white">Offences</h1></div>
            <div class="flex items-center mt-4 sm:mt-0 w-full sm:w-auto">
                <input type="text" id="offenseSearch" placeholder="Search Offences..." class="search-input w-full sm:w-64 px-4 py-2 rounded-md text-white focus:outline-none">
            </div>
        </header>
        <div id="offenses-container" class="space-y-8">
            <div class="loader" id="loader"></div>
        </div>
    </main>

    <!-- Calculator Panel -->
    <div id="calculator-panel">
        <div class="p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-white">Sentence Calculator</h3>
                <button id="clear-selection-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md transition">Clear</button>
            </div>
            <div id="selected-charges-list" class="bg-gray-900 p-2 rounded-md overflow-y-auto border border-gray-700">
                <p class="text-gray-500 text-center text-sm">No charges selected.</p>
            </div>

            <!-- Totals -->
            <div class="grid grid-cols-2 gap-4 mt-4 text-center">
                <div>
                    <p class="text-sm text-gray-400">Total Fine</p>
                    <p id="total-fine" class="text-xl font-bold text-green-400">$0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Total Time</p>
                    <p id="total-time" class="text-xl font-bold text-red-400">0 Months</p>
                </div>
            </div>

            <!-- Reductions -->
            <div class="mt-4 pt-4 border-t border-gray-700">
                <h4 class="font-semibold text-center mb-2">Sentence Reductions (%)</h4>
                <div class="flex justify-center items-center space-x-2 mb-3">
                    <div class="flex items-center">
                        <input id="reduction-both" type="radio" value="both" name="reduction-type" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <label for="reduction-both" class="ml-2 text-sm font-medium text-gray-300">Both</label>
                    </div>
                    <div class="flex items-center">
                        <input id="reduction-fine" type="radio" value="fine" name="reduction-type" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <label for="reduction-fine" class="ml-2 text-sm font-medium text-gray-300">Fine</label>
                    </div>
                    <div class="flex items-center">
                        <input id="reduction-time" type="radio" value="time" name="reduction-type" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <label for="reduction-time" class="ml-2 text-sm font-medium text-gray-300">Time</label>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button class="reduction-btn text-sm bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="5">5%</button>
                    <button class="reduction-btn text-sm bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="10">10%</button>
                    <button class="reduction-btn text-sm bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="15">15%</button>
                    <button class="reduction-btn text-sm bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="25">25%</button>
                    <button class="reduction-btn text-sm bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="50">50%</button>
                    <button class="reduction-btn text-sm bg-gray-700 hover:bg-blue-600 rounded p-1" data-value="75">75%</button>
                    <input type="number" id="custom-reduction" placeholder="Custom" class="col-span-2 text-sm bg-gray-800 border border-gray-600 rounded p-1 text-center focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Final Totals -->
            <div class="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-gray-700 text-center">
                <div>
                    <p class="text-sm text-gray-400">Final Fine</p>
                    <p id="final-fine" class="text-2xl font-bold text-green-300">$0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Final Time</p>
                    <p id="final-time" class="text-2xl font-bold text-red-300">0 Months</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white py-10 px-6 md:px-12 rounded-t-lg">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h4 class="text-xl font-semibold mb-4 text-gray-300">Internal Contacts</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://discord.gg/7FwxdpfDTM" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">Discord</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398235660058685" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">UPD Support</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398240840290374" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">UPD Chat</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398235660058685" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">UPD Internal Affairs</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1396398239678333030" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">UPD Announcements</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-xl font-semibold mb-4 text-gray-300">Quick Access</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://docs.google.com/document/d/1etjilZ1dAHGviw33MV5Zs-b5dXqcSHyoYIHvHiRIyy4/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">UPD SOP</a></li>
                    <li><a href="https://docs.google.com/document/d/1hKQ4fw9b1_yQELhPi1p1b4M6uiSaYb7bBp-9C6GVTdY/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">Interview Procedure</a></li>
                    <li><a href="https://docs.google.com/document/d/1d004FfAhZBgESn88Mx21N3CGqXlcoNeP9_sadn_ePak/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">Promotional Pathway</a></li>
                    <li><a href="https://docs.google.com/document/d/14QIEsYMWpTssti1xGbGWiMxQ2b0jbiYxuMmvV8XWUUo/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">HEAT Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/1Ggf7SS5voiIjr3iSLB3VtAc47JN3aDjm2J_gYnpoZ6s/edit?blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">Disciplinary Guidelines</a></li>
                    <li><a href="privacypolicy.html" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline">Privacy Policy</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-xl font-semibold mb-4 text-gray-300">System Information</h4>
                <p class="text-gray-500 text-sm mb-2">Unauthorized Access Strictly Prohibited</p>
                <p class="text-gray-500 text-sm mb-2">For UPD Personnel Use Only</p>
                <p class="text-gray-500 text-sm mb-2">Created and Maintained by FiveM "NightLife RP"</p>
                <p class="text-gray-500 text-sm">&copy; 2025 Unified Police Department Internal Systems.</p>
            </div>
        </div>
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    </footer>

    <!-- Settings Modals from index.html -->
    <div id="settings-modal" class="settings-modal-overlay"><div class="modal-box text-[var(--text-primary)]"><h2 class="text-2xl font-bold mb-6">Settings</h2><div class="mb-6"><h3 class="text-lg font-semibold mb-3">Website Theme</h3><div class="space-y-2"><label class="flex items-center"><input type="radio" name="theme" value="light" class="form-radio h-4 w-4 text-blue-600"><span class="ml-2">Light Mode</span></label><label class="flex items-center"><input type="radio" name="theme" value="dark" class="form-radio h-4 w-4 text-blue-600"><span class="ml-2">Dark Mode</span></label></div></div><div class="mb-6"><h3 class="text-lg font-semibold mb-3">Data Management</h3><div class="flex flex-col space-y-3"><button id="clear-data-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">Clear All Local Data</button><button id="view-data-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">View Stored Data</button></div></div><div class="mt-8 text-right"><button id="close-settings-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Close</button></div></div></div>
    <div id="view-data-modal" class="settings-modal-overlay"><div class="modal-box data-modal-box text-[var(--text-primary)]"><h2 class="text-2xl font-bold mb-4">Local Storage Data</h2><div id="data-container" class="space-y-4 text-sm"></div><div class="mt-6 text-right"><button id="close-view-data-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Close</button></div></div></div>
    <div id="confirm-modal" class="settings-modal-overlay"><div class="modal-box text-[var(--text-primary)]"><h2 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-text" class="mb-6">This action cannot be undone.</p><div class="flex justify-end space-x-4"><button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition">Confirm</button></div></div></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- HEADER & SETTINGS LOGIC (from index.html) ---
            (() => {
                const settingsModal = document.getElementById('settings-modal');
                const themeRadios = document.querySelectorAll('input[name="theme"]');
                const hamburgerBtn = document.getElementById('hamburgerBtn');
                const navLinks = document.getElementById('nav-links');
                const settingsBtn = document.getElementById('settings-btn');
                const closeSettingsBtn = document.getElementById('close-settings-btn');
                const viewDataBtn = document.getElementById('view-data-btn');
                const clearDataBtn = document.getElementById('clear-data-btn');
                const viewDataModal = document.getElementById('view-data-modal');
                const closeViewDataBtn = document.getElementById('close-view-data-btn');
                const dataContainer = document.getElementById('data-container');
                const confirmModal = document.getElementById('confirm-modal');
                const confirmOkBtn = document.getElementById('confirm-ok-btn');
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
                let confirmCallback = null;

                const applyTheme = (theme) => {
                    if (theme === 'dark') {
                        document.documentElement.classList.add('dark');
                        themeRadios.forEach(radio => radio.value === 'dark' ? radio.checked = true : false);
                    } else {
                        document.documentElement.classList.remove('dark');
                        themeRadios.forEach(radio => radio.value === 'light' ? radio.checked = true : false);
                    }
                };

                const openConfirmModal = (callback) => {
                    confirmCallback = callback;
                    confirmModal.classList.add('is-open');
                };

                const closeConfirmModal = () => {
                    confirmModal.classList.remove('is-open');
                    confirmCallback = null;
                }

                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);

                themeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                    localStorage.setItem('theme', e.target.value);
                    applyTheme(e.target.value);
                }));

                hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); navLinks.classList.toggle('nav-mobile-active'); });

                settingsBtn.addEventListener('click', () => settingsModal.classList.add('is-open'));
                closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('is-open'));

                viewDataBtn.addEventListener('click', () => {
                    dataContainer.innerHTML = '';
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-[var(--bg-tertiary)] rounded-md';
                        itemEl.innerHTML = `<strong class="text-[var(--accent-color)]">${key}:</strong><pre class="whitespace-pre-wrap break-all">${value}</pre>`;
                        dataContainer.appendChild(itemEl);
                    }
                    if (localStorage.length === 0) dataContainer.innerHTML = '<p>No local data found.</p>';
                    viewDataModal.classList.add('is-open');
                });
                closeViewDataBtn.addEventListener('click', () => viewDataModal.classList.remove('is-open'));

                clearDataBtn.addEventListener('click', () => {
                    openConfirmModal(() => {
                        Object.keys(localStorage).forEach(key => { if (key !== 'theme') localStorage.removeItem(key); });
                        location.reload();
                    });
                });

                confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); });
                confirmCancelBtn.addEventListener('click', closeConfirmModal);
            })();


            // --- CHARGE CALCULATOR LOGIC (Original from charges.html) ---
            (() => {
                const offensesContainer = document.getElementById('offenses-container');
                const searchInput = document.getElementById('offenseSearch');
                const loader = document.getElementById('loader');
                const calculatorPanel = document.getElementById('calculator-panel');
                const selectedChargesList = document.getElementById('selected-charges-list');
                const totalFineEl = document.getElementById('total-fine');
                const totalTimeEl = document.getElementById('total-time');
                const finalFineEl = document.getElementById('final-fine');
                const finalTimeEl = document.getElementById('final-time');
                const clearSelectionBtn = document.getElementById('clear-selection-btn');
                const customReductionInput = document.getElementById('custom-reduction');

                let allOffenses = [];
                let selectedOffenses = [];
                let reductionPercent = 0;

                const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQa6HZQ9JM5Unzwe4zZDX8A21m6zV4oGvDuEbSEqA9f3m3CqplUUUlmCScNHf79a8Sr1nem0div9YT2/pub?output=csv';

                loadOffenses();

                async function loadOffenses() {
                    try {
                        const response = await fetch(CSV_URL);
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        const csvText = await response.text();
                        allOffenses = parseCSV(csvText);
                        renderOffenses(allOffenses);
                    } catch (error) {
                        console.error('Failed to load or parse offense data:', error);
                        offensesContainer.innerHTML = `<p class="text-red-400 text-center">Failed to load offense data.</p>`;
                    } finally {
                        loader.style.display = 'none';
                    }
                }

                function parseCSV(text) {
                    // Helper function to correctly parse a single CSV line, handling quotes
                    function parseCsvLine(line) {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        return result;
                    }

                    const lines = text.trim().split(/\r?\n/);
                    const offenses = [];
                    let headers = [];
                    let headerFound = false;
                    let dataStartIndex = 0;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.toLowerCase().includes('penal code') && line.toLowerCase().includes('charge name') && line.toLowerCase().includes('fine amount')) {
                            headers = parseCsvLine(line).map(h => h.toLowerCase().replace(/"/g, '').trim());
                            dataStartIndex = i + 1;
                            headerFound = true;
                            break;
                        }
                    }

                    if (!headerFound) {
                        console.error("Could not find required headers in CSV: 'Penal Code', 'Charge Name', 'Fine Amount'");
                        return [];
                    }

                    const chargeNameIndex = headers.indexOf('charge name');
                    const chargeDescriptionIndex = headers.indexOf('charge description');
                    const jailTimeIndex = headers.indexOf('jail time (months)');
                    const fineAmountIndex = headers.indexOf('fine amount');
                    const classificationIndex = headers.indexOf('felony/infraction');

                    let currentCategory = "Uncategorized";

                    for (let i = dataStartIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        if (line.startsWith('---')) {
                            currentCategory = line.split(',')[0].replace(/---/g, '').split(':')[1]?.trim() || 'Unnamed Category';
                            if (currentCategory.toLowerCase().includes('traffic')) {
                                currentCategory = 'Traffic Infractions';
                            }
                            continue;
                        }

                        const values = parseCsvLine(line);
                        let offenseData = null;
                        const chargeName = values[chargeNameIndex]?.replace(/"/g, '').trim() || '';

                        // Special handling for infractions which have an empty charge name
                        if (chargeName === '' && (values[chargeDescriptionIndex]?.replace(/"/g, '').trim() || '') !== '') {
                            const nameFromDescription = values[chargeDescriptionIndex]?.replace(/"/g, '').trim();
                            const fineString = values[jailTimeIndex]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '') || '0';

                            offenseData = {
                                category: 'Traffic Infractions',
                                name: nameFromDescription,
                                description: values[fineAmountIndex]?.replace(/"/g, '').trim() || '',
                                jailTime: 0,
                                fine: parseInt(fineString) || 0,
                                classification: 'Infraction'
                            };
                        } else if (chargeName !== '') { // Normal handling for other charges
                            const fineString = values[fineAmountIndex]?.replace(/"/g, '').replace(/\$/g, '').replace(/,/g, '') || '0';

                            offenseData = {
                                category: currentCategory,
                                name: chargeName,
                                description: values[chargeDescriptionIndex]?.replace(/"/g, '').trim() || '',
                                jailTime: parseInt(values[jailTimeIndex]?.replace(/"/g, '').trim()) || 0,
                                fine: parseInt(fineString) || 0,
                                classification: values[classificationIndex]?.replace(/"/g, '').trim() || 'Felony'
                            };
                        }

                        if (offenseData) {
                            offenses.push(offenseData);
                        }
                    }
                    return offenses;
                }


                function renderOffenses(offensesToRender) {
                    const grouped = offensesToRender.reduce((acc, offense) => {
                        (acc[offense.category] = acc[offense.category] || []).push(offense);
                        return acc;
                    }, {});

                    offensesContainer.innerHTML = Object.entries(grouped).map(([category, offenses]) => `
                                <section class="category-section">
                                    <div class="category-header flex justify-between items-center p-2 rounded-md bg-gray-800 cursor-pointer mb-4">
                                        <h3 class="text-xl font-semibold text-white">${category}</h3>
                                        <svg class="chevron-icon w-6 h-6 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                    <div class="offense-grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 hidden">
                                        ${offenses.map(offense => createOffenseCardHTML(offense)).join('')}
                                    </div>
                                </section>
                            `).join('');
                }

                function createOffenseCardHTML(offense) {
                    const cardClass = offense.classification === 'Infraction' ? 'infraction' : '';
                    return `
                                <div class="offense-card rounded-lg p-4 text-white flex flex-col justify-between h-full ${cardClass}" data-name="${offense.name}">
                                    <div>
                                        <h4 class="font-bold text-md mb-1">${offense.name}</h4>
                                        <p class="text-xs text-gray-300 mb-2">${offense.description || 'No description available.'}</p>
                                        <p class="text-sm font-medium text-red-200">${offense.classification}</p>
                                    </div>
                                    <div class="mt-2 text-right">
                                        <p class="text-xs text-red-100">${offense.jailTime} Months / $${offense.fine.toLocaleString()}</p>
                                    </div>
                                </div>`;
                }

                offensesContainer.addEventListener('click', (e) => {
                    const header = e.target.closest('.category-header');
                    if (header) {
                        const grid = header.nextElementSibling;
                        const icon = header.querySelector('.chevron-icon');
                        grid.classList.toggle('hidden');
                        grid.classList.toggle('grid');
                        icon.classList.toggle('rotate-180');
                    } else {
                        const card = e.target.closest('.offense-card');
                        if (card) {
                            toggleChargeSelection(card.dataset.name);
                        }
                    }
                });

                function toggleChargeSelection(offenseName) {
                    const card = document.querySelector(`.offense-card[data-name="${offenseName}"]`);
                    const index = selectedOffenses.findIndex(o => o.name === offenseName);

                    if (index > -1) {
                        selectedOffenses.splice(index, 1);
                        card?.classList.remove('selected');
                    } else {
                        const offenseData = allOffenses.find(o => o.name === offenseName);
                        if (offenseData) {
                            selectedOffenses.push(offenseData);
                            card?.classList.add('selected');
                        }
                    }
                    updateCalculator();
                }

                function updateCalculator() {
                    if (selectedOffenses.length > 0) {
                        calculatorPanel.classList.add('visible');
                    } else {
                        calculatorPanel.classList.remove('visible');
                    }
                    renderSelectedCharges();
                    calculateAndDisplayTotals();
                }

                function renderSelectedCharges() {
                    if (selectedOffenses.length === 0) {
                        selectedChargesList.innerHTML = `<p class="text-gray-500 text-center text-sm">No charges selected.</p>`;
                        return;
                    }
                    selectedChargesList.innerHTML = selectedOffenses.map(o => `
                                <div class="text-sm flex justify-between items-center p-1 bg-gray-800 rounded mb-1">
                                    <span class="truncate pr-2">${o.name}</span>
                                    <span class="whitespace-nowrap text-gray-400">$${o.fine.toLocaleString()} / ${o.jailTime}m</span>
                                </div>
                            `).join('');
                }

                function calculateAndDisplayTotals() {
                    const totals = selectedOffenses.reduce((acc, o) => {
                        acc.fine += o.fine;
                        acc.time += o.jailTime;
                        return acc;
                    }, { fine: 0, time: 0 });

                    totalFineEl.textContent = `$${totals.fine.toLocaleString()}`;
                    totalTimeEl.textContent = `${totals.time} Months`;

                    const reductionType = document.querySelector('input[name="reduction-type"]:checked').value;
                    let finalFine = totals.fine;
                    let finalTime = totals.time;

                    const reductionDecimal = reductionPercent / 100;

                    if (reductionType === 'both' || reductionType === 'fine') {
                        finalFine = Math.round(totals.fine * (1 - reductionDecimal));
                    }
                    if (reductionType === 'both' || reductionType === 'time') {
                        finalTime = Math.round(totals.time * (1 - reductionDecimal));
                    }

                    finalFineEl.textContent = `$${finalFine.toLocaleString()}`;
                    finalTimeEl.textContent = `${finalTime} Months`;
                }

                function clearSelections() {
                    selectedOffenses = [];
                    document.querySelectorAll('.offense-card.selected').forEach(c => c.classList.remove('selected'));
                    customReductionInput.value = '';
                    reductionPercent = 0;
                    updateCalculator();
                }

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    if (searchTerm === "") {
                        renderOffenses(allOffenses);
                        selectedOffenses.forEach(so => {
                            const card = document.querySelector(`.offense-card[data-name="${so.name}"]`);
                            card?.classList.add('selected');
                        });
                        return;
                    }
                    const filteredOffenses = allOffenses.filter(o =>
                        o.name.toLowerCase().includes(searchTerm) ||
                        o.description.toLowerCase().includes(searchTerm)
                    );
                    renderOffenses(filteredOffenses);
                    document.querySelectorAll('.offense-grid').forEach(grid => {
                        grid.classList.remove('hidden');
                        grid.classList.add('grid');
                    });
                    document.querySelectorAll('.chevron-icon').forEach(icon => icon.classList.add('rotate-180'));
                    selectedOffenses.forEach(so => {
                        const card = document.querySelector(`.offense-card[data-name="${so.name}"]`);
                        card?.classList.add('selected');
                    });
                });

                clearSelectionBtn.addEventListener('click', clearSelections);

                document.querySelectorAll('.reduction-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        reductionPercent = parseFloat(btn.dataset.value);
                        customReductionInput.value = reductionPercent;
                        calculateAndDisplayTotals();
                    });
                });

                customReductionInput.addEventListener('input', () => {
                    reductionPercent = parseFloat(customReductionInput.value) || 0;
                    calculateAndDisplayTotals();
                });

                document.querySelectorAll('input[name="reduction-type"]').forEach(radio => {
                    radio.addEventListener('change', calculateAndDisplayTotals);
                });
            })();
        });
    </script>
</body>
</html>
