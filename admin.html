<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport meta tag is crucial for responsive behavior across devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrative Report Generator</title>
    <!-- Favicon link updated with a fallback URL for robustness -->
    <link rel="icon" type="image/png" href="LSPD.png" onerror="this.href='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
    <!-- Tailwind CSS CDN - provides responsive utility classes out of the out of the box -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF CDN for generating PDF documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable CDN for generating tables in PDF documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8; /* Light gray background */
            color: #333; /* Dark gray text */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            width: 500px; /* Adjusted width for better readability */
        }

        .evidence-item, .officer-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }

            .evidence-item:hover, .officer-item:hover {
                background-color: #f0f4f8; /* Light blue-gray hover */
            }

            .evidence-item input[type="checkbox"] {
                margin-right: 0.75rem;
                width: 1.25rem;
                height: 1.25rem;
            }

        .evidence-description {
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
            min-height: 1.5rem; /* To prevent layout shift when description appears */
        }

        /* Loading indicator styles */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Light Mode */
        body.light-mode {
            background-color: #f8f8f8;
            color: #333;
        }

            body.light-mode .bg-blue-900 {
                background-color: #1e3a8a; /* Darker blue for header */
            }

            body.light-mode .text-white {
                color: #ffffff;
            }

            body.light-mode .bg-gradient-to-r {
                background-image: linear-gradient(to right, #1e3a8a, #102a43); /* Darker blue gradient */
            }

            body.light-mode .bg-blue-50 {
                background-color: #e0f2fe; /* Light blue */
            }

            body.light-mode .bg-gray-100 {
                background-color: #f3f4f6;
            }

            body.light-mode .bg-white {
                background-color: #ffffff;
            }

            body.light-mode .text-blue-700 {
                color: #1d4ed8;
            }

            body.light-mode .text-blue-800 {
                color: #1e40af;
            }

            body.light-mode .text-gray-800 {
                color: #1f2937;
            }

            body.light-mode .text-gray-600 {
                color: #4b5563;
            }

            body.light-mode .text-gray-700 {
                color: #374151;
            }

            body.light-mode .text-blue-500 {
                color: #3b82f6;
            }

            body.light-mode .bg-gray-800 {
                background-color: #1f2937;
            }

            body.light-mode .text-blue-300 {
                color: #93c5fd;
            }

            body.light-mode .text-gray-400 {
                color: #9ca3af;
            }

            body.light-mode .text-gray-500 {
                color: #6b7280;
            }

            /* Light mode input specific styles */
            body.light-mode input[type="text"],
            body.light-mode input[type="date"],
            body.light-mode input[type="time"],
            body.light-mode input[type="url"],
            body.light-mode select,
            body.light-mode textarea {
                color: #1f2937; /* Dark gray text */
                background-color: #ffffff; /* White background */
            }

                body.light-mode input::placeholder,
                body.light-mode textarea::placeholder {
                    color: #9ca3af; /* text-gray-400 */
                }


        /* Dark Mode */
        body.dark-mode {
            background-color: #1a202c; /* bg-gray-900 */
            color: #e2e8f0; /* text-gray-200 */
        }

            body.dark-mode .bg-blue-900 {
                background-color: #2d3748; /* Darker header */
            }

            body.dark-mode .text-white {
                color: #e2e8f0;
            }

            body.dark-mode .bg-gradient-to-r {
                background-image: linear-gradient(to right, #2d3748, #1a202c);
            }

            body.dark-mode .bg-blue-50 {
                background-color: #2f3e58; /* Darker light blue */
            }

            body.dark-mode .bg-gray-100 {
                background-color: #2d3748;
            }

            body.dark-mode .bg-white {
                background-color: #2d3748;
            }

            body.dark-mode .text-blue-700 {
                color: #90cdf4;
            }

            body.dark-mode .text-blue-800 {
                color: #a7d9ff;
            }

            body.dark-mode .text-gray-800 {
                color: #e2e8f0;
            }

            body.dark-mode .text-gray-600 {
                color: #a0aec0;
            }

            body.dark-mode .text-gray-700 {
                color: #cbd5e0;
            }

            body.dark-mode .text-blue-500 {
                color: #63b3ed;
            }

            body.dark-mode .bg-gray-800 {
                background-color: #1f2937;
            }

            body.dark-mode .text-blue-300 {
                color: #90cdf4;
            }

            body.dark-mode .text-gray-400 {
                color: #a0aec0;
            }

            body.dark-mode .text-gray-500 {
                color: #cbd5e0;
            }

            body.dark-mode .shadow-lg,
            body.dark-mode .shadow-xl,
            body.dark-mode .shadow-inner {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            }

            body.dark-mode .modal-content {
                background-color: #2d3748;
            }

            body.dark-mode .modal-overlay {
                background-color: rgba(0, 0, 0, 0.8);
            }

            body.dark-mode .border {
                border-color: #4a5568;
            }

            /* Dark mode specific footer styling for distinct separation */
            body.dark-mode footer {
                border-top: 2px solid #4a5568; /* A subtle border for separation */
                box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.5); /* Stronger shadow at the top */
            }

            /* Force input text color and background for dark mode */
            body.dark-mode input[type="text"],
            body.dark-mode input[type="date"],
            body.dark-mode input[type="time"],
            body.dark-mode input[type="url"],
            body.dark-mode select,
            body.dark-mode textarea {
                color: #e2e8f0; /* Light gray text */
                background-color: #4a5568; /* Darker gray background */
                border-color: #6b7280; /* Slightly lighter border for visibility */
            }
                /* Adjust placeholder color for dark mode inputs */
                body.dark-mode input::placeholder,
                body.dark-mode textarea::placeholder {
                    color: #a0aec0; /* Lighter gray for placeholder */
                }


        /* Settings icon styles */
        #settingsIcon {
            width: 28px; /* Slightly larger icon */
            height: 28px;
            cursor: pointer;
            margin-left: 1.5rem; /* Space from navigation links */
            transition: transform 0.2s ease-in-out;
            filter: brightness(0) invert(1); /* Makes the icon white */
        }

            #settingsIcon:hover {
                transform: rotate(15deg);
            }

        body.dark-mode #settingsIcon {
            filter: none; /* Keep original color or adjust if necessary for dark mode */
        }

        /* Settings modal specific styles */
        #settingsModal .modal-content {
            width: 350px; /* Adjust width for settings modal */
        }

        #settingsModal .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

            #settingsModal .radio-option input[type="radio"] {
                margin-right: 0.5rem;
            }

            #settingsModal .radio-option label {
                font-size: 1rem;
                color: #333;
            }

        body.dark-mode #settingsModal .radio-option label {
            color: #e2e8f0;
        }

        #settingsModal button {
            margin-top: 1rem;
            width: 100%;
        }

        /* Data Viewer Modal Styles */
        #dataViewerModal .modal-content {
            width: 600px;
            max-width: 95%;
        }

        #dataViewerContent {
            background-color: #f4f4f4;
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        body.dark-mode #dataViewerContent {
            background-color: #1f2937;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        /* Styles for data viewer items, similar to updates */
        .data-viewer-item {
            background-color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.75rem;
        }

        body.dark-mode .data-viewer-item {
            background-color: #2d3748;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .data-viewer-item p {
            margin: 0;
            line-height: 1.5;
        }

        .data-viewer-item .title {
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* text-gray-800 */
        }

        body.dark-mode .data-viewer-item .title {
            color: #e2e8f0;
        }

        .data-viewer-item .description {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
        }

        body.dark-mode .data-viewer-item .description {
            color: #a0aec0;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Header Section -->
    <header class="bg-blue-900 text-white shadow-lg py-4 px-6 md:px-12 flex items-center justify-between sticky top-0 z-50 rounded-b-lg relative">
        <div class="flex items-center">
            <!-- LSPD Logo -->
            <img src="LSPD.png" alt="LSPD Logo" class="mr-4 w-16 h-16 object-contain" onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';">
            <!-- Responsive font size: text-2xl for small screens, text-3xl for medium screens and up -->
            <h1 class="text-2xl md:text-3xl font-bold">Administrative Report Generator</h1>
        </div>

        <!-- Hamburger Menu Button for Mobile -->
        <button id="hamburgerBtn" class="hamburger-menu text-white focus:outline-none md:hidden">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h4"></path>
            </svg>
        </button>

        <!-- Navigation Menu -->
        <!-- Added md:flex-grow to nav to allow it to take available space -->
        <nav class="nav-links md:flex md:flex-grow md:justify-end">
            <!-- Changed md:space-x-8 to md:space-x-4 and added md:flex-wrap for stacking -->
            <ul class="flex flex-col md:flex-row md:flex-wrap md:justify-end space-y-2 md:space-y-0 md:space-x-4 text-sm font-medium">
                <li><a href="index.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700 current-page">Dashboard</a></li>
                <li><a href="SOP.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">SOPs</a></li>
                <li><a href="training.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Training</a></li>
                <li><a href="forms.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Forms</a></li>
                <li><a href="roster.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Roster</a></li>
                <li><a href="hr.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">HR Info</a></li>
                <li><a href="report.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Report Generator</a></li>
                <li><a href="charges.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Charge Calculator</a></li>
                <li><a href="info.html" class="nav-item-link text-blue-200 hover:text-white transition duration-300 ease-in-out py-1 px-2 rounded-md hover:bg-blue-700">Common Information</a></li>
            </ul>
        </nav>
        <!-- Settings Icon -->
        <img src="settings.png" alt="Settings" id="settingsIcon" class="ml-4 cursor-pointer">
    </header>
    <!-- Main Content Section -->
    <main class="w-full px-4 md:px-8 py-12 flex justify-center items-start">
        <!-- Administrative Report Generator Section -->
        <section class="bg-blue-50 p-8 rounded-lg shadow-inner w-full">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Administrative Report Generator</h2>
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full">

                <!-- Department Dropdown -->
                <div class="mb-6">
                    <label for="department" class="block text-gray-700 text-sm font-semibold mb-2">
                        Department
                    </label>
                    <select id="department"
                            name="department"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                        <option value="LSPD">Los Santos Police Department</option>
                        <option value="LSCSO">Los Santos County Sheriff's Office</option>
                        <option value="HR">Human Resources</option>
                        <option value="Training">Training Department</option>
                        <option value="Command">Command Staff</option>
                    </select>
                </div>

                <!-- Report Type Dropdown -->
                <div class="mb-6">
                    <label for="reportType" class="block text-gray-700 text-sm font-semibold mb-2">
                        Report Type
                    </label>
                    <select id="reportType"
                            name="reportType"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                        <option value="Application">Application Report</option>
                        <option value="Interview">Interview Report</option>
                        <option value="Disciplinary">Disciplinary Report</option>
                        <option value="Meeting">Meeting Minutes Report</option>
                    </select>
                </div>

                <!-- Officer/Staff Name and ID (Common for all reports) - Now clickable -->
                <div class="mb-6">
                    <label for="officerInfo" class="block text-gray-700 text-sm font-semibold mb-2">
                        Your Name and ID (e.g., Badge Number, Employee ID)
                    </label>
                    <input type="text"
                           id="officerInfo"
                           name="officerInfo"
                           placeholder="Click to select your information..."
                           readonly
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 cursor-pointer">
                </div>

                <!-- Application Report Fields -->
                <div id="applicationReportFields" class="report-fields">
                    <div class="mb-6">
                        <label for="applicantName" class="block text-gray-700 text-sm font-semibold mb-2">
                            Applicant's Full Name
                        </label>
                        <input type="text" id="applicantName" name="applicantName" placeholder="Enter applicant's full name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <div class="mb-6">
                        <label for="positionApplied" class="block text-gray-700 text-sm font-semibold mb-2">
                            Position Applied For
                        </label>
                        <input type="text" id="positionApplied" name="positionApplied" placeholder="e.g., Police Officer, Dispatcher" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <div class="mb-6">
                        <label for="applicationDate" class="block text-gray-700 text-sm font-semibold mb-2">
                            Application Date
                        </label>
                        <input type="date" id="applicationDate" name="applicationDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="applicationStatus" class="block text-gray-700 text-sm font-semibold mb-2">
                            Application Status
                        </label>
                        <select id="applicationStatus" name="applicationStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                            <option value="">Select Status</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Interview Scheduled">Interview Scheduled</option>
                            <option value="Offer Extended">Offer Extended</option>
                            <option value="Hired">Hired</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Withdrawn">Withdrawn</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="applicationNotes" class="block text-gray-700 text-sm font-semibold mb-2">
                            Notes on Application
                        </label>
                        <textarea id="applicationNotes" name="applicationNotes" rows="5" placeholder="Enter any notes or observations about the application..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                </div>

                <!-- Interview Report Fields -->
                <div id="interviewReportFields" class="report-fields hidden">
                    <div class="mb-6">
                        <label for="intervieweeName" class="block text-gray-700 text-sm font-semibold mb-2">
                            Interviewee's Full Name
                        </label>
                        <input type="text" id="intervieweeName" name="intervieweeName" placeholder="Enter interviewee's full name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <div class="mb-6">
                        <label for="interviewDate" class="block text-gray-700 text-sm font-semibold mb-2">
                            Interview Date
                        </label>
                        <input type="date" id="interviewDate" name="interviewDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="interviewTime" class="block text-gray-700 text-sm font-semibold mb-2">
                            Interview Time
                        </label>
                        <input type="time" id="interviewTime" name="interviewTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="interviewerNames" class="block text-gray-700 text-sm font-semibold mb-2">
                            Interviewer(s) Name(s)
                        </label>
                        <input type="text" id="interviewerNames" name="interviewerNames" placeholder="Enter interviewer(s) full name(s)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <!-- New Interview Questions Fields -->
                    <div class="mb-6">
                        <label for="q1Experience" class="block text-gray-700 text-sm font-semibold mb-2">
                            "Tell me about your prior experience—whether in law enforcement, the military, or security. What tools, skills, or principles from that experience do you believe will serve you best in this department?"
                        </label>
                        <textarea id="q1Experience" name="q1Experience" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q2Professionalism" class="block text-gray-700 text-sm font-semibold mb-2">
                            "Professionalism isn't just about looking sharp in uniform—it's about how you carry yourself when no one's watching. In your own words, what does being professional mean to you, and how will you uphold that on and off duty?"
                        </label>
                        <textarea id="q2Professionalism" name="q2Professionalism" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q3PersonalStrengths" class="block text-gray-700 text-sm font-semibold mb-2">
                            "Let's set aside the badge for a moment—tell me who you are as a person. What drives you? What strengths you bring to a team, and what's something you're working to improve?"
                        </label>
                        <textarea id="q3PersonalStrengths" name="q3PersonalStrengths" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q4ReportCommitment" class="block text-gray-700 text-sm font-semibold mb-2">
                            "This department demands more than just patrol presence. You'll be expected to submit detailed reports, conduct in-depth investigations, and appear in court with maturity and precision. Can you speak to your ability—and commitment—to meet these standards consistently?"
                        </label>
                        <textarea id="q4ReportCommitment" name="q4ReportCommitment" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q5ConflictOfInterest" class="block text-gray-700 text-sm font-semibold mb-2">
                            "Do you currently have—or plan to portray—a criminal cousin, family member, or close associate? If so, how do you plan to manage potential conflicts of interest and maintain the integrity of your badge?"
                        </label>
                        <textarea id="q5ConflictOfInterest" name="q5ConflictOfInterest" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q6FelonyStop" class="block text-gray-700 text-sm font-semibold mb-2">
                            "You're conducting a high-risk felony stop—suspect is wanted, armed, and potentially dangerous. You've got two other officers on scene. Walk me through, step-by-step, how you would handle this situation."
                        </label>
                        <textarea id="q6FelonyStop" name="q6FelonyStop" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q7OfficerMisconduct" class="block text-gray-700 text-sm font-semibold mb-2">
                            "Imagine you witness a fellow officer break the law while on duty—something serious, not a minor policy slip. What do you do? And how do you reconcile loyalty to the department with doing what's right?"
                        </label>
                        <textarea id="q7OfficerMisconduct" name="q7OfficerMisconduct" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q8ConflictingOrders" class="block text-gray-700 text-sm font-semibold mb-2">
                            "You receive conflicting instructions: a Sergeant tells you to break off pursuit, while a Lieutenant tells you to continue. Both gave their order at the same time. How do you handle it, and what's your reasoning?"
                        </label>
                        <textarea id="q8ConflictingOrders" name="q8ConflictingOrders" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q9ComposureUnderPressure" class="block text-gray-700 text-sm font-semibold mb-2">
                            "Policing in Los Santos can be mentally and emotionally taxing. Tell me about a time—real or fictional—when you had to stay composed under pressure. What did you learn from that moment?"
                        </label>
                        <textarea id="q9ComposureUnderPressure" name="q9ComposureUnderPressure" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="q10OfficerExpectations" class="block text-gray-700 text-sm font-semibold mb-2">
                            "If you're selected to join this department, what kind of officer should we expect you to be six months from now? What do you hope your fellow officers, supervisors, and the community say about you?"
                        </label>
                        <textarea id="q10OfficerExpectations" name="q10OfficerExpectations" rows="3" placeholder="Enter applicant's response here..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="interviewOutcome" class="block text-gray-700 text-sm font-semibold mb-2">
                            Interview Outcome <span class="text-gray-500 text-xs">(Optional: Only make a determination if you don't plan on using the recommendation of the scoring system)</span>
                        </label>
                        <select id="interviewOutcome" name="interviewOutcome" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                            <option value="">Select Outcome</option>
                            <option value="Recommended for Hire">Recommended for Hire</option>
                            <option value="Further Interview Required">Further Interview Required</option>
                            <option value="Not Recommended">Not Recommended</option>
                            <option value="Pending Decision">Pending Decision</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="interviewNotes" class="block text-gray-700 text-sm font-semibold mb-2">
                            Overall Interview Notes/Summary
                        </label>
                        <textarea id="interviewNotes" name="interviewNotes" rows="5" placeholder="Summarize the interview, key responses, and observations." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                </div>

                <!-- Disciplinary Report Fields -->
                <div id="disciplinaryReportFields" class="report-fields hidden">
                    <div class="mb-6">
                        <label for="employeeName" class="block text-gray-700 text-sm font-semibold mb-2">
                            Employee's Full Name
                        </label>
                        <input type="text" id="employeeName" name="employeeName" placeholder="Enter employee's full name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <div class="mb-6">
                        <label for="employeeID" class="block text-gray-700 text-sm font-semibold mb-2">
                            Employee ID
                        </label>
                        <input type="text" id="employeeID" name="employeeID" placeholder="Enter employee ID" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <div class="mb-6">
                        <label for="disciplinaryDate" class="block text-gray-700 text-sm font-semibold mb-2">
                            Date of Incident
                        </label>
                        <input type="date" id="disciplinaryDate" name="disciplinaryDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="disciplinaryReason" class="block text-gray-700 text-sm font-semibold mb-2">
                            Reason for Disciplinary Action
                        </label>
                        <textarea id="disciplinaryReason" name="disciplinaryReason" rows="3" placeholder="Describe the reason for disciplinary action (e.g., Policy Violation, Misconduct, Performance Issue)." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="actionTaken" class="block text-gray-700 text-sm font-semibold mb-2">
                            Action Taken
                        </label>
                        <select id="actionTaken" name="actionTaken" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                            <option value="">Select Action</option>
                            <option value="Verbal Warning">Verbal Warning</option>
                            <option value="Written Warning">Written Warning</option>
                            <option value="Suspension">Suspension</option>
                            <option value="Termination">Termination</option>
                            <option value="Other">Other (specify in notes)</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="disciplinaryNotes" class="block text-gray-700 text-sm font-semibold mb-2">
                            Disciplinary Notes
                        </label>
                        <textarea id="disciplinaryNotes" name="disciplinaryNotes" rows="5" placeholder="Provide detailed notes on the disciplinary action, including any discussions, evidence, and next steps." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                </div>

                <!-- Meeting Minutes Report Fields -->
                <div id="meetingReportFields" class="report-fields hidden">
                    <div class="mb-6">
                        <label for="meetingTitle" class="block text-gray-700 text-sm font-semibold mb-2">
                            Meeting Title/Subject
                        </label>
                        <input type="text" id="meetingTitle" name="meetingTitle" placeholder="Enter meeting title or subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400">
                    </div>
                    <div class="mb-6">
                        <label for="meetingDate" class="block text-gray-700 text-sm font-semibold mb-2">
                            Meeting Date
                        </label>
                        <input type="date" id="meetingDate" name="meetingDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="meetingTime" class="block text-gray-700 text-sm font-semibold mb-2">
                            Meeting Time
                        </label>
                        <input type="time" id="meetingTime" name="meetingTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="attendees" class="block text-gray-700 text-sm font-semibold mb-2">
                            Attendees (Names/Roles)
                        </label>
                        <textarea id="attendees" name="attendees" rows="3" placeholder="List attendees and their roles (e.g., John Doe - HR Manager, Jane Smith - Team Lead)." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="discussionPoints" class="block text-gray-700 text-sm font-semibold mb-2">
                            Key Discussion Points
                        </label>
                        <textarea id="discussionPoints" name="discussionPoints" rows="5" placeholder="Summarize the main topics discussed during the meeting." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="actionItems" class="block text-gray-700 text-sm font-semibold mb-2">
                            Action Items/Decisions
                        </label>
                        <textarea id="actionItems" name="actionItems" rows="3" placeholder="List any decisions made or action items assigned, including who is responsible and by when." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                    </div>
                </div>

                <!-- Evidence Collected (New Section) -->
                <div class="mb-6">
                    <label for="evidenceCollectedInput" class="block text-gray-700 text-sm font-semibold mb-2">
                        Supporting Documents/Evidence (Click to select)
                    </label>
                    <input type="text"
                           id="evidenceCollectedInput"
                           name="evidenceCollectedInput"
                           readonly
                           placeholder="Click to select supporting documents/evidence..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 cursor-pointer">
                </div>

                <!-- Conditional Text Areas for Statements (renamed to Notes for admin reports) -->
                <div id="victimStatementsContainer" class="mb-6 hidden">
                    <label for="victimStatementsText" class="block text-gray-700 text-sm font-semibold mb-2">
                        Applicant/Interviewee Notes
                    </label>
                    <textarea id="victimStatementsText"
                              name="victimStatementsText"
                              rows="3"
                              placeholder="Enter details of applicant/interviewee notes..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                </div>

                <div id="witnessStatementsContainer" class="mb-6 hidden">
                    <label for="witnessStatementsText" class="block text-gray-700 text-sm font-semibold mb-2">
                        Witness/Observer Notes
                    </label>
                    <textarea id="witnessStatementsText"
                              name="witnessStatementsText"
                              rows="3"
                              placeholder="Enter details of witness/observer notes..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                </div>

                <div id="suspectStatementsContainer" class="mb-6 hidden">
                    <label for="suspectStatementsText" class="block text-gray-700 text-sm font-semibold mb-2">
                        Employee Response/Statement Notes
                    </label>
                    <textarea id="suspectStatementsText"
                              name="suspectStatementsText"
                              rows="3"
                              placeholder="Enter details of employee response/statement notes..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y placeholder-gray-400"></textarea>
                </div>


                <!-- Text Area: Generated Report -->
                <div class="mb-6 relative">
                    <label for="generatedReport" class="block text-gray-700 text-sm font-semibold mb-2">
                        Generated Report
                    </label>
                    <div class="absolute top-0 right-0 mt-2 mr-2 flex space-x-2">
                        <button type="button"
                                id="copyReportBtn"
                                class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition duration-200 ease-in-out hidden"
                                title="Copy report to clipboard">
                            Copy Report
                        </button>
                        <button type="button"
                                id="downloadReportBtn"
                                class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition duration-200 ease-in-out hidden"
                                title="Download report as PDF">
                            Download Report
                        </button>
                        <!-- NEW: View Report Button -->
                        <button type="button"
                                id="viewReportBtn"
                                class="bg-purple-500 hover:bg-purple-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md transition duration-200 ease-in-out hidden"
                                title="View report in new tab">
                            View Report
                        </button>
                    </div>
                    <textarea id="generatedReport"
                              name="generatedReport"
                              rows="10"
                              readonly
                              placeholder="Your generated report will appear here..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm resize-y pt-10"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="mt-8">
                    <button type="button"
                            id="generateReportBtn"
                            class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out shadow-md">
                        Generate Report
                    </button>
                </div>

                <!-- Loading Indicator for AI Generation -->
                <div id="loadingIndicator" class="hidden text-center text-blue-600 mt-4 font-semibold">
                    Generating report... Please wait.
                </div>
            </div>
        </section>
    </main>

    <!-- Officer/Staff Selection Modal -->
    <div id="officerSelectionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Select Your Information</h3>
            <input type="text"
                   id="officerSearchInput"
                   placeholder="Search name or ID..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div id="officerList" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2 mb-4">
                <!-- Officer/Staff list will be populated here -->
                <div class="loader mx-auto my-4"></div> <!-- Loader for officer list -->
            </div>
            <div class="flex justify-end space-x-4">
                <button id="closeOfficerModalBtn"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Evidence Selection Modal -->
    <div id="evidenceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Select Supporting Documents/Evidence</h3>
            <div id="evidenceList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                <!-- Evidence items will be populated here by JavaScript -->
            </div>
            <div id="evidenceDescriptionDisplay" class="evidence-description text-gray-600 mb-4">
                Hover over an item for more details.
            </div>
            <button id="closeEvidenceModalBtn"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                Close
            </button>
        </div>
    </div>

    <!-- URL Input Modal -->
    <div id="urlInputModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="urlModalTitle">Add Link</h3>
            <p class="text-gray-600 text-sm mb-4" id="allowedProvidersText"></p>
            <input type="url"
                   id="evidenceUrlInput"
                   name="evidenceUrlInput"
                   placeholder="Enter URL here..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out shadow-sm placeholder-gray-400 mb-2">
            <p id="urlValidationError" class="text-red-600 text-sm mb-4 hidden"></p>
            <div id="currentLinksDisplay" class="mb-4 text-sm text-gray-700">
                <!-- Added links will appear here -->
            </div>
            <div class="flex justify-end space-x-4">
                <button id="addUrlBtn"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Add Link
                </button>
                <button id="closeUrlModalBtn"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Settings</h3>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Website Theme</h4>
                <div class="radio-option">
                    <input type="radio" id="lightMode" name="theme" value="light" class="text-blue-600">
                    <label for="lightMode">Light Mode</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="darkMode" name="theme" value="dark" class="text-blue-600">
                    <label for="darkMode">Dark Mode</label>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Data Management</h4>
                <button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md w-full mb-2">
                    Clear All Local Data
                </button>
                <button id="viewDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md w-full">
                    View Stored Data
                </button>
            </div>

            <div class="flex justify-end mt-4">
                <button id="closeSettingsModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Data Viewer Modal -->
    <div id="dataViewerModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Local Storage Data</h3>
            <div id="dataViewerContent" class="space-y-4">
                <!-- Data will be loaded here dynamically -->
            </div>
            <div class="flex justify-end mt-4">
                <button id="closeDataViewerModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- Delete All Data Confirmation Modal -->
    <div id="confirmDeleteModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Data Deletion</h3>
            <p class="text-gray-700 mb-6">
                Are you sure you want to completely delete ALL website data from your device?
                This includes saved form data and theme preferences.
                This action cannot be undone.
            </p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteYesBtn"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    Yes, Delete All
                </button>
                <button id="confirmDeleteNoBtn"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md">
                    No, Keep Data
                </button>
            </div>
        </div>
    </div>


    <!-- Footer Section - Internal Contacts -->
    <footer class="bg-gray-800 text-white py-10 px-6 md:px-12 rounded-t-lg">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">Internal Contacts</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://discord.gg/7FwxdpfDTM" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Discord</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1383775099777318972" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">UPD Chat</a></li>
                    <li><a href="https://discord.com/channels/1383775098464370768/1383782578976456735" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Cadet Support</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">Quick Access</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://docs.google.com/document/d/1etjilZ1dAHGviw33MV5Zs-b5dXqcSHyoYIHvHiRIyy4/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">LSPD SOP</a></li>
                    <li><a href="https://docs.google.com/document/d/1hKQ4fw9b1_yQELhPi1p1b4M6uiSaYb7bBp-9C6GVTdY/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Los Santos Police Department Interview Procedure & Questions</a></li>
                    <li><a href="https://docs.google.com/document/d/1d004FfAhZBgESn88Mx21N3CGqXlcoNeP9_sadn_ePak/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Promotional Pathway & Subdivision Assignment Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/14QIEsYMWpTssti1xGbGWiMxQ2b0jbiYxuMmvV8XWUUo/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Highway Enforcement and Apprehension Team (HEAT) Activation Policy</a></li>
                    <li><a href="https://docs.google.com/document/d/1Ggf7SS5voiIjr3iSLB3VtAc47JN3aDjm2J_gYnpoZ6s/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Disciplinary Guidelines</a></li>
                    <li><a href="privacypolicy.html" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white hover:underline transition duration-300 ease-in-out">Privacy Policy</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-xl font-semibold mb-4 text-blue-300">System Information</h4>
                <p class="text-gray-500 text-sm mb-2">Unauthorized Access Strictly Prohibited</p>
                <p class="text-gray-500 text-sm mb-2">For LSPD Personnel Use Only</p>
                <p class="text-500 text-sm mb-2">Created and Maintained by FiveM "NightLife RP"</p>
                <p class="text-gray-500 text-sm">&copy; 2025 Los Santos Police Department Internal Systems.</p>
            </div>
        </div>
        <!-- Font Awesome for any potential internal icons (though less needed here) -->
        <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    </footer>

    <script>
        // Get references to common elements
        const departmentSelect = document.getElementById('department');
        const reportTypeSelect = document.getElementById('reportType');
        const officerInfoInput = document.getElementById('officerInfo'); // Common officer info field
        const generatedReportTextarea = document.getElementById('generatedReport');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Get references to report-specific field containers
        const applicationReportFields = document.getElementById('applicationReportFields');
        const interviewReportFields = document.getElementById('interviewReportFields');
        const disciplinaryReportFields = document.getElementById('disciplinaryReportFields');
        const meetingReportFields = document.getElementById('meetingReportFields');

        // Get references to Application Report specific elements
        const applicantNameInput = document.getElementById('applicantName');
        const positionAppliedInput = document.getElementById('positionApplied');
        const applicationDateInput = document.getElementById('applicationDate');
        const applicationStatusSelect = document.getElementById('applicationStatus');
        const applicationNotesTextarea = document.getElementById('applicationNotes');

        // Get references to Interview Report specific elements
        const intervieweeNameInput = document.getElementById('intervieweeName');
        const interviewDateInput = document = document.getElementById('interviewDate');
        const interviewTimeInput = document.getElementById('interviewTime');
        const interviewerNamesInput = document.getElementById('interviewerNames');
        const interviewOutcomeSelect = document.getElementById('interviewOutcome');
        const interviewNotesTextarea = document.getElementById('interviewNotes');

        // New Interview Question Textareas
        const q1ExperienceTextarea = document.getElementById('q1Experience');
        const q2ProfessionalismTextarea = document.getElementById('q2Professionalism');
        const q3PersonalStrengthsTextarea = document.getElementById('q3PersonalStrengths');
        const q4ReportCommitmentTextarea = document.getElementById('q4ReportCommitment');
        const q5ConflictOfInterestTextarea = document.getElementById('q5ConflictOfInterest');
        const q6FelonyStopTextarea = document.getElementById('q6FelonyStop');
        const q7OfficerMisconductTextarea = document.getElementById('q7OfficerMisconduct');
        const q8ConflictingOrdersTextarea = document.getElementById('q8ConflictingOrders');
        const q9ComposureUnderPressureTextarea = document.getElementById('q9ComposureUnderPressure');
        const q10OfficerExpectationsTextarea = document.getElementById('q10OfficerExpectations');


        // Get references to Disciplinary Report specific elements
        const employeeNameInput = document.getElementById('employeeName');
        const employeeIDInput = document.getElementById('employeeID');
        const disciplinaryDateInput = document.getElementById('disciplinaryDate');
        const disciplinaryReasonTextarea = document.getElementById('disciplinaryReason');
        const actionTakenSelect = document.getElementById('actionTaken');
        const disciplinaryNotesTextarea = document.getElementById('disciplinaryNotes');

        // Get references to Meeting Minutes Report specific elements
        const meetingTitleInput = document.getElementById('meetingTitle');
        const meetingDateInput = document.getElementById('meetingDate');
        const meetingTimeInput = document.getElementById('meetingTime');
        const attendeesTextarea = document.getElementById('attendees');
        const discussionPointsTextarea = document = document.getElementById('discussionPoints');
        const actionItemsTextarea = document.getElementById('actionItems');


        // Evidence Collection Elements (renamed for administrative context)
        const evidenceCollectedInput = document.getElementById('evidenceCollectedInput');
        const evidenceModal = document.getElementById('evidenceModal');
        const closeEvidenceModalBtn = document.getElementById('closeEvidenceModalBtn');
        const evidenceListDiv = document.getElementById('evidenceList');
        const evidenceDescriptionDisplay = document.getElementById('evidenceDescriptionDisplay');

        // Conditional Statement Text Areas (renamed for administrative context)
        const victimStatementsContainer = document.getElementById('victimStatementsContainer'); // Re-purposed for Applicant/Interviewee Notes
        const victimStatementsTextarea = document.getElementById('victimStatementsText');
        const witnessStatementsContainer = document.getElementById('witnessStatementsContainer'); // Re-purposed for Witness/Observer Notes
        const witnessStatementsTextarea = document.getElementById('witnessStatementsText');
        const suspectStatementsContainer = document.getElementById('suspectStatementsContainer'); // Re-purposed for Employee Response/Statement Notes
        const suspectStatementsTextarea = document.getElementById('suspectStatementsText');

        // URL Input Modal Elements
        const urlInputModal = document.getElementById('urlInputModal');
        const urlModalTitle = document.getElementById('urlModalTitle');
        const allowedProvidersText = document.getElementById('allowedProvidersText');
        const evidenceUrlInput = document.getElementById('evidenceUrlInput');
        const urlValidationError = document.getElementById('urlValidationError');
        const currentLinksDisplay = document.getElementById('currentLinksDisplay');
        const addUrlBtn = document.getElementById('addUrlBtn');
        const closeUrlModalBtn = document.getElementById('closeUrlModalBtn');

        // Officer/Staff Selection Modal Elements
        const officerSelectionModal = document.getElementById('officerSelectionModal');
        const officerSearchInput = document.getElementById('officerSearchInput');
        const officerListDiv = document.getElementById('officerList');
        const closeOfficerModalBtn = document.getElementById('closeOfficerModalBtn');

        // Settings Modal Elements (New)
        const settingsIcon = document.getElementById('settingsIcon');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const lightModeRadio = document.getElementById('lightMode');
        const darkModeRadio = document.getElementById('darkMode');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const viewDataBtn = document.getElementById('viewDataBtn');

        // Data Viewer Modal Elements (New)
        const dataViewerModal = document.getElementById('dataViewerModal');
        const dataViewerContent = document.getElementById('dataViewerContent');
        const closeDataViewerModalBtn = document.getElementById('closeDataViewerModalBtn');

        // Delete All Data Confirmation Modal Elements (New)
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteYesBtn = document.getElementById('confirmDeleteYesBtn');
        const confirmDeleteNoBtn = document.getElementById('confirmDeleteNoBtn');


        // Global object to store selected evidence and their details (including links/text)
        let selectedEvidenceDetails = {};

        // Global variable to store fetched officer/staff roster data
        let officerRosterData = [];

        /**
         * Converts an Excel-style column letter (e.g., 'A', 'B', 'AA') to a 0-based index.
         * @param {string} columnLetter - The column letter (e.g., 'C').
         * @returns {number} The 0-based column index (e.g., 'C' returns 2).
         */
        function columnLetterToIndex(columnLetter) {
            let index = 0;
            for (let i = 0; i < columnLetter.length; i++) {
                index = index * 26 + (columnLetter.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
            }
            return index - 1; // Convert to 0-based index
        }

        /**
         * Fetches CSV data from a Google Sheet, parses it, and populates the officerRosterData.
         * This function is called when the officer selection modal is opened.
         */
        async function fetchAndSetOfficerRosterData() {
            officerListDiv.innerHTML = '<div class="loader mx-auto my-4"></div>'; // Show loader

            const sheetId = '1o4Xw8GSQBp6brMfGo_ubYngnhWJU_f8AhyUIftAlT1Y';
            const gid = '0'; // Assuming gid=0 for the primary sheet tab
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();

                const rawRows = csvText.trim().split('\n');
                if (rawRows.length === 0) {
                    console.warn('No roster data available from Google Sheet.');
                    officerRosterData = []; // Ensure it's empty
                    officerListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No officers/staff found.</p>';
                    return;
                }

                // Define the target spreadsheet row numbers (1-indexed)
                const targetSpreadsheetRows = new Set();
                const addRange = (start, end) => {
                    for (let i = start; i <= end; i++) {
                        targetSpreadsheetRows.add(i);
                    }
                };

                targetSpreadsheetRows.add(6);
                targetSpreadsheetRows.add(9);
                targetSpreadsheetRows.add(10);
                targetSpreadsheetRows.add(11);
                addRange(12, 16);
                addRange(18, 22);
                addRange(24, 27);
                addRange(29, 32);
                addRange(34, 43);
                addRange(45, 54);
                addRange(56, 65);
                addRange(67, 78);
                addRange(80, 96);
                addRange(98, 117);
                addRange(119, 148);

                const filteredRowsData = [];
                const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; // Regex to split by comma, ignoring commas in double quotes

                rawRows.forEach((rowString, index) => {
                    const spreadsheetRowNumber = index + 1; // CSV rows are 0-indexed, spreadsheet rows are 1-indexed
                    if (targetSpreadsheetRows.has(spreadsheetRowNumber)) {
                        // Parse each cell, removing quotes if present
                        const parsedCells = rowString.split(regex).map(cell => cell.replace(/^"(.*)"$/, '$1').trim());
                        filteredRowsData.push(parsedCells);
                    }
                });

                // Define the mapping from desired fields to their original column indices
                const headerToColIndexMap = {
                    'Badge No.': columnLetterToIndex('C'),
                    'Name': columnLetterToIndex('D'),
                };

                const tempOfficerRoster = [];
                filteredRowsData.forEach(rowData => {
                    const name = rowData[headerToColIndexMap['Name']] ? rowData[headerToColIndexMap['Name']].trim() : '';
                    const badge = rowData[headerToColIndexMap['Badge No.']] ? rowData[headerToColIndexMap['Badge No.']].trim() : '';

                    // Only add if both name and badge are present and not 'N/A' or empty
                    if (name && name !== 'N/A' && badge && badge !== 'N/A') {
                        tempOfficerRoster.push({ name: name, badge: badge });
                    }
                });
                officerRosterData = tempOfficerRoster; // Update the global roster data
                populateOfficerList(officerRosterData); // Populate the modal list with fetched data
            } catch (error) {
                console.error('Error fetching or parsing roster data:', error);
                officerListDiv.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load officer roster. Please try again later.</p>';
            }
        }


        // Array of supporting document/evidence items with descriptions, types, and allowed link providers
        const evidenceItems = [
            { name: "Application Form", description: "The submitted application form.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Resume/CV", description: "Applicant's resume or curriculum vitae.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Cover Letter", description: "Applicant's cover letter.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Interview Questions/Answers", description: "Record of questions asked and answers provided during an interview.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Performance Reviews", description: "Official employee performance evaluations.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Policy Documents", description: "Relevant company or departmental policy documents.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Email Correspondence", description: "Emails relevant to the report.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Meeting Agendas", description: "Agendas distributed for meetings.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Previous Disciplinary Records", description: "Records of prior disciplinary actions against an employee.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Training Records", description: "Records of employee training and certifications.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
            { name: "Witness Statements (Admin)", description: "Written or recorded accounts from individuals observing an administrative incident.", type: "statement" },
            { name: "Employee Response/Statement", description: "Written or recorded admissions or accounts from the employee.", type: "statement" },
            { name: "Applicant/Interviewee Notes", description: "Notes taken during the application or interview process regarding the individual.", type: "statement" },
            { name: "Audio Recordings (Admin)", description: "Voice recordings of interviews, meetings, or relevant discussions.", type: "video", linkProviders: ["discord.com", "medal.tv", "youtube.com", "drive.google.com"] },
            { name: "Video Recordings (Admin)", description: "Video recordings of interviews, meetings, or relevant incidents.", type: "video", linkProviders: ["discord.com", "medal.tv", "youtube.com", "drive.google.com"] },
            { name: "Other Supporting Documents", description: "Any other relevant documents not categorized above.", type: "document", linkProviders: ["fivemanage.com", "google.com", "dropbox.com"] },
        ];

        // Function to populate the evidence modal
        function populateEvidenceList() {
            evidenceListDiv.innerHTML = ''; // Clear existing list
            evidenceItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'evidence-item flex items-center p-2 rounded-md hover:bg-blue-100 cursor-pointer';
                div.innerHTML = `
                                                    <input type="checkbox" id="evidence-${item.name.replace(/\s/g, '-')}" value="${item.name}" class="form-checkbox h-5 w-5 text-blue-600 rounded-md">
                                                    <label for="evidence-${item.name.replace(/\s/g, '-')}" class="ml-2 text-gray-800 text-sm font-medium flex-grow">${item.name}</label>
                                                `;
                div.setAttribute('data-description', item.description);
                div.setAttribute('data-type', item.type);
                if (item.linkProviders) {
                    div.setAttribute('data-link-providers', item.linkProviders.join(','));
                }

                // Add event listeners for hover to display description
                div.addEventListener('mouseenter', () => {
                    evidenceDescriptionDisplay.textContent = item.description;
                });
                div.addEventListener('mouseleave', () => {
                    evidenceDescriptionDisplay.textContent = 'Hover over an item for more details.';
                });

                // Add event listener for checkbox change
                const checkbox = div.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (e) => {
                    const itemName = e.target.value;
                    const itemType = e.target.closest('.evidence-item').dataset.type;
                    const itemLinkProviders = e.target.closest('.evidence-item').dataset.linkProviders ? e.target.closest('.evidence-item').dataset.linkProviders.split(',') : [];

                    if (e.target.checked) {
                        selectedEvidenceDetails[itemName] = { type: itemType, links: [], text: '' };
                        if (itemType === 'statement') {
                            // Show the corresponding text area (re-purposed for admin notes)
                            switch (itemName) {
                                case 'Applicant/Interviewee Notes': victimStatementsContainer.classList.remove('hidden'); break;
                                case 'Witness Statements (Admin)': witnessStatementsContainer.classList.remove('hidden'); break;
                                case 'Employee Response/Statement': suspectStatementsContainer.classList.remove('hidden'); break;
                            }
                        } else if (itemType === 'document' || itemType === 'video') {
                            // Open URL input modal
                            evidenceModal.classList.add('hidden'); // Hide evidence modal first
                            openUrlInputModal(itemName, itemLinkProviders);
                        }
                    } else {
                        delete selectedEvidenceDetails[itemName];
                        if (itemType === 'statement') {
                            // Hide the corresponding text area and clear its content
                            switch (itemName) {
                                case 'Applicant/Interviewee Notes': victimStatementsContainer.classList.add('hidden'); victimStatementsTextarea.value = ''; break;
                                case 'Witness Statements (Admin)': witnessStatementsContainer.classList.add('hidden'); witnessStatementsTextarea.value = ''; break;
                                case 'Employee Response/Statement': suspectStatementsContainer.classList.add('hidden'); suspectStatementsTextarea.value = ''; break;
                            }
                        }
                    }
                    updateEvidenceCollectedInputSummary();
                    saveFormData(); // Save data after evidence selection changes
                });

                evidenceListDiv.appendChild(div);
            });
        }

        // Function to open the URL input modal
        function openUrlInputModal(itemName, providers) {
            urlModalTitle.textContent = `Add Links for ${itemName}`;
            allowedProvidersText.textContent = `Allowed providers: ${providers.map(p => p.replace('https://', '')).join(', ')}`;
            evidenceUrlInput.value = '';
            urlValidationError.classList.add('hidden');
            currentLinksDisplay.innerHTML = ''; // Clear previous links

            // Populate current links if any exist for this item
            if (selectedEvidenceDetails[itemName] && selectedEvidenceDetails[itemName].links) {
                selectedEvidenceDetails[itemName].links.forEach(link => {
                    const p = document.createElement('p');
                    p.textContent = link;
                    currentLinksDisplay.appendChild(p);
                });
            }

            urlInputModal.dataset.currentItem = itemName; // Store the current item being edited
            urlInputModal.dataset.allowedProviders = providers.join(','); // Store allowed providers
            urlInputModal.classList.remove('hidden');
        }

        // Function to validate URL
        function isValidUrl(url, allowedProviders) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname;
                return allowedProviders.some(provider => hostname.includes(provider));
            } catch (e) {
                return false;
            }
        }

        // Function to update the main evidence input field summary and its title attribute for hover
        function updateEvidenceCollectedInputSummary() {
            const summaryParts = [];
            const hoverTextParts = []; // To store text for the title attribute

            for (const itemName in selectedEvidenceDetails) {
                const item = selectedEvidenceDetails[itemName];
                if (item.type === 'statement') {
                    if (item.text.trim() !== '') {
                        summaryParts.push(`${itemName} (D)`); // (D) for details
                        hoverTextParts.push(`${itemName}: ${item.text.trim()}`);
                    } else {
                        summaryParts.push(itemName);
                        hoverTextParts.push(`${itemName}: No details provided.`);
                    }
                } else if (item.type === 'document' || item.type === 'video') {
                    if (item.links.length > 0) {
                        summaryParts.push(`${itemName} (L)`); // (L) for links
                        hoverTextParts.push(`${itemName}: ${item.links.join(', ')}`);
                    } else {
                        summaryParts.push(itemName);
                        hoverTextParts.push(`${itemName}: No links provided.`);
                    }
                } else {
                    summaryParts.push(itemName);
                    hoverTextParts.push(itemName); // Fallback for other types
                }
            }
            evidenceCollectedInput.value = summaryParts.join(', ');
            evidenceCollectedInput.title = hoverTextParts.join('\n'); // Set the title attribute for hover
        }


        // Function to show/hide fields based on report type
        function toggleReportFields() {
            const selectedReportType = reportTypeSelect.value;

            // Hide all report-specific field containers
            applicationReportFields.classList.add('hidden');
            interviewReportFields.classList.add('hidden');
            disciplinaryReportFields.classList.add('hidden');
            meetingReportFields.classList.add('hidden');

            // Hide all statement containers
            victimStatementsContainer.classList.add('hidden');
            witnessStatementsContainer.classList.add('hidden');
            suspectStatementsContainer.classList.add('hidden');

            // Show fields relevant to the selected report type
            switch (selectedReportType) {
                case 'Application':
                    applicationReportFields.classList.remove('hidden');
                    break;
                case 'Interview':
                    interviewReportFields.classList.remove('hidden');
                    break;
                case 'Disciplinary':
                    disciplinaryReportFields.classList.remove('hidden');
                    break;
                case 'Meeting':
                    meetingReportFields.classList.remove('hidden');
                    break;
                default:
                    // No default action, all fields remain hidden
                    break;
            }

            // Re-evaluate visibility of statement text areas based on selectedEvidenceDetails
            for (const itemName in selectedEvidenceDetails) {
                const item = selectedEvidenceDetails[itemName];
                if (item.type === 'statement') {
                    switch (itemName) {
                        case 'Applicant/Interviewee Notes': victimStatementsContainer.classList.remove('hidden'); break;
                        case 'Witness Statements (Admin)': witnessStatementsContainer.classList.remove('hidden'); break;
                        case 'Employee Response/Statement': suspectStatementsContainer.classList.remove('hidden'); break;
                    }
                }
            }
            saveFormData(); // Save data after toggling fields
        }

        // Function to populate the officer/staff list in the modal
        function populateOfficerList(officers, searchTerm = '') {
            officerListDiv.innerHTML = ''; // Clear existing list
            const filteredOfficers = officers.filter(officer =>
                officer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                officer.badge.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredOfficers.length === 0) {
                officerListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No officers/staff found.</p>';
                return;
            }

            filteredOfficers.forEach(officer => {
                const div = document.createElement('div');
                div.className = 'officer-item p-2 rounded-md hover:bg-blue-100 cursor-pointer text-gray-800 text-sm font-medium';
                div.textContent = `${officer.name} (${officer.badge})`;
                div.dataset.name = officer.name;
                div.dataset.badge = officer.badge;

                div.addEventListener('click', () => {
                    officerInfoInput.value = `${officer.name} (${officer.badge})`;
                    officerSelectionModal.classList.add('hidden');
                    saveFormData(); // Save data after officer selection
                });
                officerListDiv.appendChild(div);
            });
        }

        // Function to gather all form data
        function getFormData() {
            return {
                department: departmentSelect.value,
                reportType: reportTypeSelect.value,
                officerInfo: officerInfoInput.value,
                applicantName: applicantNameInput.value,
                positionApplied: positionAppliedInput.value,
                applicationDate: applicationDateInput.value,
                applicationStatus: applicationStatusSelect.value,
                applicationNotes: applicationNotesTextarea.value,
                intervieweeName: intervieweeNameInput.value,
                interviewDate: interviewDateInput.value,
                interviewTime: interviewTimeInput.value,
                interviewerNames: interviewerNamesInput.value,
                q1Experience: q1ExperienceTextarea.value,
                q2Professionalism: q2ProfessionalismTextarea.value,
                q3PersonalStrengths: q3PersonalStrengthsTextarea.value,
                q4ReportCommitment: q4ReportCommitmentTextarea.value,
                q5ConflictOfInterest: q5ConflictOfInterestTextarea.value,
                q6FelonyStop: q6FelonyStopTextarea.value,
                q7OfficerMisconduct: q7OfficerMisconductTextarea.value,
                q8ConflictingOrders: q8ConflictingOrdersTextarea.value,
                q9ComposureUnderPressure: q9ComposureUnderPressureTextarea.value,
                q10OfficerExpectations: q10OfficerExpectationsTextarea.value,
                interviewOutcome: interviewOutcomeSelect.value,
                interviewNotes: interviewNotesTextarea.value,
                employeeName: employeeNameInput.value,
                employeeID: employeeIDInput.value,
                disciplinaryDate: disciplinaryDateInput.value,
                disciplinaryReason: disciplinaryReasonTextarea.value,
                actionTaken: actionTakenSelect.value,
                disciplinaryNotes: disciplinaryNotesTextarea.value,
                meetingTitle: meetingTitleInput.value,
                meetingDate: meetingDateInput.value,
                meetingTime: meetingTimeInput.value,
                attendees: attendeesTextarea.value,
                discussionPoints: discussionPointsTextarea.value,
                actionItems: actionItemsTextarea.value,
                selectedEvidenceDetails: selectedEvidenceDetails, // Save the entire object
                applicantIntervieweeNotes: victimStatementsTextarea.value, // Re-purposed
                witnessObserverNotes: witnessStatementsTextarea.value, // Re-purposed
                employeeResponseStatementNotes: suspectStatementsTextarea.value, // Re-purposed
            };
        }

        // Function to save form data to local storage
        function saveFormData() {
            const data = getFormData();
            localStorage.setItem('adminReportGeneratorData', JSON.stringify(data));
        }

        // Function to load form data from local storage
        function loadFormData() {
            const savedData = localStorage.getItem('adminReportGeneratorData');
            if (savedData) {
                const data = JSON.parse(savedData);

                departmentSelect.value = data.department || '';
                reportTypeSelect.value = data.reportType || 'Application'; // Default if not found
                officerInfoInput.value = data.officerInfo || '';
                applicantNameInput.value = data.applicantName || '';
                positionAppliedInput.value = data.positionApplied || '';
                applicationDateInput.value = data.applicationDate || '';
                applicationStatusSelect.value = data.applicationStatus || '';
                applicationNotesTextarea.value = data.applicationNotes || '';
                intervieweeNameInput.value = data.intervieweeName || '';
                interviewDateInput.value = data.interviewDate || '';
                interviewTimeInput.value = data.interviewTime || '';
                interviewerNamesInput.value = data.interviewerNames || '';
                q1ExperienceTextarea.value = data.q1Experience || '';
                q2ProfessionalismTextarea.value = data.q2Professionalism || '';
                q3PersonalStrengthsTextarea.value = data.q3PersonalStrengths || '';
                q4ReportCommitmentTextarea.value = data.q4ReportCommitment || '';
                q5ConflictOfInterestTextarea.value = data.q5ConflictOfInterest || '';
                q6FelonyStopTextarea.value = data.q6FelonyStop || '';
                q7OfficerMisconductTextarea.value = data.q7OfficerMisconduct || '';
                q8ConflictingOrdersTextarea.value = data.q8ConflictingOrders || '';
                q9ComposureUnderPressureTextarea.value = data.q9ComposureUnderPressure || '';
                q10OfficerExpectationsTextarea.value = data.q10OfficerExpectations || '';
                interviewOutcomeSelect.value = data.interviewOutcome || '';
                interviewNotesTextarea.value = data.interviewNotes || '';
                employeeNameInput.value = data.employeeName || '';
                employeeIDInput.value = data.employeeID || '';
                disciplinaryDateInput.value = data.disciplinaryDate || '';
                disciplinaryReasonTextarea.value = data.disciplinaryReason || '';
                actionTakenSelect.value = data.actionTaken || '';
                disciplinaryNotesTextarea.value = data.disciplinaryNotes || '';
                meetingTitleInput.value = data.meetingTitle || '';
                meetingDateInput.value = data.meetingDate || '';
                meetingTimeInput.value = data.meetingTime || '';
                attendeesTextarea.value = data.attendees || '';
                discussionPointsTextarea.value = data.discussionPoints || '';
                actionItemsTextarea.value = data.actionItems || '';

                // Restore selectedEvidenceDetails and update related UI
                selectedEvidenceDetails = data.selectedEvidenceDetails || {};
                updateEvidenceCollectedInputSummary();
                victimStatementsTextarea.value = data.applicantIntervieweeNotes || '';
                witnessStatementsTextarea.value = data.witnessObserverNotes || '';
                suspectStatementsTextarea.value = data.employeeResponseStatementNotes || '';

                // After loading, ensure correct fields are shown
                toggleReportFields();
            }
        }

        // Add event listener to report type dropdown to toggle fields
        reportTypeSelect.addEventListener('change', toggleReportFields);

        // Initialize fields visibility and populate evidence list on page load
        document.addEventListener('DOMContentLoaded', () => {
            toggleReportFields();
            populateEvidenceList();
            loadFormData(); // Load saved data

            // Check for loggedInOfficer in local storage and pre-fill officerInfoInput
            const loggedInOfficer = localStorage.getItem('loggedInOfficer');
            if (loggedInOfficer) {
                try {
                    const officer = JSON.parse(loggedInOfficer);
                    officerInfoInput.value = `${officer.name} (${officer.badge})`;
                    saveFormData(); // Save this pre-filled data to adminReportGeneratorData
                } catch (e) {
                    console.error('Error parsing loggedInOfficer from localStorage:', e);
                    localStorage.removeItem('loggedInOfficer'); // Clear corrupted data
                }
            }
            // Apply theme on load
            applyTheme(localStorage.getItem('theme') || 'light');
        });

        // Add event listeners to all form fields for saving data
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('input', saveFormData);
            element.addEventListener('change', saveFormData); // For select elements
        });

        // Event listeners for opening and closing the evidence modal
        evidenceCollectedInput.addEventListener('click', () => {
            evidenceModal.classList.remove('hidden');
            // Ensure checkboxes reflect current selectedEvidenceDetails when modal opens
            evidenceListDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = !!selectedEvidenceDetails[checkbox.value];
            });
            evidenceDescriptionDisplay.textContent = 'Hover over an item for more details.'; // Reset description display
        });

        closeEvidenceModalBtn.addEventListener('click', () => {
            evidenceModal.classList.add('hidden');
            saveFormData(); // Save data when evidence modal is closed
        });

        // Close modal when clicking outside of it
        evidenceModal.addEventListener('click', (e) => {
            if (e.target === evidenceModal) {
                evidenceModal.classList.add('hidden');
                saveFormData(); // Save data when evidence modal is closed by clicking outside
            }
        });

        // URL Modal Logic
        addUrlBtn.addEventListener('click', () => {
            const url = evidenceUrlInput.value.trim();
            const currentItemName = urlInputModal.dataset.currentItem;
            const allowedProviders = urlInputModal.dataset.allowedProviders.split(',');

            urlValidationError.classList.add('hidden'); // Hide previous errors

            if (!url) {
                urlValidationError.textContent = 'URL cannot be empty.';
                urlValidationError.classList.remove('hidden');
                return;
            }

            if (!isValidUrl(url, allowedProviders)) {
                urlValidationError.textContent = `Invalid URL or not from allowed providers: ${allowedProviders.map(p => p.replace('https://', '')).join(', ')}.`;
                urlValidationError.classList.remove('hidden');
                return;
            }

            if (selectedEvidenceDetails[currentItemName]) {
                if (!selectedEvidenceDetails[currentItemName].links.includes(url)) {
                    selectedEvidenceDetails[currentItemName].links.push(url);
                    const p = document.createElement('p');
                    p.textContent = url;
                    currentLinksDisplay.appendChild(p);
                }
            }
            evidenceUrlInput.value = ''; // Clear input after adding
            updateEvidenceCollectedInputSummary(); // Update summary immediately after adding a link
            saveFormData(); // Save data after adding a URL
        });

        closeUrlModalBtn.addEventListener('click', () => {
            urlInputModal.classList.add('hidden');
            evidenceModal.classList.remove('hidden'); // Bring back the evidence selection modal
            updateEvidenceCollectedInputSummary(); // Ensure summary is updated when done
            saveFormData(); // Save data when URL modal is closed
        });

        urlInputModal.addEventListener('click', (e) => {
            if (e.target === urlInputModal) {
                urlInputModal.classList.add('hidden');
                evidenceModal.classList.remove('hidden'); // Bring back the evidence selection modal
                // This block handles the case where the user closes the URL modal by clicking outside
                // If no links were added for the current item, uncheck its checkbox and remove it from selectedEvidenceDetails
                const currentItemName = urlInputModal.dataset.currentItem;
                if (selectedEvidenceDetails[currentItemName] && selectedEvidenceDetails[currentItemName].links.length === 0) {
                    const checkbox = document.getElementById(`evidence-${currentItemName.replace(/\s/g, '-')}`);
                    if (checkbox) {
                        checkbox.checked = false;
                        delete selectedEvidenceDetails[currentItemName]; // Remove from details if no links
                    }
                }
                updateEvidenceCollectedInputSummary(); // Ensure summary is updated after any modal closure
                saveFormData(); // Save data when URL modal is closed by clicking outside
            }
        });

        // Officer/Staff Selection Modal Logic
        officerInfoInput.addEventListener('click', async () => {
            officerSelectionModal.classList.remove('hidden');
            officerSearchInput.value = ''; // Clear search input
            officerListDiv.innerHTML = '<div class="loader mx-auto my-4"></div>'; // Show loader inside modal
            await fetchAndSetOfficerRosterData(); // Fetch and populate
        });

        officerSearchInput.addEventListener('input', (e) => {
            populateOfficerList(officerRosterData, e.target.value);
        });

        closeOfficerModalBtn.addEventListener('click', () => {
            officerSelectionModal.classList.add('hidden');
            saveFormData(); // Save data when officer modal is closed
        });

        officerSelectionModal.addEventListener('click', (e) => {
            if (e.target === officerSelectionModal) {
                officerSelectionModal.classList.add('hidden');
                saveFormData(); // Save data when officer modal is closed by clicking outside
            }
        });

        // Update selectedEvidenceDetails for statement text areas on input
        victimStatementsTextarea.addEventListener('input', (e) => {
            if (selectedEvidenceDetails['Applicant/Interviewee Notes']) {
                selectedEvidenceDetails['Applicant/Interviewee Notes'].text = e.target.value;
            }
            updateEvidenceCollectedInputSummary();
            saveFormData();
        });
        witnessStatementsTextarea.addEventListener('input', (e) => {
            if (selectedEvidenceDetails['Witness Statements (Admin)']) {
                selectedEvidenceDetails['Witness Statements (Admin)'].text = e.target.value;
            }
            updateEvidenceCollectedInputSummary();
            saveFormData();
        });
        suspectStatementsTextarea.addEventListener('input', (e) => {
            if (selectedEvidenceDetails['Employee Response/Statement']) {
                selectedEvidenceDetails['Employee Response/Statement'].text = e.target.value;
            }
            updateEvidenceCollectedInputSummary();
            saveFormData();
        });


        // IMPORTANT: Gemini API Key Configuration
        // If you are running this code on YOUR OWN WEB SERVER:
        // 1. Go to Google AI Studio (https://aistudio.google.com/app/apikey) or Google Cloud.
        // 2. Generate a new API key.
        // 3. Replace the empty string below with your ACTUAL, VALID API key.
        //    Example: const apiKey = "YOUR_ACTUAL_GEMINI_API_KEY_HERE";
        // If you are running this within the Google Canvas environment, leave this as "".
        const apiKey = "AIzaSyCsWMWfmCfR59mcAy4as7XR95YY__7hayc"; // Leave empty for Google Canvas environment

        // Add event listener to the "Generate Report" button
        generateReportBtn.addEventListener('click', async () => {
            const selectedReportType = reportTypeSelect.value;
            const department = departmentSelect.value;
            const officerInfo = officerInfoInput.value.trim(); // Common officer info
            const now = new Date();
            const localDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const localTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

            generatedReportTextarea.value = '';
            copyReportBtn.classList.add('hidden');
            downloadReportBtn.classList.add('hidden'); // Hide download button on new generation
            viewReportBtn.classList.add('hidden'); // Hide view button on new generation
            loadingIndicator.classList.remove('hidden');

            let prompt = '';
            let reportNarrative = ''; // Common variable for narrative across reports
            let requiredFieldsFilled = true; // Flag for validation

            // Prepare evidence string for prompt
            let evidenceForPrompt = '';
            const evidenceParts = [];
            for (const itemName in selectedEvidenceDetails) {
                const item = selectedEvidenceDetails[itemName];
                if (item.type === 'statement') {
                    if (item.text.trim() !== '') {
                        evidenceParts.push(`${itemName}: ${item.text.trim()}`);
                    } else {
                        evidenceParts.push(`${itemName}: No details provided.`);
                    }
                } else if (item.type === 'document' || item.type === 'video') {
                    if (item.links.length > 0) {
                        evidenceParts.push(`${itemName}: ${item.links.join(', ')}`);
                    } else {
                        evidenceParts.push(`${itemName}: No links provided.`);
                    }
                } else {
                    evidenceParts.push(itemName);
                }
            }
            evidenceForPrompt = evidenceParts.length > 0 ? evidenceParts.join('\n') : 'None';


            // Determine which API key to use
            const finalApiKey = typeof __api_key__ !== 'undefined' ? __api_key__ : apiKey;

            if (!finalApiKey) {
                generatedReportTextarea.value = 'Error: Gemini API Key is not configured. Please ensure your API key is correctly set in the JavaScript code. If running on your own server, replace the empty string for `apiKey` with your actual key.';
                console.error('API Key not configured. Please set your actual Gemini API key if running on your own server.');
                loadingIndicator.classList.add('hidden');
                return;
            }

            // Construct prompt based on report type
            switch (selectedReportType) {
                case 'Application':
                    const applicantName = applicantNameInput.value.trim();
                    const positionApplied = positionAppliedInput.value.trim();
                    const applicationDate = applicationDateInput.value.trim();
                    const applicationStatus = applicationStatusSelect.value;
                    reportNarrative = applicationNotesTextarea.value.trim();

                    if (!officerInfo || !applicantName || !positionApplied || !applicationDate || applicationStatus === "" || !reportNarrative) {
                        requiredFieldsFilled = false;
                    }

                    if (requiredFieldsFilled) {
                        prompt = `${localDate}, ${localTime} ${timeZone}

Reporting Staff: ${officerInfo}
Department: ${department}

Generate a detailed, professional, and concise Application Report. The report must strictly adhere to the information provided in the "Notes on Application" and other text fields. Do not include any information that is not directly deducible from the provided inputs. The output must strictly follow the format provided below, with no additional text, introductory phrases, or markdown formatting (like bold, italics, headers, or bullet points). Ensure all fields are populated appropriately based on the input. If a field is not directly deducible from the input, provide a reasonable placeholder or "N/A". The report should be written as if you were the staff member writing it. Make sure to include your name and ID. Explicitly mention the applicant's name in the report.

Applicant's Full Name: ${applicantName}
Position Applied For: ${positionApplied}
Application Date: ${applicationDate}
Application Status: ${applicationStatus}
Notes on Application: ${reportNarrative}
Supporting Documents/Evidence:
${evidenceForPrompt}

---
Strict Output Format:
APPLICATION REPORT

Reporting Staff: ${officerInfo}
Department: ${department}
Date of Report: ${localDate}
Time of Report: ${localTime} ${timeZone}

Applicant Information:
Name: ${applicantName}
Position Applied For: ${positionApplied}
Application Date: ${applicationDate}
Application Status: ${applicationStatus}

Application Notes: [Detailed summary of the application, explicitly mentioning the applicant's name: ${applicantName}, based on the notes provided.]

Supporting Documents/Evidence:
${evidenceForPrompt}
`;
                    }
                    break;

                case 'Interview':
                    const intervieweeName = intervieweeNameInput.value.trim();
                    const interviewDate = interviewDateInput.value.trim();
                    const interviewTime = interviewTimeInput.value.trim();
                    const interviewerNames = interviewerNamesInput.value.trim();
                    // interviewOutcome is now optional
                    const interviewOutcome = interviewOutcomeSelect.value;
                    const q1Experience = q1ExperienceTextarea.value.trim();
                    const q2Professionalism = q2ProfessionalismTextarea.value.trim();
                    const q3PersonalStrengths = q3PersonalStrengthsTextarea.value.trim();
                    const q4ReportCommitment = q4ReportCommitmentTextarea.value.trim();
                    const q5ConflictOfInterest = q5ConflictOfInterestTextarea.value.trim();
                    const q6FelonyStop = q6FelonyStopTextarea.value.trim();
                    const q7OfficerMisconduct = q7OfficerMisconductTextarea.value.trim();
                    const q8ConflictingOrders = q8ConflictingOrdersTextarea.value.trim();
                    const q9ComposureUnderPressure = q9ComposureUnderPressureTextarea.value.trim();
                    const q10OfficerExpectations = q10OfficerExpectationsTextarea.value.trim();
                    reportNarrative = interviewNotesTextarea.value.trim();

                    // Removed interviewOutcome === "" from required fields check
                    if (!officerInfo || !intervieweeName || !interviewDate || !interviewTime || !interviewerNames || !reportNarrative) {
                        requiredFieldsFilled = false;
                    }

                    if (requiredFieldsFilled) {
                        prompt = `${localDate}, ${localTime} ${timeZone}

Reporting Staff: ${officerInfo}
Department: ${department}

You are an AI assistant tasked with generating a detailed, professional, and concise Interview Report.
For each question, you must provide a score from 1 to 5 (1 = Poor, 2 = Fair, 3 = Good, 4 = Very Good, 5 = Excellent) based on the following metrics:
- Depth: How thoroughly the response addresses the question.
- Reasoning: The logical coherence and justification behind the response.
- Maturity: The level of professionalism, judgment, and emotional intelligence demonstrated.
- Problem Solving: The ability to analyze situations and propose effective solutions.
- Understanding of basic law enforcement skills: Demonstrated knowledge of fundamental police procedures, protocols, and legal principles.

The report must strictly adhere to the information provided in the "Interview Notes/Summary" and other text fields. Do not include any information that is not directly deducible from the provided inputs. The output must strictly follow the format provided below, with no additional text, introductory phrases, or markdown formatting (like bold, italics, headers, or bullet points), EXCEPT for the table for scoring. Ensure all fields are populated appropriately based on the input. If a field is not directly deducible from the input, provide a reasonable placeholder or "N/A". The report should be written as if you were the staff member writing it. Make sure to include your name and ID. Explicitly mention the interviewee's name in the report.

Interviewee's Full Name: ${intervieweeName}
Interview Date: ${interviewDate}
Interview Time: ${interviewTime}
Interviewer(s) Name(s): ${interviewerNames}
Interview Outcome: ${interviewOutcome || 'N/A'}

--- Interview Questions ---
Q1: Experience: ${q1Experience || 'N/A'}
Q2: Professionalism: ${q2Professionalism || 'N/A'}
Q3: Personal Strengths: ${q3PersonalStrengths || 'N/A'}
Q4: Report Commitment: ${q4ReportCommitment || 'N/A'}
Q5: Conflict of Interest: ${q5ConflictOfInterest || 'N/A'}
Q6: Felony Stop Scenario: ${q6FelonyStop || 'N/A'}
Q7: Officer Misconduct Scenario: ${q7OfficerMisconduct || 'N/A'}
Q8: Conflicting Orders Scenario: ${q8ConflictingOrders || 'N/A'}
Q9: Composure Under Pressure: ${q9ComposureUnderPressure || 'N/A'}
Q10: Officer Expectations: ${q10OfficerExpectations || 'N/A'}
--- End Interview Questions ---

Overall Interview Notes/Summary: ${reportNarrative}
Supporting Documents/Evidence:
${evidenceForPrompt}

---
Strict Output Format:
INTERVIEW REPORT

Reporting Staff: ${officerInfo}
Department: ${department}
Date of Report: ${localDate}
Time of Report: ${localTime} ${timeZone}

Interview Details:
Interviewee: ${intervieweeName}
Date: ${interviewDate}
Time: ${interviewTime}
Interviewer(s): ${interviewerNames}
Outcome: ${interviewOutcome || 'N/A'}

Interview Questions & Responses:
Q1: Experience: [Summary of applicant's response to Q1]
Q2: Professionalism: [Summary of applicant's response to Q2]
Q3: Personal Strengths: [Summary of applicant's response to Q3]
Q4: Report Commitment: [Summary of applicant's response to Q4]
Q5: Conflict of Interest: [Summary of applicant's response to Q5]
Q6: Felony Stop Scenario: [Summary of applicant's response to Q6]
Q7: Officer Misconduct Scenario: [Summary of applicant's response to Q7]
Q8: Conflicting Orders Scenario: [Summary of applicant's response to Q8]
Q9: Composure Under Pressure: [Summary of applicant's response to Q9]
Q10: Officer Expectations: [Summary of applicant's response to Q10]

Interview Question Scoring (1-5, 5 being excellent):
| Question | Depth | Reasoning | Maturity | Problem Solving | Understanding of basic law enforcement skills |
|---|---|---|---|---|---|
| Q1: Experience | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q2: Professionalism | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q3: Personal Strengths | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q4: Report Commitment | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q5: Conflict of Interest | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q6: Felony Stop Scenario | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q7: Officer Misconduct Scenario | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q8: Conflicting Orders Scenario | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q9: Composure Under Pressure | [Score] | [Score] | [Score] | [Score] | [Score] |
| Q10: Officer Expectations | [Score] | [Score] | [Score] | [Score] | [Score] |

Overall Interview Summary: [Detailed summary of the interview, explicitly mentioning the interviewee's name: ${intervieweeName}, based on the notes provided.]

Supporting Documents/Evidence:
${evidenceForPrompt}
`;
                    }
                    break;

                case 'Disciplinary':
                    const employeeName = employeeNameInput.value.trim();
                    const employeeID = employeeIDInput.value.trim();
                    const disciplinaryDate = disciplinaryDateInput.value.trim();
                    const disciplinaryReason = disciplinaryReasonTextarea.value.trim();
                    const actionTaken = actionTakenSelect.value;
                    reportNarrative = disciplinaryNotesTextarea.value.trim();

                    if (!officerInfo || !employeeName || !employeeID || !disciplinaryDate || !disciplinaryReason || actionTaken === "" || !reportNarrative) {
                        requiredFieldsFilled = false;
                    }

                    if (requiredFieldsFilled) {
                        prompt = `${localDate}, ${localTime} ${timeZone}

Reporting Staff: ${officerInfo}
Department: ${department}

Generate a detailed, professional, and concise Disciplinary Report. The report must strictly adhere to the information provided in the "Disciplinary Notes" and other text fields. Do not include any information that is not directly deducible from the provided inputs. The output must strictly follow the format provided below, with no additional text, introductory phrases, or markdown formatting (like bold, italics, headers, or bullet points). Ensure all fields are populated appropriately based on the input. If a field is not directly deducible from the input, provide a reasonable placeholder or "N/A". The report should be written as if you were the staff member writing it. Make sure to include your name and ID. Explicitly mention the employee's name in the report.

Employee's Full Name: ${employeeName}
Employee ID: ${employeeID}
Date of Incident: ${disciplinaryDate}
Reason for Disciplinary Action: ${disciplinaryReason}
Action Taken: ${actionTaken}
Disciplinary Notes: ${reportNarrative}
Supporting Documents/Evidence:
${evidenceForPrompt}

---
Strict Output Format:
DISCIPLINARY REPORT

Reporting Staff: ${officerInfo}
Department: ${department}
Date of Report: ${localDate}
Time of Report: ${localTime} ${timeZone}

Employee Information:
Name: ${employeeName}
Employee ID: ${employeeID}

Disciplinary Details:
Date of Incident: ${disciplinaryDate}
Reason: ${disciplinaryReason}
Action Taken: ${actionTaken}

Notes: [Detailed notes on the disciplinary action, explicitly mentioning the employee's name: ${employeeName}, based on the notes provided.]

Supporting Documents/Evidence:
${evidenceForPrompt}
`;
                    }
                    break;

                case 'Meeting':
                    const meetingTitle = meetingTitleInput.value.trim();
                    const meetingDate = meetingDateInput.value.trim();
                    const meetingTime = meetingTimeInput.value.trim();
                    const attendees = attendeesTextarea.value.trim();
                    const discussionPoints = discussionPointsTextarea.value.trim();
                    const actionItems = actionItemsTextarea.value.trim();
                    reportNarrative = discussionPoints; // Using discussion points as the primary narrative

                    if (!officerInfo || !meetingTitle || !meetingDate || !meetingTime || !attendees || !discussionPoints || !actionItems) {
                        requiredFieldsFilled = false;
                    }

                    if (requiredFieldsFilled) {
                        prompt = `${localDate}, ${localTime} ${timeZone}

Reporting Staff: ${officerInfo}
Department: ${department}

Generate detailed, professional, and concise Meeting Minutes. The minutes must strictly adhere to the information provided in the "Key Discussion Points" and "Action Items/Decisions" fields. Do not include any information that is not directly deducible from the provided inputs. The output must strictly follow the format provided below, with no additional text, introductory phrases, or markdown formatting (like bold, italics, headers, or bullet points). Ensure all fields are populated appropriately based on the input. If a field is not directly deducible from the input, provide a reasonable placeholder or "N/A". The report should be written as if you were the staff member taking the minutes. Make sure to include your name and ID. Explicitly mention the meeting title and attendees.

Meeting Title/Subject: ${meetingTitle}
Meeting Date: ${meetingDate}
Meeting Time: ${meetingTime}
Attendees (Names/Roles): ${attendees}
Key Discussion Points: ${discussionPoints}
Action Items/Decisions: ${actionItems}
Supporting Documents/Evidence:
${evidenceForPrompt}

---
Strict Output Format:
MEETING MINUTES

Recorded By: ${officerInfo}
Department: ${department}
Date of Minutes: ${localDate}
Time of Minutes: ${localTime} ${timeZone}

Meeting Title: ${meetingTitle}
Date: ${meetingDate}
Time: ${meetingTime}
Attendees:
${attendees}

Key Discussion Points: [Detailed summary of the discussion points, based on the input provided.]

Action Items/Decisions: [Detailed list of action items and decisions, including responsible parties and deadlines, based on the input provided.]

Supporting Documents/Evidence:
${evidenceForPrompt}
`;
                    }
                    break;

                default:
                    generatedReportTextarea.value = 'Invalid report type selected.';
                    loadingIndicator.classList.add('hidden');
                    return;
            }

            if (!requiredFieldsFilled) {
                generatedReportTextarea.value = 'Please fill in all required fields for the selected report type to generate the report.';
                loadingIndicator.classList.add('hidden');
                downloadReportBtn.classList.add('hidden');
                viewReportBtn.classList.add('hidden');
                return;
            }

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${finalApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    generatedReportTextarea.value = `Error: API call failed with status ${response.status}. Details: ${errorBody}`;
                    console.error('API Error Response:', response.status, errorBody);
                    loadingIndicator.classList.add('hidden');
                    downloadReportBtn.classList.add('hidden');
                    viewReportBtn.classList.add('hidden');
                    return;
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let generatedText = result.candidates[0].content.parts[0].text;
                    generatedText = generatedText.replace(/[<>]/g, '').trim();
                    generatedReportTextarea.value = generatedText;
                    copyReportBtn.classList.remove('hidden');
                    downloadReportBtn.classList.remove('hidden');
                    viewReportBtn.classList.remove('hidden');
                } else {
                    generatedReportTextarea.value = 'Failed to generate report. Gemini API returned an unexpected structure or no content.';
                    console.error('Gemini API returned an unexpected structure or no content:', result);
                    copyReportBtn.classList.add('hidden');
                    downloadReportBtn.classList.add('hidden');
                    viewReportBtn.classList.add('hidden');
                }
            } catch (error) {
                generatedReportTextarea.value = `An error occurred: ${error.message}. Please check your network connection and try again.`;
                console.error('Error during API call or processing:', error);
                copyReportBtn.classList.add('hidden');
                downloadReportBtn.classList.add('hidden');
                viewReportBtn.classList.add('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // Add event listener for the Copy Report button
        copyReportBtn.addEventListener('click', () => {
            let textToCopy = generatedReportTextarea.value.trim().replace(/[<>]/g, '');

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);

            tempTextArea.select();
            document.execCommand('copy');

            const originalText = copyReportBtn.textContent;
            copyReportBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyReportBtn.textContent = originalText;
            }, 1500);
        });

        // Function to generate PDF content (reused for both download and view)
        const generatePdfContent = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const department = departmentSelect.value;
            const officerInfo = officerInfoInput.value.trim();
            const generatedReportText = generatedReportTextarea.value.trim();
            const now = new Date();
            const reportDate = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const currentYear = now.getFullYear();
            const currentMonth = now.toLocaleString('en-US', { month: 'long' });
            const currentDay = now.getDate();
            const selectedReportType = reportTypeSelect.value;

            // Function to load image as base64
            const getImageBase64 = (url) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous'; // Required for CORS if image is from another domain
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/png')); // Convert to PNG for transparency
                    };
                    img.onerror = (error) => reject(error);
                    img.src = url;
                });
            };

            let lspdLogoBase64 = '';
            try {
                // Use the onerror fallback URL for LSPD.png if the direct path fails
                const imgElement = document.querySelector('img[alt="LSPD Logo"]');
                const logoUrl = imgElement.src || 'https://raw.githubusercontent.com/Tony-Dunkle/Nightlife-lspd/740c11da2aa53715804bfc13b8e3cc3762a3274d/LSPD.png';
                lspdLogoBase64 = await getImageBase64(logoUrl);
            } catch (error) {
                console.error('Error loading LSPD logo for PDF:', error);
                // Optionally, you can add a placeholder text or simply skip the image if it fails to load
            }


            // Set font and size for the main title
            doc.setFontSize(16);
            doc.text(`${department} ${selectedReportType} Report`, 20, 20);

            // Add LSPD logo if available
            if (lspdLogoBase64) {
                doc.addImage(lspdLogoBase64, 'PNG', 170, 10, 25, 25); // Adjust position and size as needed
            }

            // Case Number and Date
            doc.setFontSize(10);
            doc.text(`Report ID: ${Math.floor(Math.random() * 1000000)}`, 20, 40); // Placeholder ID
            doc.text(`Date: ${reportDate}`, 150, 40);

            // Add a line separator
            doc.line(20, 45, 190, 45); // x1, y1, x2, y2

            let currentY = 55; // Starting Y position for the report text

            // Handle Interview Report PDF generation specifically for questions and scoring
            if (selectedReportType === 'Interview') {
                const intervieweeName = intervieweeNameInput.value.trim();
                const interviewDate = interviewDateInput.value.trim();
                const interviewTime = interviewTimeInput.value.trim();
                const interviewerNames = interviewerNamesInput.value.trim();
                const interviewOutcome = interviewOutcomeSelect.value;
                const interviewNotes = interviewNotesTextarea.value.trim();

                doc.setFontSize(12);
                doc.text('Interview Details:', 20, currentY);
                currentY += 7;
                doc.setFontSize(10);
                doc.text(`Interviewee: ${intervieweeName}`, 20, currentY);
                currentY += 5;
                doc.text(`Date: ${interviewDate}`, 20, currentY);
                currentY += 5;
                doc.text(`Time: ${interviewTime}`, 20, currentY);
                currentY += 5;
                doc.text(`Interviewer(s): ${interviewerNames}`, 20, currentY);
                currentY += 5;
                doc.text(`Outcome: ${interviewOutcome || 'N/A'}`, 20, currentY); // Use N/A if not selected
                currentY += 10;

                doc.setFontSize(12);
                doc.text('Interview Questions & Responses:', 20, currentY);
                currentY += 7;
                doc.setFontSize(10);

                const questions = [
                    { q: "Q1: Experience", a: q1ExperienceTextarea.value.trim() },
                    { q: "Q2: Professionalism", a: q2ProfessionalismTextarea.value.trim() },
                    { q: "Q3: Personal Strengths", a: q3PersonalStrengthsTextarea.value.trim() },
                    { q: "Q4: Report Commitment", a: q4ReportCommitmentTextarea.value.trim() },
                    { q: "Q5: Conflict of Interest", a: q5ConflictOfInterestTextarea.value.trim() },
                    { q: "Q6: Felony Stop Scenario", a: q6FelonyStopTextarea.value.trim() },
                    { q: "Q7: Officer Misconduct Scenario", a: q7OfficerMisconductTextarea.value.trim() },
                    { q: "Q8: Conflicting Orders Scenario", a: q8ConflictingOrdersTextarea.value.trim() },
                    { q: "Q9: Composure Under Pressure", a: q9ComposureUnderPressureTextarea.value.trim() },
                    { q: "Q10: Officer Expectations", a: q10OfficerExpectationsTextarea.value.trim() },
                ];

                questions.forEach(item => {
                    const questionText = doc.splitTextToSize(`${item.q}:`, 170);
                    const answerText = doc.splitTextToSize(`Response: ${item.a || 'N/A'}`, 170);

                    doc.text(questionText, 20, currentY);
                    currentY += (questionText.length * doc.internal.getLineHeight());
                    doc.text(answerText, 25, currentY); // Indent response
                    currentY += (answerText.length * doc.internal.getLineHeight()) + 5; // Add space after each Q&A
                    if (currentY > 280) { // Check for page break
                        doc.addPage();
                        currentY = 20;
                    }
                });

                currentY += 10; // Add some space before the scoring table
                doc.setFontSize(12);
                doc.text('Interview Question Scoring (1-5, 5 being excellent):', 20, currentY);
                currentY += 7;

                // Extract scoring from the generated report text
                const scoringStartIndex = generatedReportText.indexOf('Interview Question Scoring (1-5, 5 being excellent):');
                if (scoringStartIndex !== -1) {
                    const scoringTableText = generatedReportText.substring(scoringStartIndex);
                    const lines = scoringTableText.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                    if (lines.length > 2) { // Check if there are header and at least one data row
                        const headers = lines[1].split('|').map(h => h.trim()).filter(h => h.length > 0);
                        const tableData = [];
                        for (let i = 3; i < lines.length; i++) { // Start from the first data row
                            if (lines[i].startsWith('| Q')) { // Only process lines that start with '| Q'
                                const row = lines[i].split('|').map(cell => cell.trim()).filter(cell => cell.length > 0);
                                if (row.length === headers.length) {
                                    tableData.push(row);
                                }
                            } else {
                                // Stop processing if the line is not a table row
                                break;
                            }
                        }

                        if (tableData.length > 0) {
                            doc.autoTable({
                                startY: currentY,
                                head: [headers],
                                body: tableData,
                                theme: 'grid',
                                styles: {
                                    fontSize: 8,
                                    cellPadding: 2,
                                    valign: 'middle',
                                    halign: 'center'
                                },
                                headStyles: {
                                    fillColor: [46, 116, 181], // A shade of blue
                                    textColor: [255, 255, 255],
                                    fontStyle: 'bold'
                                },
                                alternateRowStyles: {
                                    fillColor: [240, 248, 255] // Light blue for alternate rows
                                },
                                columnStyles: {
                                    0: { halign: 'left' } // Align question text to left
                                },
                                didDrawPage: function (data) {
                                    currentY = data.cursor.y; // Update currentY after table
                                }
                            });
                            currentY = doc.autoTable.previous.finalY + 10; // Update currentY based on table's final Y position
                        }
                    }
                }

                doc.setFontSize(12);
                doc.text('Overall Interview Summary:', 20, currentY);
                currentY += 7;
                doc.setFontSize(10);
                const summaryText = generatedReportText.substring(
                    generatedReportText.indexOf('Overall Interview Summary:') + 'Overall Interview Summary:'.length
                ).split('Supporting Documents/Evidence:')[0].trim();
                const splitSummary = doc.splitTextToSize(summaryText, 170);
                doc.text(splitSummary, 20, currentY);
                currentY += (splitSummary.length * doc.internal.getLineHeight()) + 10;

                doc.setFontSize(12);
                doc.text('Supporting Documents/Evidence:', 20, currentY);
                currentY += 7;
                doc.setFontSize(10);
                const evidenceText = generatedReportText.substring(
                    generatedReportText.indexOf('Supporting Documents/Evidence:') + 'Supporting Documents/Evidence:'.length
                ).trim();
                const splitEvidence = doc.splitTextToSize(evidenceText, 170);
                doc.text(splitEvidence, 20, currentY);
                currentY += (splitEvidence.length * doc.internal.getLineHeight()) + 10;


            } else {
                // For other report types, just add the generated text as before
                const splitText = doc.splitTextToSize(generatedReportText, 170); // Max width 170mm
                doc.text(splitText, 20, currentY);
                currentY += (splitText.length * doc.internal.getLineHeight());
            }

            // Add a line separator before footer
            doc.line(20, currentY + 10, 190, currentY + 10);

            // Footer information
            currentY += 20;
            doc.text(`Reporting Staff: ${officerInfo}`, 20, currentY);
            currentY += 7;
            doc.text(`Date: ${currentMonth} ${currentDay}, ${currentYear}`, 20, currentY);
            currentY += 7;
            doc.text(`Reviewed By: _____________________________________`, 20, currentY);
            currentY += 7;
            doc.text(`Approval: _____________________________________`, 20, currentY);

            return doc; // Return the jsPDF document object
        };

        // Event listener for the Download Report button
        downloadReportBtn.addEventListener('click', async () => {
            const doc = await generatePdfContent();
            const department = departmentSelect.value;
            const selectedReportType = reportTypeSelect.value;
            const now = new Date();
            const reportDate = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
            doc.save(`${department.replace(/\s/g, '_')}_${selectedReportType.replace(/\s/g, '_')}_Report_${reportDate}.pdf`);
        });

        // NEW: Event listener for the View Report button
        viewReportBtn.addEventListener('click', async () => {
            const doc = await generatePdfContent();
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
        });

        // --- Theme Switching Logic ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
                if (darkModeRadio) darkModeRadio.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                if (lightModeRadio) lightModeRadio.checked = true;
            }
            localStorage.setItem('theme', theme);
        };

        // --- Settings Modal Logic ---
        if (settingsIcon) {
            settingsIcon.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
                // Ensure correct radio button is checked when opening modal
                const currentTheme = localStorage.getItem('theme') || 'light';
                if (currentTheme === 'dark') {
                    if (darkModeRadio) darkModeRadio.checked = true;
                } else {
                    if (lightModeRadio) lightModeRadio.checked = true;
                }
            });
        }

        if (closeSettingsModalBtn) {
            closeSettingsModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
        }

        if (settingsModal) {
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });
        }

        if (lightModeRadio) {
            lightModeRadio.addEventListener('change', () => applyTheme('light'));
        }
        if (darkModeRadio) {
            darkModeRadio.addEventListener('change', () => applyTheme('dark'));
        }

        // --- Clear All Data Logic ---
        if (clearAllDataBtn) {
            clearAllDataBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden'); // Hide settings modal first
                confirmDeleteModal.classList.remove('hidden'); // Show confirmation modal
            });
        }

        if (confirmDeleteYesBtn) {
            confirmDeleteYesBtn.addEventListener('click', () => {
                localStorage.clear(); // Clears all data from local storage for this domain
                console.log('All website data cleared from local storage.');
                confirmDeleteModal.classList.add('hidden');
                location.reload(); // Reload the page to reflect changes
            });
        }

        if (confirmDeleteNoBtn) {
            confirmDeleteNoBtn.addEventListener('click', () => {
                confirmDeleteModal.classList.add('hidden');
                settingsModal.classList.remove('hidden'); // Show settings modal again
            });
        }

        if (confirmDeleteModal) {
            confirmDeleteModal.addEventListener('click', (e) => {
                if (e.target === confirmDeleteModal) {
                    confirmDeleteModal.classList.add('hidden');
                    settingsModal.classList.remove('hidden'); // Show settings modal again
                }
            });
        }


        // --- Data Viewer Logic ---
        if (viewDataBtn) {
            viewDataBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden'); // Hide settings modal
                dataViewerModal.classList.remove('hidden');
                displayLocalStorageData();
            });
        }

        if (closeDataViewerModalBtn) {
            closeDataViewerModalBtn.addEventListener('click', () => {
                dataViewerModal.classList.add('hidden');
                settingsModal.classList.remove('hidden'); // Show settings modal again
            });
        }

        if (dataViewerModal) {
            dataViewerModal.addEventListener('click', (e) => {
                if (e.target === dataViewerModal) {
                    dataViewerModal.classList.add('hidden');
                    settingsModal.classList.remove('hidden'); // Show settings modal again
                }
            });
        }

        function displayLocalStorageData() {
            dataViewerContent.innerHTML = ''; // Clear existing content

            let hasData = false;

            // Display Logged In Officer
            const loggedInOfficer = localStorage.getItem('loggedInOfficer');
            if (loggedInOfficer) {
                try {
                    const officer = JSON.parse(loggedInOfficer);
                    const officerDiv = document.createElement('div');
                    officerDiv.className = 'data-viewer-item';
                    officerDiv.innerHTML = `
                                <p class="title">Officer Logged In</p>
                                <p class="description">${officer.name} (Badge: ${officer.badge})</p>
                            `;
                    dataViewerContent.appendChild(officerDiv);
                    hasData = true;
                } catch (e) {
                    console.error("Error parsing loggedInOfficer from local storage:", e);
                }
            }

            // Display Website Theme
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme) {
                const themeDiv = document.createElement('div');
                themeDiv.className = 'data-viewer-item';
                themeDiv.innerHTML = `
                            <p class="title">Website Theme</p>
                            <p class="description">${currentTheme.charAt(0).toUpperCase() + currentTheme.slice(1)} Mode</p>
                        `;
                dataViewerContent.appendChild(themeDiv);
                hasData = true;
            }

            // Display Admin Report Generator Data
            const adminReportData = localStorage.getItem('adminReportGeneratorData');
            if (adminReportData) {
                try {
                    const data = JSON.parse(adminReportData);
                    const adminReportDiv = document.createElement('div');
                    adminReportDiv.className = 'data-viewer-item mt-4';
                    adminReportDiv.innerHTML = `
                                <p class="title">Administrative Report Generator Data</p>
                                <p class="description">Last saved report type: ${data.reportType || 'N/A'}</p>
                                <p class="description">Last saved officer info: ${data.officerInfo || 'N/A'}</p>
                                <p class="description">Other form fields saved. (Too detailed to list all here)</p>
                            `;
                    dataViewerContent.appendChild(adminReportDiv);
                    hasData = true;
                } catch (e) {
                    console.error("Error parsing adminReportGeneratorData from local storage:", e);
                }
            }


            // Display Other Stored Data
            let otherDataCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Skip keys already displayed or internal keys
                if (key === 'loggedInOfficer' || key === 'theme' || key === 'adminReportGeneratorData' || key === 'cookieConsent') {
                    continue;
                }

                let value;
                try {
                    // Try to parse as JSON, otherwise keep as string
                    value = JSON.parse(localStorage.getItem(key));
                    // If it's an object/array, stringify it nicely
                    if (typeof value === 'object' && value !== null) {
                        value = JSON.stringify(value, null, 2);
                    }
                } catch (e) {
                    value = localStorage.getItem(key);
                }

                if (otherDataCount === 0) {
                    const otherDataHeader = document.createElement('div');
                    otherDataHeader.className = 'data-viewer-item mt-4';
                    otherDataHeader.innerHTML = `<p class="title">Other Stored Data</p>`;
                    dataViewerContent.appendChild(otherDataHeader);
                }

                const dataDiv = document.createElement('div');
                dataDiv.className = 'data-viewer-item';
                dataDiv.innerHTML = `
                            <p class="title">${key}</p>
                            <p class="description">${value}</p>
                        `;
                dataViewerContent.appendChild(dataDiv);
                hasData = true;
                otherDataCount++;
            }

            if (!hasData) {
                dataViewerContent.innerHTML = '<p class="text-gray-500 text-center py-4">No user-specific data currently stored in local storage.</p>';
            }
        }
    </script>
</body>
</html>
